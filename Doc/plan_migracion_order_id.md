# Plan de Migraci√≥n T√©cnica: Identificador de Pedido Unificado (#A000001)

Este documento describe los pasos t√©cnicos precisos para migrar el sistema de identificadores UUID a un sistema secuencial formateado (ej. `#A000001`).

## üìã Cambios Principales

- **Nueva columna:** `orders.order_number` (BIGINT, secuencial, NOT NULL, UNIQUE)
- **Formato display:** `#A000001` (6 d√≠gitos con ceros a la izquierda)
- **Formato facturas:** `FV-A000001` (sin a√±o, secuencial global)
- **B√∫squedas:** Por n√∫mero secuencial o email/nombre de cliente
- **Stripe metadata:** Incluye `order_slug` con formato `#A000001`

## 1. Base de Datos (Supabase)

### 1.1 Nueva Columna y Migraci√≥n de Datos

Crear una migraci√≥n SQL en `Doc/migrations/026_add_order_number_polished.sql`:

```sql
-- ============================================
-- MIGRACI√ìN 026: Sistema de Numeraci√≥n Secuencial de Pedidos
-- Fecha: 2026-01-15
-- ============================================

BEGIN;

-- 1. A√±adir columna identity (autocremental segura)
ALTER TABLE orders
ADD COLUMN order_number BIGINT GENERATED BY DEFAULT AS IDENTITY;

-- 2. Crear √≠ndice CONCURRENTLY para b√∫squedas r√°pidas
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_order_number ON orders(order_number);

-- 3. Asignar n√∫meros a pedidos hist√≥ricos ordenados por fecha
-- Esto asegura que los pedidos antiguos tengan n√∫meros bajos (1, 2, 3...)
DO $$
DECLARE
  affected_rows INT;
BEGIN
  WITH sorted_orders AS (
    SELECT id, ROW_NUMBER() OVER (ORDER BY created_at ASC) as rn
    FROM orders
    WHERE order_number IS NULL -- Solo actualizar nulls
  )
  UPDATE orders
  SET order_number = sorted_orders.rn
  FROM sorted_orders
  WHERE orders.id = sorted_orders.id;
  
  GET DIAGNOSTICS affected_rows = ROW_COUNT;
  RAISE NOTICE 'Updated % historical orders with sequential numbers', affected_rows;
END $$;

-- 4. Sincronizar la secuencia con el m√°ximo valor actual
SELECT setval('orders_order_number_seq', (SELECT COALESCE(MAX(order_number), 0) FROM orders));

-- 5. Hacer la columna obligatoria (despu√©s de migrar datos hist√≥ricos)
ALTER TABLE orders ALTER COLUMN order_number SET NOT NULL;

-- 6. Constraint de unicidad (cr√≠tico para evitar duplicados)
ALTER TABLE orders ADD CONSTRAINT orders_order_number_unique UNIQUE (order_number);

COMMIT;

-- Verificaci√≥n
DO $$
DECLARE
  total_orders INT;
  orders_with_number INT;
BEGIN
  SELECT COUNT(*) INTO total_orders FROM orders;
  SELECT COUNT(*) INTO orders_with_number FROM orders WHERE order_number IS NOT NULL;
  
  RAISE NOTICE '=== VERIFICACI√ìN DE MIGRACI√ìN ===';
  RAISE NOTICE 'Total de pedidos: %', total_orders;
  RAISE NOTICE 'Pedidos con n√∫mero: %', orders_with_number;
  RAISE NOTICE 'Pr√≥ximo n√∫mero: %', nextval('orders_order_number_seq');
  
  -- Revertir el nextval de prueba
  PERFORM setval('orders_order_number_seq', (SELECT MAX(order_number) FROM orders));
END $$;
```

### 1.2 Script de Rollback (Seguridad)

Crear `Doc/migrations/rollback_026.sql`:

```sql
-- ============================================
-- ROLLBACK MIGRACI√ìN 026
-- USAR SOLO EN CASO DE EMERGENCIA
-- ============================================

BEGIN;

-- 1. Eliminar constraint de unicidad
ALTER TABLE orders DROP CONSTRAINT IF EXISTS orders_order_number_unique;

-- 2. Hacer la columna nullable
ALTER TABLE orders ALTER COLUMN order_number DROP NOT NULL;

-- 3. Eliminar √≠ndice
DROP INDEX CONCURRENTLY IF EXISTS idx_orders_order_number;

-- 4. Eliminar columna
ALTER TABLE orders DROP COLUMN IF EXISTS order_number;

-- 5. La secuencia se elimina autom√°ticamente
-- DROP SEQUENCE IF EXISTS orders_order_number_seq;

COMMIT;

RAISE NOTICE 'Rollback completado. Sistema vuelto a UUID √∫nico.';
```

### 1.3 Modificar RPC `create_checkout_order`

**Problema actual:** La funci√≥n solo retorna el UUID, necesitamos tambi√©n el `order_number`.

**Soluci√≥n:** Modificar para retornar JSON con ambos valores.

```sql
-- Actualizar firma de la funci√≥n para retornar JSON
CREATE OR REPLACE FUNCTION create_checkout_order(
  p_customer_name TEXT,
  p_customer_email TEXT,
  p_customer_phone TEXT,
  p_shipping_address TEXT,
  p_shipping_city TEXT,
  p_shipping_postal_code TEXT,
  p_shipping_country TEXT,
  p_total_amount NUMERIC,
  p_stripe_session_id TEXT,
  p_items JSONB
) RETURNS JSON AS $$
DECLARE
  v_order_id UUID;
  v_order_number BIGINT;
  v_item JSONB;
BEGIN
  -- Crear el pedido
  INSERT INTO orders (
    customer_name, customer_email, customer_phone,
    shipping_address, shipping_city, shipping_postal_code, shipping_country,
    total_amount, stripe_session_id, status
  ) VALUES (
    p_customer_name, p_customer_email, p_customer_phone,
    p_shipping_address, p_shipping_city, p_shipping_postal_code, p_shipping_country,
    p_total_amount, p_stripe_session_id, 'pending'
  ) RETURNING id, order_number INTO v_order_id, v_order_number;

  -- Insertar items del pedido
  FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
  LOOP
    INSERT INTO order_items (order_id, product_id, variant_id, quantity, price_at_purchase)
    VALUES (
      v_order_id,
      (v_item->>'product_id')::UUID,
      (v_item->>'variant_id')::UUID,
      (v_item->>'quantity')::INTEGER,
      (v_item->>'price_at_purchase')::NUMERIC
    );
  END LOOP;

  -- Retornar JSON con ambos identificadores
  RETURN json_build_object(
    'order_id', v_order_id,
    'order_number', v_order_number
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 2. Utilidad Core (Frontend & Backend)

### 2.1 Nueva funci√≥n `formatOrderId`

Crear `src/lib/order-utils.ts`:

```typescript
/**
 * Formatea un n√∫mero secuencial de pedido en el formato est√°ndar #A000001
 * @param orderNumber El n√∫mero entero de la secuencia (ej. 1, 50, 999)
 * @returns Formato #A000001 o #PENDIENTE si es inv√°lido
 */
export const formatOrderId = (orderNumber: number | null | undefined): string => {
  // Validaci√≥n estricta
  if (orderNumber == null || orderNumber <= 0 || !Number.isInteger(orderNumber)) {
    console.warn('Invalid order number:', orderNumber);
    return "#PENDIENTE";
  }
  
  // Verificar l√≠mite de display (6 d√≠gitos m√°ximo)
  if (orderNumber > 999999) {
    console.error(`Order number ${orderNumber} exceeds max display limit (999999)`);
    throw new Error('Order number exceeds display limit');
  }
  
  // Formatear con padding de 6 d√≠gitos
  const paddedNumber = orderNumber.toString().padStart(6, "0");
  return `#A${paddedNumber}`;
};

/**
 * Parsea un ID formateado de vuelta a n√∫mero (√∫til para b√∫squedas)
 * @param input Formato: "#A000001", "A5", "5", etc.
 * @returns N√∫mero entero o null si es inv√°lido
 * @example
 * parseOrderId("#A000001") // 1
 * parseOrderId("A5") // 5
 * parseOrderId("invalid") // null
 */
export const parseOrderId = (input: string): number | null => {
  if (!input || typeof input !== 'string') return null;
  
  // Eliminar todo excepto n√∫meros
  const clean = input.replace(/[^0-9]/g, "");
  if (!clean) return null;
  
  const num = parseInt(clean, 10);
  
  // Validar rango
  return (num > 0 && num <= 999999) ? num : null;
};

/**
 * Verifica si un string tiene formato de order ID
 * @param input String a verificar
 * @returns true si parece un order ID (#A000001, A5, etc.)
 */
export const isOrderIdFormat = (input: string): boolean => {
  if (!input || typeof input !== 'string') return false;
  return /^#?A?\d{1,6}$/i.test(input.trim());
};

/**
 * Formatea n√∫mero de factura basado en order_number
 * @param orderNumber N√∫mero secuencial del pedido
 * @returns Formato FV-A000001
 */
export const formatInvoiceNumber = (orderNumber: number): string => {
  const formattedId = formatOrderId(orderNumber);
  // Remover el # y mantener A000001
  return `FV-${formattedId.substring(1)}`;
};
```

### 2.2 Tests Unitarios

Crear `src/lib/order-utils.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import { formatOrderId, parseOrderId, isOrderIdFormat, formatInvoiceNumber } from './order-utils';

describe('formatOrderId', () => {
  it('should format valid numbers correctly', () => {
    expect(formatOrderId(1)).toBe('#A000001');
    expect(formatOrderId(50)).toBe('#A000050');
    expect(formatOrderId(999)).toBe('#A000999');
    expect(formatOrderId(999999)).toBe('#A999999');
  });

  it('should handle invalid inputs', () => {
    expect(formatOrderId(0)).toBe('#PENDIENTE');
    expect(formatOrderId(-5)).toBe('#PENDIENTE');
    expect(formatOrderId(null)).toBe('#PENDIENTE');
    expect(formatOrderId(undefined)).toBe('#PENDIENTE');
  });

  it('should throw on numbers exceeding limit', () => {
    expect(() => formatOrderId(1000000)).toThrow('exceeds display limit');
  });
});

describe('parseOrderId', () => {
  it('should parse formatted IDs', () => {
    expect(parseOrderId('#A000001')).toBe(1);
    expect(parseOrderId('A000050')).toBe(50);
    expect(parseOrderId('5')).toBe(5);
  });

  it('should return null for invalid inputs', () => {
    expect(parseOrderId('invalid')).toBe(null);
    expect(parseOrderId('')).toBe(null);
    expect(parseOrderId('ABC')).toBe(null);
  });
});

describe('isOrderIdFormat', () => {
  it('should detect valid formats', () => {
    expect(isOrderIdFormat('#A000001')).toBe(true);
    expect(isOrderIdFormat('A5')).toBe(true);
    expect(isOrderIdFormat('123')).toBe(true);
  });

  it('should reject invalid formats', () => {
    expect(isOrderIdFormat('invalid')).toBe(false);
    expect(isOrderIdFormat('')).toBe(false);
  });
});
```

## 3. Implementaci√≥n Backend (APIs)

### 3.1 Creaci√≥n de Pedido y Stripe (`src/pages/api/checkout/create-session.ts`)

**Objetivo:** Asegurar que Stripe tenga el nuevo ID en sus metadatos y obtener el `order_number` correctamente.

**Cambios necesarios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar llamada al RPC (ahora retorna JSON):**
   ```typescript
   // Antes: const { data: orderId, error: orderError } = ...
   // Ahora:
   const { data: orderResult, error: orderError } = await supabase.rpc('create_checkout_order', {
     p_customer_name: customerName,
     p_customer_email: customerEmail,
     p_customer_phone: customerPhone || null,
     p_shipping_address: shippingAddress,
     p_shipping_city: shippingCity,
     p_shipping_postal_code: shippingPostalCode,
     p_shipping_country: 'Espa√±a',
     p_total_amount: totalCents / 100,
     p_stripe_session_id: null,
     p_items: orderItemsData
   });

   if (orderError || !orderResult) {
     // ... rollback stock ...
   }

   // Extraer ambos valores del JSON retornado
   const orderId = orderResult.order_id;
   const orderNumber = orderResult.order_number;
   const formattedOrderId = formatOrderId(orderNumber);
   
   console.log(`Order created: UUID=${orderId}, Number=${orderNumber}, Formatted=${formattedOrderId}`);
   ```

3. **Actualizar metadata de Stripe:**
   ```typescript
   const sessionConfig: any = {
     mode: 'payment',
     line_items: lineItems,
     success_url: `${url.origin}/checkout/exito?session_id={CHECKOUT_SESSION_ID}`,
     cancel_url: `${url.origin}/checkout/cancelado?order_id=${orderId}`,
     expires_at: expiresAt,
     customer_email: customerEmail,
     metadata: {
       order_id: orderId,              // UUID interno
       order_number: orderNumber,      // N√∫mero secuencial
       order_slug: formattedOrderId,   // #A000001 (Visible en Dashboard)
       coupon_id: validatedCoupon?.id || ''
     },
     locale: 'es',
     billing_address_collection: 'auto'
   };
   ```

### 3.2 Generaci√≥n de Facturas (`src/pages/api/invoices/request.ts`)

**Objetivo:** Que el n√∫mero de factura y el contenido del PDF usen el nuevo formato.

**Cambios necesarios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId, formatInvoiceNumber } from '@/lib/order-utils';
   ```

2. **Actualizar query para incluir `order_number`:**
   ```typescript
   const { data: order, error: orderError } = await supabase
     .from('orders')
     .select('id, order_number, customer_email, total_amount, created_at, status')
     .eq('id', orderId)
     .eq('customer_email', user.email)
     .in('status', ['paid', 'shipped', 'delivered'])
     .single();
   ```

3. **Usar nuevo formato en la generaci√≥n de factura:**
   ```typescript
   // En la llamada a create_invoice RPC o en la generaci√≥n del PDF
   const formattedOrderId = formatOrderId(order.order_number);
   const invoiceNumber = formatInvoiceNumber(order.order_number); // FV-A000001
   
   // Pasar al generador de PDF
   const pdfBuffer = await generateInvoicePDF({
     orderId: formattedOrderId,  // #A000001
     invoiceNumber: invoiceNumber, // FV-A000001
     // ... resto de datos
   });
   ```

### 3.3 Emails (`src/lib/email.ts`)

**Objetivo:** Unificar asuntos de correo con el nuevo formato.

**Cambios necesarios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar interfaz `OrderEmailData`:**
   ```typescript
   export interface OrderEmailData {
     orderId: string;       // UUID (mantener para compatibilidad)
     orderNumber: number;   // ‚ö†Ô∏è NUEVO: N√∫mero secuencial
     customerName: string;
     customerEmail: string;
     shippingAddress: string;
     shippingCity: string;
     shippingPostalCode: string;
     shippingCountry: string;
     totalAmount: number;
     items: {
       productName: string;
       size: string;
       quantity: number;
       price: number;
     }[];
     orderDate?: Date;
   }
   ```

3. **Actualizar funci√≥n `sendOrderConfirmation`:**
   ```typescript
   export async function sendOrderConfirmation(order: OrderEmailData): Promise<{ success: boolean; error?: string }> {
     if (!resend) {
       console.warn('Resend not configured - skipping order confirmation email');
       return { success: false, error: 'Email service not configured' };
     }

     try {
       const fromEmail = import.meta.env.RESEND_FROM_EMAIL || 'FashionStore <onboarding@resend.dev>';
       
       // Formatear ID para display
       const formattedOrderId = formatOrderId(order.orderNumber);
       
       // Generar ticket PDF con el n√∫mero formateado
       let ticketBuffer: Buffer | null = null;
       try {
         ticketBuffer = await generateTicketPDF({
           orderId: formattedOrderId,  // Usar formato #A000001
           orderDate: order.orderDate || new Date(),
           customerName: order.customerName,
           customerEmail: order.customerEmail,
           shippingAddress: order.shippingAddress,
           shippingCity: order.shippingCity,
           shippingPostalCode: order.shippingPostalCode,
           shippingCountry: order.shippingCountry,
           items: order.items,
           totalAmount: order.totalAmount,
         });
       } catch (pdfError) {
         console.error('Error generating ticket PDF:', pdfError);
       }
       
       const emailOptions: Parameters<typeof resend.emails.send>[0] = {
         from: fromEmail,
         to: order.customerEmail,
         subject: `‚úì Pedido confirmado ${formattedOrderId} - FashionStore`,
         html: generateOrderConfirmationHTML(order, formattedOrderId),
       };
       
       if (ticketBuffer) {
         emailOptions.attachments = [
           {
             filename: `ticket-${formattedOrderId.replace('#', '')}.pdf`,
             content: ticketBuffer.toString('base64'),
           }
         ];
       }
       
       const { data, error } = await resend.emails.send(emailOptions);
       // ... resto del c√≥digo
     }
   }
   ```

4. **Actualizar funci√≥n `sendOrderShipped`:**
   ```typescript
   export async function sendOrderShipped(data: import('./email-templates').OrderShippedData): Promise<{ success: boolean; error?: string }> {
     if (!resend) {
       console.warn('Resend not configured - skipping order shipped email');
       return { success: false, error: 'Email service not configured' };
     }

     try {
       const fromEmail = import.meta.env.RESEND_FROM_EMAIL || 'FashionStore <onboarding@resend.dev>';
       
       // Formatear order number si existe, sino usar UUID slice
       const displayId = data.orderNumber 
         ? formatOrderId(data.orderNumber) 
         : `#${data.orderId.slice(0, 8).toUpperCase()}`;
       
       const { data: responseData, error } = await resend.emails.send({
         from: fromEmail,
         to: data.customerEmail,
         subject: `üöö ¬°Tu pedido ${displayId} ha sido enviado! - FashionStore`,
         html: generateOrderShippedHTML(data, displayId),
       });
       // ... resto
     }
   }
   ```

5. **Actualizar interfaz `OrderShippedData` en `email-templates.ts`:**
   ```typescript
   export interface OrderShippedData {
     orderId: string;
     orderNumber?: number;  // ‚ö†Ô∏è NUEVO: Opcional para compatibilidad
     customerName: string;
     customerEmail: string;
     trackingNumber?: string;
     carrier?: string;
   }
   ```

### 3.4 Webhooks de Stripe (`src/pages/api/webhooks/stripe.ts`)

**Objetivo:** Usar el nuevo formato en logs y notificaciones.

**Cambios necesarios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **En el handler de `checkout.session.completed`:**
   ```typescript
   case 'checkout.session.completed': {
     const session = event.data.object;
     const orderId = session.metadata?.order_id;
     const orderNumber = session.metadata?.order_number;
     
     // Logging mejorado
     console.log(`Payment completed for order: ${formatOrderId(Number(orderNumber))} (UUID: ${orderId})`);
     
     // Al enviar email de confirmaci√≥n, pasar orderNumber
     await sendOrderConfirmation({
       orderId: orderId,
       orderNumber: Number(orderNumber),
       // ... resto de datos
     });
   }
   ```

## 4. Implementaci√≥n Frontend (Componentes)

### 4.1 Admin Panel

#### **Listado (`admin/pedidos/index.astro`)**

**Cambios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId, parseOrderId, isOrderIdFormat } from '@/lib/order-utils';
   ```

2. **Actualizar query para incluir `order_number`:**
   ```typescript
   let query = supabase
     .from("orders")
     .select("*, order_number", { count: "exact" })
     .order("created_at", { ascending: false });
   ```

3. **Implementar b√∫squeda inteligente:**
   ```typescript
   const searchTerm = Astro.url.searchParams.get("search");
   
   if (searchTerm) {
     const trimmed = searchTerm.trim();
     
     // Detectar si es un n√∫mero de pedido (#A000001, A5, 123, etc.)
     if (isOrderIdFormat(trimmed)) {
       const parsedNumber = parseOrderId(trimmed);
       if (parsedNumber) {
         query = query.eq("order_number", parsedNumber);
       }
     } else {
       // Buscar por email o nombre de cliente
       query = query.or(`customer_email.ilike.%${trimmed}%,customer_name.ilike.%${trimmed}%`);
     }
   }
   ```

4. **Display en la tabla:**
   ```astro
   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
     <a href={`/admin/pedidos/${order.id}`} class="text-blue-400 hover:text-blue-300">
       {formatOrderId(order.order_number)}
     </a>
   </td>
   ```

5. **A√±adir campo de b√∫squeda en el HTML:**
   ```astro
   <form method="GET" action="/admin/pedidos" class="mb-6">
     <div class="flex gap-2">
       <input
         type="text"
         name="search"
         placeholder="Buscar por #A000001, email o nombre..."
         value={searchTerm || ""}
         class="flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg"
       />
       <button type="submit" class="px-6 py-2 bg-blue-600 rounded-lg">
         Buscar
       </button>
       {searchTerm && (
         <a href="/admin/pedidos" class="px-6 py-2 bg-gray-700 rounded-lg">
           Limpiar
         </a>
       )}
     </div>
   </form>
   ```

#### **Detalle (`admin/pedidos/[id].astro`)**

**Cambios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar query:**
   ```typescript
   const { data: order } = await supabase
     .from("orders")
     .select(`
       *,
       order_number,
       order_items (
         id,
         quantity,
         price_at_purchase,
         product:products (id, name, slug),
         variant:product_variants (id, size)
       )
     `)
     .eq("id", id)
     .single();
   ```

3. **Display en el header:**
   ```astro
   <div class="flex items-center justify-between mb-6">
     <h1 class="text-3xl font-bold">
       Pedido {formatOrderId(order.order_number)}
     </h1>
     <span class="text-gray-400 text-sm">UUID: {order.id}</span>
   </div>
   ```

#### **Devoluciones (`admin/devoluciones/index.astro` y `[id].astro`)**

**Cambios:**

1. **En listado, actualizar query:**
   ```typescript
   const { data: returns } = await supabase
     .from("returns")
     .select(`
       *,
       order:orders (
         id,
         order_number,
         customer_name,
         customer_email
       )
     `)
     .order("created_at", { ascending: false });
   ```

2. **Display del pedido relacionado:**
   ```astro
   <td>
     <a href={`/admin/pedidos/${ret.order.id}`} class="text-blue-400 hover:text-blue-300">
       {formatOrderId(ret.order.order_number)}
     </a>
   </td>
   ```

### 4.2 √Årea Cliente

#### **Listado (`cuenta/pedidos/index.astro`)**

**Cambios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar query:**
   ```typescript
   const { data: orders } = await supabase
     .from("orders")
     .select("*, order_number")
     .eq("customer_email", user.email)
     .order("created_at", { ascending: false });
   ```

3. **Display en la tarjeta:**
   ```astro
   <div class="border-b border-gray-200 pb-4 mb-4">
     <div class="flex justify-between items-start">
       <div>
         <h3 class="text-lg font-semibold text-gray-900">
           Pedido {formatOrderId(order.order_number)}
         </h3>
         <p class="text-sm text-gray-500">
           {formatDate(order.created_at)}
         </p>
       </div>
       <span class={`${statusConfig[order.status].badgeClass} px-3 py-1 rounded-full text-sm`}>
         {statusConfig[order.status].label}
       </span>
     </div>
   </div>
   ```

#### **Detalle (`cuenta/pedidos/[id].astro`)**

**Cambios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar query:**
   ```typescript
   const { data: order } = await supabase
     .from("orders")
     .select(`
       *,
       order_number,
       order_items (
         id,
         quantity,
         price_at_purchase,
         product:products (id, name, slug),
         variant:product_variants (id, size)
       )
     `)
     .eq("id", id)
     .eq("customer_email", user.email)
     .single();
   ```

3. **Pasar datos al componente `InvoiceButton`:**
   ```astro
   <InvoiceButton
     orderId={order.id}
     orderNumber={order.order_number}
     orderStatus={order.status}
     client:load
   />
   ```

4. **Display en el t√≠tulo:**
   ```astro
   <h1 class="text-3xl font-bold text-gray-900 mb-2">
     Pedido {formatOrderId(order.order_number)}
   </h1>
   ```

#### **P√°gina √âxito (`checkout/exito.astro`)**

**Cambios:**

1. **Importar utilidades:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';
   ```

2. **Actualizar query para incluir `order_number`:**
   ```typescript
   const { data: orderData } = await supabase
     .from("orders")
     .select("*, order_number")
     .eq("id", session.metadata.order_id)
     .single();

   order = orderData;
   ```

3. **Extraer `orderNumber` para el email:**
   ```typescript
   // Get order items
   const { data: items } = await supabase
     .from("order_items")
     .select(`
       quantity,
       price_at_purchase,
       product:products(name),
       variant:product_variants(size)
     `)
     .eq("order_id", order.id);

   orderItems = items || [];

   // Send confirmation email (only if not already paid)
   if (!wasAlreadyPaid) {
     const emailData = {
       orderId: order.id,
       orderNumber: order.order_number,  // ‚ö†Ô∏è NUEVO
       customerName: order.customer_name,
       customerEmail: order.customer_email,
       shippingAddress: order.shipping_address,
       shippingCity: order.shipping_city,
       shippingPostalCode: order.shipping_postal_code,
       shippingCountry: order.shipping_country,
       totalAmount: order.total_amount,
       orderDate: new Date(order.created_at),
       items: orderItems.map((item: any) => ({
         productName: item.product.name,
         size: item.variant.size,
         quantity: item.quantity,
         price: item.price_at_purchase,
       })),
     };
     
     const { success } = await sendOrderConfirmation(emailData);
     emailSent = success;
   }
   ```

4. **Display en la p√°gina:**
   ```astro
   <div class="text-center">
     <h1 class="text-4xl font-bold text-green-600 mb-4">
       ¬°Pedido Confirmado!
     </h1>
     <p class="text-xl text-gray-700 mb-8">
       Tu pedido {formatOrderId(order.order_number)} ha sido recibido correctamente
     </p>
   </div>
   ```

### 4.3 Componentes React

#### **`InvoiceButton.tsx`**

**Cambios:**

1. **Actualizar interfaz:**
   ```typescript
   interface InvoiceButtonProps {
     orderId: string;          // UUID
     orderNumber: number;      // ‚ö†Ô∏è CAMBIAR de string a number
     orderStatus: string;
   }
   ```

2. **Importar y usar utilidad:**
   ```typescript
   import { formatOrderId } from '@/lib/order-utils';

   export default function InvoiceButton({ orderId, orderNumber, orderStatus }: InvoiceButtonProps) {
     const formattedOrderId = formatOrderId(orderNumber);
     
     return (
       <>
         {/* ... resto del c√≥digo ... */}
         <RequestInvoiceModal
           orderId={orderId}
           orderNumber={formattedOrderId}  // Pasar ya formateado
           onClose={() => setShowModal(false)}
           onSuccess={handleSuccess}
         />
       </>
     );
   }
   ```

#### **`RequestInvoiceModal.tsx`**

**Cambios:**

1. **Actualizar interfaz (mantener string para display):**
   ```typescript
   interface RequestInvoiceModalProps {
     orderId: string;
     orderNumber: string;  // Ya viene formateado (#A000001)
     onClose: () => void;
     onSuccess: () => void;
   }
   ```

2. **Display en el modal:**
   ```tsx
   <h3 className="text-lg font-semibold mb-4">
     Solicitar Factura - Pedido {orderNumber}
   </h3>
   ```

## 5. Plan de Verificaci√≥n

### 5.1 Verificaci√≥n de Migraci√≥n SQL

```sql
-- Ejecutar despu√©s de la migraci√≥n 026
SELECT 
  COUNT(*) as total_orders,
  COUNT(order_number) as orders_with_number,
  MIN(order_number) as min_number,
  MAX(order_number) as max_number
FROM orders;

-- Verificar secuencia
SELECT last_value FROM orders_order_number_seq;

-- Verificar constraint
SELECT constraint_name, constraint_type 
FROM information_schema.table_constraints 
WHERE table_name = 'orders' AND constraint_name LIKE '%order_number%';
```

### 5.2 Tests Unitarios

```bash
# Ejecutar tests de utilidades
npm run test src/lib/order-utils.test.ts
```

### 5.3 Smoke Test Completo

#### **Test 1: Checkout Flow**
1. A√±adir productos al carrito
2. Ir a checkout y completar formulario
3. Realizar pago con tarjeta de prueba de Stripe
4. **Verificar:**
   - ‚úÖ P√°gina de √©xito muestra `#A000XXX`
   - ‚úÖ Email recibido tiene asunto con `#A000XXX`
   - ‚úÖ PDF adjunto tiene el n√∫mero formateado
   - ‚úÖ Dashboard de Stripe muestra metadata con `order_slug: #A000XXX`

#### **Test 2: Admin Panel**
1. Acceder a `/admin/pedidos`
2. **Verificar:**
   - ‚úÖ Todos los pedidos muestran formato `#A000XXX`
   - ‚úÖ B√∫squeda por `#A000001` encuentra el pedido
   - ‚úÖ B√∫squeda por `A1` encuentra el pedido
   - ‚úÖ B√∫squeda por `1` encuentra el pedido
   - ‚úÖ B√∫squeda por email funciona correctamente
3. Entrar al detalle de un pedido
4. **Verificar:**
   - ‚úÖ Header muestra `Pedido #A000XXX`
   - ‚úÖ Cambiar estado funciona correctamente

#### **Test 3: √Årea Cliente**
1. Login con cuenta que tiene pedidos
2. Ir a `/cuenta/pedidos`
3. **Verificar:**
   - ‚úÖ Pedidos muestran formato `#A000XXX`
4. Entrar al detalle de un pedido con estado `paid` o superior
5. **Verificar:**
   - ‚úÖ T√≠tulo muestra `Pedido #A000XXX`
   - ‚úÖ Bot√≥n de factura funciona

#### **Test 4: Facturaci√≥n**
1. Solicitar factura para un pedido
2. **Verificar:**
   - ‚úÖ N√∫mero de factura: `FV-A000XXX`
   - ‚úÖ PDF generado correctamente
   - ‚úÖ Contenido del PDF muestra `#A000XXX`
   - ‚úÖ Nombre del archivo descargado contiene el n√∫mero

#### **Test 5: Emails**
1. Marcar un pedido como `shipped` desde admin
2. **Verificar:**
   - ‚úÖ Email de env√≠o tiene asunto con `#A000XXX`
   - ‚úÖ Contenido del email muestra el n√∫mero formateado

### 5.4 Monitorizaci√≥n Post-Despliegue

**M√©tricas a vigilar:**
- Logs de error relacionados con `order_number`
- Quejas de usuarios sobre identificadores
- Tiempo de respuesta de b√∫squedas en admin
- Tasa de √©xito en generaci√≥n de facturas

**Queries √∫tiles:**

```sql
-- Pedidos sin order_number (deber√≠a ser 0)
SELECT COUNT(*) FROM orders WHERE order_number IS NULL;

-- √öltimos 10 pedidos con sus n√∫meros
SELECT id, order_number, customer_email, created_at 
FROM orders 
ORDER BY created_at DESC 
LIMIT 10;

-- Verificar unicidad
SELECT order_number, COUNT(*) 
FROM orders 
GROUP BY order_number 
HAVING COUNT(*) > 1;
```

---

## 6. Rollback y Contingencia

### 6.1 Plan de Rollback

**Si algo sale mal durante o despu√©s del despliegue:**

1. **Rollback de c√≥digo (Git):**
   ```bash
   git revert <commit-hash>
   git push origin main
   ```

2. **Rollback de base de datos:**
   ```bash
   # Conectar a Supabase SQL Editor
   # Ejecutar: Doc/migrations/rollback_026.sql
   ```

3. **Verificaci√≥n post-rollback:**
   - Sistema funciona con UUIDs
   - No hay referencias a `order_number` que causen errores
   - Emails se env√≠an correctamente

### 6.2 Compatibilidad Temporal

**Durante el per√≠odo de transici√≥n**, el sistema debe:
- ‚úÖ Soportar pedidos antiguos sin `order_number` (mostrar UUID slice como fallback)
- ‚úÖ Todos los pedidos nuevos tienen `order_number`
- ‚úÖ B√∫squedas funcionan con ambos formatos

**Funci√≥n de compatibilidad:**

```typescript
// A√±adir a order-utils.ts
export const getDisplayOrderId = (order: { order_number?: number | null, id: string }): string => {
  if (order.order_number != null && order.order_number > 0) {
    return formatOrderId(order.order_number);
  }
  // Fallback para pedidos antiguos
  return `#${order.id.slice(0, 8).toUpperCase()}`;
};
```

---

## 7. Checklist de Pre-Deploy

### Base de Datos
- [ ] Script de migraci√≥n 026 revisado
- [ ] Script de rollback preparado
- [ ] Backup completo de base de datos realizado
- [ ] Migraci√≥n probada en entorno de desarrollo

### C√≥digo
- [ ] Tests unitarios pasando (100%)
- [ ] Todas las queries incluyen `order_number` donde es necesario
- [ ] RPC `create_checkout_order` actualizado
- [ ] Utilidades `order-utils.ts` creadas y probadas
- [ ] Tipos TypeScript actualizados

### Frontend
- [ ] Admin: listado y detalle actualizados
- [ ] Cliente: listado y detalle actualizados
- [ ] P√°gina de √©xito actualizada
- [ ] Componentes React actualizados

### Backend
- [ ] API create-session actualizada
- [ ] API invoices actualizada
- [ ] Emails actualizados
- [ ] Webhooks actualizados

### Documentaci√≥n
- [ ] README actualizado con nuevo formato
- [ ] Plan de migraci√≥n completo
- [ ] Procedimiento de rollback documentado

### Testing
- [ ] Smoke test checkout completo
- [ ] Smoke test admin completo
- [ ] Smoke test facturas completo
- [ ] Verificaci√≥n de emails

---

## 8. Cronograma Recomendado

### Fase 1: Preparaci√≥n (1-2 horas)
- Crear rama: `feature/order-number-migration`
- Crear utilidades y tests
- Preparar scripts SQL
- Commit inicial

### Fase 2: Base de Datos (30 min - **Ventana de Mantenimiento**)
- Ejecutar migraci√≥n 026 en Supabase
- Verificar datos
- Actualizar RPC functions

### Fase 3: Backend (2-3 horas)
- Actualizar APIs
- Actualizar emails
- Actualizar webhooks
- Tests de integraci√≥n

### Fase 4: Frontend (3-4 horas)
- Actualizar admin
- Actualizar √°rea cliente
- Actualizar componentes React
- Tests E2E

### Fase 5: Deploy y Verificaci√≥n (1-2 horas)
- Merge a main
- Deploy a producci√≥n
- Smoke tests en producci√≥n
- Monitorizaci√≥n activa (24h)

**Total estimado: 8-12 horas de desarrollo + testing**

---

## 9. Contactos y Recursos

### Documentaci√≥n de Referencia
- Supabase IDENTITY columns: https://supabase.com/docs/guides/database/tables#identity-columns
- PostgreSQL Sequences: https://www.postgresql.org/docs/current/sql-createsequence.html
- Stripe Metadata: https://stripe.com/docs/api/metadata

### Soporte
- En caso de problemas cr√≠ticos: Rollback inmediato
- Logs de aplicaci√≥n: Revisar en tiempo real durante deploy
- Supabase Dashboard: Monitorizar queries lentas

---

## 10. Notas Finales

### Consideraciones Importantes
1. **Backup antes de migrar:** CR√çTICO
2. **Ventana de mantenimiento:** Recomendada para la migraci√≥n SQL
3. **Comunicaci√≥n:** Informar a usuarios de posibles interrupciones breves
4. **Monitorizaci√≥n:** Activa durante las primeras 24-48h

### Mejoras Futuras
- [ ] Exportaci√≥n CSV de pedidos con nuevo formato
- [ ] API p√∫blica para tracking por n√∫mero de pedido
- [ ] Sistema de etiquetas de env√≠o con QR incluyendo `#A000XXX`
- [ ] Dashboard analytics con m√©tricas por rangos de n√∫meros

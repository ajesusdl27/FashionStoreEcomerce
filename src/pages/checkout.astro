---
import PublicLayout from "@/layouts/PublicLayout.astro";
import CheckoutForm from "@/components/islands/CheckoutForm";
import { createAuthenticatedClient } from "@/lib/supabase";
import { getShippingConfig } from "@/lib/settings";

// Obtener configuración de envío desde la BD
const shippingConfig = await getShippingConfig();

// Get user data if logged in
const user = Astro.locals.user;
let userData = null;

if (user) {
  // Fetch profile data using RPC (SECURITY DEFINER for reliability)
  const accessToken = Astro.cookies.get("sb-access-token")?.value;
  const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
  const authClient = createAuthenticatedClient(accessToken, refreshToken);

  // Use RPC function - same as profile API
  const { data: profileData } = await authClient.rpc("get_customer_profile");

  const profile = profileData && profileData.length > 0 ? profileData[0] : null;

  userData = {
    name: profile?.full_name || user.user_metadata?.full_name || "",
    email: profile?.email || user.email || "",
    phone: profile?.phone || user.user_metadata?.phone || "",
    address: profile?.default_address || "",
    city: profile?.default_city || "",
    postalCode: profile?.default_postal_code || "",
  };
}
---

<PublicLayout title="Checkout - FashionStore">
  <div class="container mx-auto px-4 py-8">
    <h1 class="font-display text-4xl md:text-5xl text-center mb-8">
      Finalizar Compra
    </h1>

    <CheckoutForm 
      client:load 
      userData={userData} 
      shippingCost={shippingConfig.shippingCostEuros}
      freeShippingThreshold={shippingConfig.freeShippingThreshold}
    />
  </div>
</PublicLayout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70%,
    90% {
      transform: translateX(-4px);
    }
    20%,
    40%,
    60%,
    70%,
    80% {
      transform: translateX(4px);
    }
  }

  :global(.animate-fadeIn) {
    animation: fadeIn 0.3s ease-out;
  }

  :global(.animate-shake) {
    animation: shake 0.5s ease-in-out;
  }
</style>

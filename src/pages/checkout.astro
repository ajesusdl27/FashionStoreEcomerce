---
import PublicLayout from "@/layouts/PublicLayout.astro";
import CheckoutForm from "@/components/islands/CheckoutForm";
import { createAuthenticatedClient } from "@/lib/supabase";
import { getShippingConfig, getSettings } from "@/lib/settings";
import { ShieldCheck, Truck, RefreshCw } from "lucide-react";

// Obtener configuración de envío desde la BD
const shippingConfig = await getShippingConfig();
const settings = await getSettings();

// Get user data if logged in
const user = Astro.locals.user;
let userData = null;

if (user) {
  // Fetch profile data using RPC (SECURITY DEFINER for reliability)
  const accessToken = Astro.cookies.get("sb-access-token")?.value;
  const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
  const authClient = createAuthenticatedClient(accessToken, refreshToken);

  // Use RPC function - same as profile API
  const { data: profileData } = await authClient.rpc("get_customer_profile");

  const profile = profileData && profileData.length > 0 ? profileData[0] : null;

  userData = {
    name: profile?.full_name || user.user_metadata?.full_name || "",
    email: profile?.email || user.email || "",
    phone: profile?.phone || user.user_metadata?.phone || "",
    address: profile?.default_address || "",
    city: profile?.default_city || "",
    postalCode: profile?.default_postal_code || "",
  };
}
---

<PublicLayout title="Checkout - FashionStore">
  <!-- Breadcrumb -->
  <div class="border-b border-border">
    <div class="container mx-auto px-4 py-3">
      <nav class="text-sm text-muted-foreground">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-primary transition-colors">Inicio</a></li>
          <li>/</li>
          <li><a href="/carrito" class="hover:text-primary transition-colors">Carrito</a></li>
          <li>/</li>
          <li class="text-foreground">Checkout</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8 md:py-12">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="font-display text-4xl md:text-5xl text-foreground mb-3">
        Finalizar Compra
      </h1>
      <p class="text-muted-foreground">
        Completa tu pedido en unos simples pasos
      </p>
    </div>

    <!-- Trust bar mini -->
    <div class="flex flex-wrap justify-center gap-6 md:gap-10 text-sm text-muted-foreground mb-10">
      <div class="flex items-center gap-2">
        <ShieldCheck className="w-5 h-5 text-green-500" />
        <span>Pago seguro SSL</span>
      </div>
      <div class="flex items-center gap-2">
        <Truck className="w-5 h-5 text-primary" />
        <span>Envío gratis +{shippingConfig.freeShippingThreshold}€</span>
      </div>
      <div class="flex items-center gap-2">
        <RefreshCw className="w-5 h-5 text-primary" />
        <span>{settings.returnWindowDays} días devolución</span>
      </div>
    </div>

    <CheckoutForm 
      client:load 
      userData={userData} 
      shippingCost={shippingConfig.shippingCostEuros}
      freeShippingThreshold={shippingConfig.freeShippingThreshold}
    />
  </div>
</PublicLayout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70%,
    90% {
      transform: translateX(-4px);
    }
    20%,
    40%,
    60%,
    70%,
    80% {
      transform: translateX(4px);
    }
  }

  :global(.animate-fadeIn) {
    animation: fadeIn 0.3s ease-out;
  }

  :global(.animate-shake) {
    animation: shake 0.5s ease-in-out;
  }
</style>

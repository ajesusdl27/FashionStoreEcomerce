---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createAuthenticatedClient } from "@/lib/supabase";

// Get authenticated client for RLS compliance
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch coupons
const { data: coupons, error: _error } = await authClient
  .from("coupons")
  .select("*")
  .order("created_at", { ascending: false });

const formatDate = (date: string | null) => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
};

const formatDiscount = (type: string, value: number) => {
  return type === "percentage" ? `${value}%` : `${value}‚Ç¨`;
};

// Calculate coupon status
const getCouponStatus = (coupon: any) => {
  const now = new Date();
  if (!coupon.is_active) return { label: "Inactivo", class: "badge-muted" };
  if (coupon.end_date && new Date(coupon.end_date) < now)
    return { label: "Expirado", class: "badge-warning" };
  if (coupon.max_uses && coupon.current_uses >= coupon.max_uses)
    return { label: "Agotado", class: "badge-error" };
  // Check if expires within 7 days
  if (coupon.end_date) {
    const daysLeft = Math.ceil(
      (new Date(coupon.end_date).getTime() - now.getTime()) /
        (1000 * 60 * 60 * 24),
    );
    if (daysLeft <= 7 && daysLeft > 0)
      return { label: `Expira en ${daysLeft}d`, class: "badge-warning" };
  }
  return { label: "Activo", class: "badge-success" };
};
---

<AdminLayout title="Cupones">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <h1 class="font-heading text-2xl text-foreground">
          C√≥digos Promocionales
        </h1>
        <p class="text-sm text-muted-foreground mt-1">
          Gestiona los cupones de descuento
        </p>
      </div>
      <button id="btn-new-coupon" class="admin-btn admin-btn-primary">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Cup√≥n
      </button>
    </div>

    <!-- Search and Filters -->
    <div class="flex flex-col sm:flex-row gap-3">
      <div class="flex-1 relative">
        <svg
          class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id="search-coupon"
          placeholder="Buscar por c√≥digo..."
          class="admin-input w-full pl-9"
        />
      </div>
      <select id="filter-status" class="admin-input w-full sm:w-48">
        <option value="">Todos los estados</option>
        <option value="active">Activos</option>
        <option value="inactive">Inactivos</option>
        <option value="expired">Expirados</option>
        <option value="depleted">Agotados</option>
      </select>
    </div>

    <!-- Status Tabs -->
    <div class="flex flex-wrap gap-2 mb-6">
      <a
        href="/admin/cupones"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          !Astro.url.searchParams.get('status')
            ? 'bg-primary text-primary-foreground'
            : 'bg-muted text-muted-foreground hover:bg-muted/80'
        }`}
      >
        Todos ({coupons?.length || 0})
      </a>
      <a
        href="/admin/cupones?status=active"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          Astro.url.searchParams.get('status') === 'active'
            ? 'bg-green-500 text-white'
            : 'bg-green-500/10 text-green-500 hover:bg-green-500/20'
        }`}
      >
        Activos ({coupons?.filter((c: any) => getCouponStatus(c).label === 'Activo').length || 0})
      </a>
      <a
        href="/admin/cupones?status=expired"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          Astro.url.searchParams.get('status') === 'expired'
            ? 'bg-yellow-500 text-white'
            : 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 hover:bg-yellow-500/20'
        }`}
      >
        Expirados ({coupons?.filter((c: any) => getCouponStatus(c).label === 'Expirado').length || 0})
      </a>
      <a
        href="/admin/cupones?status=depleted"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          Astro.url.searchParams.get('status') === 'depleted'
            ? 'bg-red-500 text-white'
            : 'bg-red-500/10 text-red-500 hover:bg-red-500/20'
        }`}
      >
        Agotados ({coupons?.filter((c: any) => getCouponStatus(c).label === 'Agotado').length || 0})
      </a>
    </div>

    <!-- Coupons Table -->
    <div class="admin-card">
      {
        coupons && coupons.length > 0 ? (
          <div class="overflow-x-auto -mx-6 scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent">
            <table class="admin-table min-w-full" id="coupons-table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Descuento</th>
                  <th>M√≠n. Compra</th>
                  <th>Uso</th>
                  <th>Expiraci√≥n</th>
                  <th>Estado</th>
                  <th class="text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {coupons.map((coupon: any) => {
                  const status = getCouponStatus(coupon);
                  const usagePercent = coupon.max_uses ? Math.min(100, (coupon.current_uses / coupon.max_uses) * 100) : 0;
                  const now = new Date();
                  const endDate = coupon.end_date ? new Date(coupon.end_date) : null;
                  const daysLeft = endDate ? Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) : null;
                  
                  return (
                    <tr
                      data-code={coupon.code.toLowerCase()}
                      data-status={
                        status.label.toLowerCase().includes("activo")
                          ? "active"
                          : status.label.toLowerCase().includes("inactivo")
                            ? "inactive"
                            : status.label.toLowerCase().includes("expir")
                              ? "expired"
                              : status.label.toLowerCase().includes("agotado")
                                ? "depleted"
                                : "active"
                      }
                    >
                      <td>
                        <div>
                          <span class="font-mono font-bold text-primary text-base">
                            {coupon.code}
                          </span>
                          {coupon.discount_type === 'percentage' && coupon.max_discount_amount && (
                            <p class="text-xs text-muted-foreground mt-0.5">
                              M√°x. {coupon.max_discount_amount}‚Ç¨
                            </p>
                          )}
                        </div>
                      </td>
                      <td>
                        <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-primary/10 text-primary font-bold">
                          {formatDiscount(coupon.discount_type, coupon.discount_value)}
                        </span>
                      </td>
                      <td>
                        {coupon.min_purchase_amount > 0 ? (
                          <span class="font-medium">{coupon.min_purchase_amount}‚Ç¨</span>
                        ) : (
                          <span class="text-muted-foreground">-</span>
                        )}
                      </td>
                      <td>
                        {coupon.max_uses ? (
                          <div class="space-y-1 min-w-[100px]">
                            <div class="flex items-center justify-between text-xs">
                              <span>{coupon.current_uses}/{coupon.max_uses}</span>
                              <span class={usagePercent >= 80 ? 'text-red-500' : usagePercent >= 50 ? 'text-yellow-500' : 'text-green-500'}>
                                {Math.round(usagePercent)}%
                              </span>
                            </div>
                            <div class="progress-bar">
                              <div 
                                class={`progress-bar-fill ${usagePercent >= 80 ? 'progress-bar-danger' : usagePercent >= 50 ? 'progress-bar-warning' : 'progress-bar-success'}`}
                                style={`width: ${usagePercent}%`}
                              />
                            </div>
                          </div>
                        ) : (
                          <span class="text-muted-foreground text-sm">{coupon.current_uses} usos</span>
                        )}
                      </td>
                      <td>
                        <>
                          {!endDate && (
                            <span class="text-muted-foreground text-sm">Sin l√≠mite</span>
                          )}
                          {endDate && daysLeft !== null && daysLeft <= 0 && (
                            <span class="badge badge-danger">Expirado</span>
                          )}
                          {endDate && daysLeft !== null && daysLeft > 0 && daysLeft <= 7 && (
                            <span class={`countdown-badge ${daysLeft <= 2 ? 'countdown-urgent' : 'countdown-warning'}`}>
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {daysLeft}d restantes
                            </span>
                          )}
                          {endDate && (daysLeft === null || daysLeft > 7) && !(daysLeft !== null && daysLeft <= 0) && (
                            <span class="text-sm text-muted-foreground">
                              {formatDate(coupon.end_date)}
                            </span>
                          )}
                        </>
                      </td>
                      <td>
                        <button
                          class="toggle-status-btn"
                          data-id={coupon.id}
                          data-active={coupon.is_active}
                        >
                          <span class={`badge ${status.class}`}>
                            {status.label}
                          </span>
                        </button>
                      </td>
                      <td class="text-right">
                        <div class="flex items-center justify-end gap-1">
                          <button
                            class="edit-coupon-btn admin-btn-icon hover:bg-secondary"
                            data-coupon={JSON.stringify(coupon)}
                            title="Editar"
                          >
                            <svg
                              class="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                              />
                            </svg>
                          </button>
                          <button
                            class="delete-coupon-btn admin-btn-icon text-red-400 hover:bg-red-500/10"
                            data-id={coupon.id}
                            data-code={coupon.code}
                            title="Eliminar"
                          >
                            <svg
                              class="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                              />
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="text-center py-12 text-muted-foreground">
            <svg
              class="w-16 h-16 mx-auto mb-4 opacity-50"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              />
            </svg>
            <p class="font-medium">No hay cupones creados</p>
            <p class="text-sm mt-1">Crea tu primer c√≥digo promocional</p>
          </div>
        )
      }
    </div>
  </div>

  <!-- Create Coupon Modal -->
  <div
    id="coupon-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
  >
    <div
      class="bg-card border border-border rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl"
    >
      <div class="p-6 border-b border-border bg-gradient-to-r from-primary/5 to-primary/10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
          </div>
          <div>
            <h2 class="font-heading text-xl text-foreground">Nuevo Cup√≥n</h2>
            <p class="text-sm text-muted-foreground">Crea un c√≥digo promocional para tus clientes</p>
          </div>
        </div>
      </div>

      <form id="coupon-form" class="p-6 space-y-6">
        <!-- Basic Information Section -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
              <span class="text-primary text-sm font-bold">1</span>
            </div>
            <h4 class="font-medium text-foreground">Informaci√≥n del Cup√≥n</h4>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                C√≥digo del Cup√≥n
                <span class="text-red-500">*</span>
              </span>
            </label>
            <input
              type="text"
              name="code"
              required
              placeholder="Ej: VERANO20"
              class="admin-input w-full uppercase text-lg font-mono"
            />
            <p class="text-xs text-muted-foreground mt-1">
              El c√≥digo que los clientes introducir√°n en el checkout
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                  </svg>
                  Tipo de Descuento
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <select name="discount_type" required class="admin-input w-full">
                <option value="percentage">üìä Porcentaje (%)</option>
                <option value="fixed">üí∞ Cantidad fija (‚Ç¨)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                  </svg>
                  Valor del Descuento
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="number"
                name="discount_value"
                required
                min="0.01"
                step="0.01"
                placeholder="10"
                class="admin-input w-full text-lg"
              />
            </div>
          </div>
        </div>

        <!-- Restrictions Section -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
              <span class="text-primary text-sm font-bold">2</span>
            </div>
            <h4 class="font-medium text-foreground">Restricciones</h4>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 3H3m4 10v6a1 1 0 001 1h1m0 0h4m-5 0v-1a1 1 0 011-1h2a1 1 0 011 1v1m-5 0H9m0 0v1"/>
                  </svg>
                  Compra M√≠nima (‚Ç¨)
                </span>
              </label>
              <input
                type="number"
                name="min_purchase_amount"
                min="0"
                step="0.01"
                placeholder="0"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Monto m√≠nimo para aplicar el cup√≥n
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                  </svg>
                  M√°x. Descuento (‚Ç¨)
                </span>
              </label>
              <input
                type="number"
                name="max_discount_amount"
                min="0"
                step="0.01"
                placeholder="Sin l√≠mite"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Solo para descuentos por porcentaje
              </p>
            </div>
          </div>
        </div>

        <!-- Schedule Section -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
              <span class="text-primary text-sm font-bold">3</span>
            </div>
            <h4 class="font-medium text-foreground">Programaci√≥n</h4>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Fecha de Inicio
                </span>
              </label>
              <input
                type="datetime-local"
                name="start_date"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Cu√°ndo empieza a ser v√°lido
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Fecha de Expiraci√≥n
                </span>
              </label>
              <input
                type="datetime-local"
                name="end_date"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                D√©jalo vac√≠o para que no expire
              </p>
            </div>
          </div>
        </div>

        <!-- Usage Limits Section -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
              <span class="text-primary text-sm font-bold">4</span>
            </div>
            <h4 class="font-medium text-foreground">L√≠mites de Uso</h4>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                  M√°x. Usos Totales
                </span>
              </label>
              <input
                type="number"
                name="max_uses"
                min="1"
                placeholder="Ilimitado"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Cu√°ntas veces se puede usar en total
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  M√°x. por Cliente
                </span>
              </label>
              <input
                type="number"
                name="max_uses_per_customer"
                min="1"
                value="1"
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Cu√°ntas veces puede usarlo cada cliente
              </p>
            </div>
          </div>
        </div>

        <div
          id="form-error"
          class="hidden p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm"
        >
        </div>
      </form>

      <div class="p-6 border-t border-border flex flex-col sm:flex-row gap-3 justify-end">
        <button type="button" id="btn-cancel" class="px-6 py-3 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground transition-all flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Cancelar
        </button>
        <button
          type="submit"
          form="coupon-form"
          id="btn-submit"
          class="px-6 py-3 rounded-lg bg-primary text-primary-foreground font-medium hover:shadow-[0_0_20px_rgba(204,255,0,0.3)] transition-all flex items-center justify-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
          </svg>
          <span id="btn-text">Crear Cup√≥n</span>
          <svg
            id="btn-spinner"
            class="hidden animate-spin w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Coupon Modal -->
  <div
    id="edit-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
  >
    <div
      class="bg-card border border-border rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl"
    >
      <div class="p-6 border-b border-border bg-gradient-to-r from-blue-500/5 to-blue-500/10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </div>
          <div>
            <h2 class="font-heading text-xl text-foreground">Editar Cup√≥n</h2>
            <p class="text-sm text-muted-foreground">
              C√≥digo y descuento no se pueden modificar (sincronizados con Stripe)
            </p>
          </div>
        </div>
      </div>

      <form id="edit-form" class="p-6 space-y-4">
        <input type="hidden" name="id" />

        <!-- Read-only fields -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">C√≥digo</label>
            <input
              type="text"
              name="code_display"
              readonly
              class="admin-input w-full bg-muted/50 cursor-not-allowed"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Descuento</label>
            <input
              type="text"
              name="discount_display"
              readonly
              class="admin-input w-full bg-muted/50 cursor-not-allowed"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2"
              >Compra m√≠nima (‚Ç¨)</label
            >
            <input
              type="number"
              name="min_purchase_amount"
              min="0"
              step="0.01"
              placeholder="0"
              class="admin-input w-full"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2"
              >M√°x. descuento (‚Ç¨)</label
            >
            <input
              type="number"
              name="max_discount_amount"
              min="0"
              step="0.01"
              placeholder="Sin l√≠mite"
              class="admin-input w-full"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Fecha inicio</label>
            <input
              type="datetime-local"
              name="start_date"
              class="admin-input w-full"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Fecha fin</label>
            <input
              type="datetime-local"
              name="end_date"
              class="admin-input w-full"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2"
              >M√°x. usos totales</label
            >
            <input
              type="number"
              name="max_uses"
              min="1"
              placeholder="Ilimitado"
              class="admin-input w-full"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2"
              >M√°x. por cliente</label
            >
            <input
              type="number"
              name="max_uses_per_customer"
              min="1"
              class="admin-input w-full"
            />
          </div>
        </div>

        <div
          id="edit-form-error"
          class="hidden p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm"
        >
        </div>
      </form>

      <div class="p-6 border-t border-border flex flex-col sm:flex-row gap-3 justify-end">
        <button type="button" id="btn-edit-cancel" class="px-6 py-3 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground transition-all flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Cancelar
        </button>
        <button
          type="submit"
          form="edit-form"
          id="btn-edit-submit"
          class="px-6 py-3 rounded-lg bg-blue-500 text-white font-medium hover:bg-blue-600 transition-all flex items-center justify-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span id="btn-edit-text">Guardar Cambios</span>
          <svg
            id="btn-edit-spinner"
            class="hidden animate-spin w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div
    id="delete-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
  >
    <div class="bg-card border border-border rounded-2xl w-full max-w-md p-6">
      <div class="flex items-center gap-3 text-amber-400 mb-4">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
        <h3 class="font-heading text-lg text-foreground">
          Confirmar Eliminaci√≥n
        </h3>
      </div>
      <p class="text-muted-foreground mb-6">
        ¬øEst√°s seguro de eliminar el cup√≥n <strong
          id="delete-code"
          class="text-foreground"></strong>? Esta acci√≥n eliminar√° tambi√©n el
        cup√≥n de Stripe y no se puede deshacer.
      </p>
      <div class="flex gap-3 justify-end">
        <button id="cancel-delete" class="admin-btn">Cancelar</button>
        <button
          id="confirm-delete"
          class="admin-btn bg-red-500 hover:bg-red-600 text-white"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
</AdminLayout>

<script>
  // Toast function
  function showToast(
    message: string,
    type: "success" | "error" | "info" = "info",
  ) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    const bgColor =
      type === "success"
        ? "bg-green-500"
        : type === "error"
          ? "bg-red-500"
          : "bg-blue-500";
    toast.className = `px-4 py-3 rounded-lg shadow-lg ${bgColor} text-white flex items-center gap-2 animate-fadeIn`;

    const icon =
      type === "success"
        ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
        : type === "error"
          ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
          : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';

    toast.innerHTML = `${icon}<span>${message}</span>`;
    container?.appendChild(toast);

    setTimeout(() => {
      toast.classList.add("opacity-0", "transition-opacity");
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Search and filter
  const searchInput = document.getElementById(
    "search-coupon",
  ) as HTMLInputElement;
  const filterSelect = document.getElementById(
    "filter-status",
  ) as HTMLSelectElement;
  const tableRows = document.querySelectorAll("#coupons-table tbody tr");

  function filterTable() {
    const searchTerm = searchInput?.value.toLowerCase() || "";
    const statusFilter = filterSelect?.value || "";

    tableRows.forEach((row) => {
      const code = row.getAttribute("data-code") || "";
      const status = row.getAttribute("data-status") || "";

      const matchesSearch = code.includes(searchTerm);
      const matchesStatus = !statusFilter || status === statusFilter;

      (row as HTMLElement).style.display =
        matchesSearch && matchesStatus ? "" : "none";
    });
  }

  searchInput?.addEventListener("input", filterTable);
  filterSelect?.addEventListener("change", filterTable);

  // Create modal
  const modal = document.getElementById("coupon-modal") as HTMLElement;
  const form = document.getElementById("coupon-form") as HTMLFormElement;
  const btnNew = document.getElementById("btn-new-coupon");
  const btnCancel = document.getElementById("btn-cancel");
  const formError = document.getElementById("form-error") as HTMLElement;
  const btnSubmit = document.getElementById("btn-submit") as HTMLButtonElement;
  const btnText = document.getElementById("btn-text") as HTMLElement;
  const btnSpinner = document.getElementById("btn-spinner") as HTMLElement;

  btnNew?.addEventListener("click", () => {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    form.reset();
    formError.classList.add("hidden");
  });

  btnCancel?.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    btnSubmit.disabled = true;
    btnText.classList.add("hidden");
    btnSpinner.classList.remove("hidden");
    formError.classList.add("hidden");

    const formData = new FormData(form);
    const data: Record<string, any> = {};

    formData.forEach((value, key) => {
      if (value !== "") {
        data[key] = value;
      }
    });

    try {
      const response = await fetch("/api/admin/cupones", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Error al crear el cup√≥n");
      }

      showToast("Cup√≥n creado correctamente", "success");
      setTimeout(() => window.location.reload(), 500);
    } catch (error: any) {
      formError.textContent = error.message;
      formError.classList.remove("hidden");
      btnSubmit.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    }
  });

  // Edit modal
  const editModal = document.getElementById("edit-modal") as HTMLElement;
  const editForm = document.getElementById("edit-form") as HTMLFormElement;
  const btnEditCancel = document.getElementById("btn-edit-cancel");
  const editFormError = document.getElementById(
    "edit-form-error",
  ) as HTMLElement;
  const btnEditSubmit = document.getElementById(
    "btn-edit-submit",
  ) as HTMLButtonElement;
  const btnEditText = document.getElementById("btn-edit-text") as HTMLElement;
  const btnEditSpinner = document.getElementById(
    "btn-edit-spinner",
  ) as HTMLElement;

  document.querySelectorAll(".edit-coupon-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const couponData = JSON.parse(btn.getAttribute("data-coupon") || "{}");

      // Populate form
      (editForm.querySelector('[name="id"]') as HTMLInputElement).value =
        couponData.id;
      (
        editForm.querySelector('[name="code_display"]') as HTMLInputElement
      ).value = couponData.code;
      (
        editForm.querySelector('[name="discount_display"]') as HTMLInputElement
      ).value =
        couponData.discount_type === "percentage"
          ? `${couponData.discount_value}%`
          : `${couponData.discount_value}‚Ç¨`;
      (
        editForm.querySelector(
          '[name="min_purchase_amount"]',
        ) as HTMLInputElement
      ).value = couponData.min_purchase_amount || "";
      (
        editForm.querySelector(
          '[name="max_discount_amount"]',
        ) as HTMLInputElement
      ).value = couponData.max_discount_amount || "";
      (editForm.querySelector('[name="max_uses"]') as HTMLInputElement).value =
        couponData.max_uses || "";
      (
        editForm.querySelector(
          '[name="max_uses_per_customer"]',
        ) as HTMLInputElement
      ).value = couponData.max_uses_per_customer || 1;

      // Format dates for datetime-local input
      if (couponData.start_date) {
        const startDate = new Date(couponData.start_date);
        (
          editForm.querySelector('[name="start_date"]') as HTMLInputElement
        ).value = startDate.toISOString().slice(0, 16);
      }
      if (couponData.end_date) {
        const endDate = new Date(couponData.end_date);
        (
          editForm.querySelector('[name="end_date"]') as HTMLInputElement
        ).value = endDate.toISOString().slice(0, 16);
      }

      editModal.classList.remove("hidden");
      editModal.classList.add("flex");
      editFormError.classList.add("hidden");
    });
  });

  btnEditCancel?.addEventListener("click", () => {
    editModal.classList.add("hidden");
    editModal.classList.remove("flex");
  });

  editModal?.addEventListener("click", (e) => {
    if (e.target === editModal) {
      editModal.classList.add("hidden");
      editModal.classList.remove("flex");
    }
  });

  editForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    btnEditSubmit.disabled = true;
    btnEditText.classList.add("hidden");
    btnEditSpinner.classList.remove("hidden");
    editFormError.classList.add("hidden");

    const formData = new FormData(editForm);
    const data: Record<string, any> = {
      id: formData.get("id"),
    };

    // Only include editable fields
    const editableFields = [
      "min_purchase_amount",
      "max_discount_amount",
      "start_date",
      "end_date",
      "max_uses",
      "max_uses_per_customer",
    ];
    editableFields.forEach((field) => {
      const value = formData.get(field);
      if (value !== "") {
        data[field] = value;
      }
    });

    try {
      const response = await fetch("/api/admin/cupones", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Error al actualizar el cup√≥n");
      }

      showToast("Cup√≥n actualizado correctamente", "success");
      setTimeout(() => window.location.reload(), 500);
    } catch (error: any) {
      editFormError.textContent = error.message;
      editFormError.classList.remove("hidden");
      btnEditSubmit.disabled = false;
      btnEditText.classList.remove("hidden");
      btnEditSpinner.classList.add("hidden");
    }
  });

  // Toggle status
  document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");
      const isActive = btn.getAttribute("data-active") === "true";

      try {
        const response = await fetch("/api/admin/cupones", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, is_active: !isActive }),
        });

        if (response.ok) {
          showToast(
            `Cup√≥n ${isActive ? "desactivado" : "activado"}`,
            "success",
          );
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast("Error al cambiar estado", "error");
        }
      } catch (error) {
        console.error("Error toggling status:", error);
        showToast("Error al cambiar estado", "error");
      }
    });
  });

  // Delete modal
  const deleteModal = document.getElementById("delete-modal") as HTMLElement;
  const deleteCode = document.getElementById("delete-code") as HTMLElement;
  const cancelDelete = document.getElementById("cancel-delete");
  const confirmDelete = document.getElementById("confirm-delete");
  let couponToDelete: string | null = null;

  document.querySelectorAll(".delete-coupon-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      couponToDelete = btn.getAttribute("data-id");
      const code = btn.getAttribute("data-code");
      deleteCode.textContent = code || "";
      deleteModal.classList.remove("hidden");
      deleteModal.classList.add("flex");
    });
  });

  cancelDelete?.addEventListener("click", () => {
    deleteModal.classList.add("hidden");
    deleteModal.classList.remove("flex");
    couponToDelete = null;
  });

  deleteModal?.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
      deleteModal.classList.add("hidden");
      deleteModal.classList.remove("flex");
      couponToDelete = null;
    }
  });

  confirmDelete?.addEventListener("click", async () => {
    if (!couponToDelete) return;

    try {
      const response = await fetch("/api/admin/cupones", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: couponToDelete }),
      });

      if (response.ok) {
        showToast("Cup√≥n eliminado correctamente", "success");
        setTimeout(() => window.location.reload(), 500);
      } else {
        showToast("Error al eliminar cup√≥n", "error");
      }
    } catch (error) {
      console.error("Error deleting coupon:", error);
      showToast("Error al eliminar cup√≥n", "error");
    }
  });
</script>

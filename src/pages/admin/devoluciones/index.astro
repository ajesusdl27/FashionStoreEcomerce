---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createAuthenticatedClient } from "@/lib/supabase";
import { formatOrderId } from "@/lib/order-utils";

// Get authenticated client for RLS compliance
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch returns with related data
const { data: returns, error: _error } = await authClient
  .from("returns")
  .select(
    `
    *,
    orders:order_id (
      id,
      order_number,
      customer_name,
      customer_email,
      total_amount
    )
  `,
  )
  .order("created_at", { ascending: false });

const formatDate = (date: string | null) => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const getStatusBadge = (
  status: string,
): { bg: string; text: string; label: string } => {
  const defaultBadge = {
    bg: "bg-gray-500/10",
    text: "text-gray-500",
    label: "Desconocido",
  };
  const badges: { [key: string]: { bg: string; text: string; label: string } } =
    {
      requested: {
        bg: "bg-amber-500/10",
        text: "text-amber-500",
        label: "Pendiente",
      },
      approved: {
        bg: "bg-blue-500/10",
        text: "text-blue-500",
        label: "Aprobada",
      },
      shipped: {
        bg: "bg-purple-500/10",
        text: "text-purple-500",
        label: "Enviada",
      },
      received: {
        bg: "bg-cyan-500/10",
        text: "text-cyan-500",
        label: "En revisión",
      },
      completed: {
        bg: "bg-emerald-500/10",
        text: "text-emerald-500",
        label: "Completada",
      },
      rejected: {
        bg: "bg-red-500/10",
        text: "text-red-500",
        label: "Rechazada",
      },
    };
  return badges[status] ?? defaultBadge;
};

// Filter params
const statusFilter = Astro.url.searchParams.get("status") || "all";
const filteredReturns =
  statusFilter === "all"
    ? returns
    : returns?.filter((r: any) => r.status === statusFilter);

const statusCounts = {
  all: returns?.length || 0,
  requested: returns?.filter((r: any) => r.status === "requested").length || 0,
  approved: returns?.filter((r: any) => r.status === "approved").length || 0,
  received: returns?.filter((r: any) => r.status === "received").length || 0,
  completed: returns?.filter((r: any) => r.status === "completed").length || 0,
};
---

<AdminLayout title="Devoluciones">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <h1 class="font-heading text-2xl text-foreground">
          Gestión de Devoluciones
        </h1>
        <p class="text-sm text-muted-foreground mt-1">
          Administra las solicitudes de devolución de los clientes
        </p>
      </div>
    </div>

    <!-- Status Tabs -->
    <div class="flex flex-wrap gap-2">
      <a
        href="/admin/devoluciones"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          statusFilter === "all"
            ? "bg-primary text-primary-foreground"
            : "bg-muted hover:bg-muted/80 text-muted-foreground"
        }`}
      >
        Todas ({statusCounts.all})
      </a>
      <a
        href="/admin/devoluciones?status=requested"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          statusFilter === "requested"
            ? "bg-amber-500 text-white"
            : "bg-amber-500/10 hover:bg-amber-500/20 text-amber-500"
        }`}
      >
        Pendientes ({statusCounts.requested})
      </a>
      <a
        href="/admin/devoluciones?status=approved"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          statusFilter === "approved"
            ? "bg-blue-500 text-white"
            : "bg-blue-500/10 hover:bg-blue-500/20 text-blue-500"
        }`}
      >
        Aprobadas ({statusCounts.approved})
      </a>
      <a
        href="/admin/devoluciones?status=received"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          statusFilter === "received"
            ? "bg-cyan-500 text-white"
            : "bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-500"
        }`}
      >
        En revisión ({statusCounts.received})
      </a>
      <a
        href="/admin/devoluciones?status=completed"
        class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
          statusFilter === "completed"
            ? "bg-emerald-500 text-white"
            : "bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-500"
        }`}
      >
        Completadas ({statusCounts.completed})
      </a>
    </div>

    <!-- Returns Table -->
    <div class="admin-card">
      {
        filteredReturns && filteredReturns.length > 0 ? (
          <div class="overflow-x-auto -mx-6">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID Devolución</th>
                  <th>Cliente</th>
                  <th>Pedido</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                  <th class="text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {filteredReturns.map((returnItem: any) => {
                  const badge = getStatusBadge(returnItem.status);
                  return (
                    <tr>
                      <td>
                        <span class="font-mono text-sm">
                          #{returnItem.id.slice(0, 8).toUpperCase()}
                        </span>
                      </td>
                      <td>
                        <div>
                          <p class="font-medium">
                            {returnItem.orders?.customer_name}
                          </p>
                          <p class="text-xs text-muted-foreground">
                            {returnItem.orders?.customer_email}
                          </p>
                        </div>
                      </td>
                      <td>
                        <a
                          href={`/admin/pedidos/${returnItem.order_id}`}
                          class="text-primary hover:underline font-mono text-sm"
                        >
                          {returnItem.orders?.order_number
                            ? formatOrderId(returnItem.orders.order_number)
                            : `#${returnItem.order_id.slice(0, 8).toUpperCase()}`}
                        </a>
                      </td>
                      <td>
                        <span class={`badge ${badge.bg} ${badge.text}`}>
                          {badge.label}
                        </span>
                      </td>
                      <td class="text-sm text-muted-foreground">
                        {formatDate(returnItem.created_at)}
                      </td>
                      <td class="text-right">
                        <a
                          href={`/admin/devoluciones/${returnItem.id}`}
                          class="admin-btn admin-btn-sm"
                        >
                          Ver detalles
                        </a>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="text-center py-12 text-muted-foreground">
            <svg
              class="w-16 h-16 mx-auto mb-4 opacity-50"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
              />
            </svg>
            <p class="font-medium">No hay devoluciones</p>
            <p class="text-sm mt-1">
              {statusFilter === "all"
                ? "Aún no se han solicitado devoluciones"
                : `No hay devoluciones con estado "${getStatusBadge(statusFilter).label}"`}
            </p>
          </div>
        )
      }
    </div>
  </div>
</AdminLayout>

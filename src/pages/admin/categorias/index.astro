---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createAuthenticatedClient } from "@/lib/supabase";
import { Plus, Tag, Edit2, Trash2, ExternalLink } from "lucide-react";

// Get authenticated client for RLS compliance
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch categories with product count
const { data: categories, error } = await authClient
  .from("categories")
  .select(
    `
    *,
    products:products(count)
  `,
  )
  .order("name");

const categoriesWithCount = categories?.map((cat: any) => ({
  ...cat,
  productCount: cat.products?.[0]?.count || 0,
}));
---

<AdminLayout title="Categorías">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <p class="text-muted-foreground">
        {categories?.length || 0} categorías
      </p>
      <button
        id="new-category-btn"
        class="admin-btn-primary flex items-center gap-2"
      >
        <Plus className="w-5 h-5" />
        Nueva Categoría
      </button>
    </div>

    {
      error && (
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-600 dark:text-red-400">
          Error: {error.message}
        </div>
      )
    }

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {
        categoriesWithCount && categoriesWithCount.length > 0 ? (
          categoriesWithCount.map((cat: any) => (
            <div
              class="bg-card hover:bg-muted/50 border border-border rounded-xl p-5 transition-all group"
              data-id={cat.id}
            >
              <div class="flex items-start justify-between mb-4">
                {/* Category Icon */}
                <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                  <Tag className="w-6 h-6 text-primary" />
                </div>

                {/* Actions */}
                <div class="flex items-center gap-1 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                  <button
                    class="edit-category p-2 rounded-lg hover:bg-muted transition-colors"
                    title="Editar"
                    data-id={cat.id}
                    data-name={cat.name}
                    data-slug={cat.slug}
                    data-size-type={cat.size_type || "clothing"}
                  >
                    <Edit2 className="w-4 h-4 text-muted-foreground" />
                  </button>
                  <button
                    class="delete-category p-2 rounded-lg hover:bg-red-500/10 transition-colors"
                    title="Eliminar"
                    data-id={cat.id}
                    data-name={cat.name}
                    data-count={cat.productCount}
                  >
                    <Trash2 className="w-4 h-4 text-red-600 dark:text-red-400" />
                  </button>
                  <a
                    href={`/categoria/${cat.slug}`}
                    target="_blank"
                    class="p-2 rounded-lg hover:bg-muted transition-colors"
                    title="Ver en tienda"
                  >
                    <ExternalLink className="w-4 h-4 text-muted-foreground" />
                  </a>
                </div>
              </div>

              {/* Category Info */}
              <h3 class="font-semibold text-lg text-foreground mb-1">
                {cat.name}
              </h3>
              <p class="text-sm text-muted-foreground mb-3">/{cat.slug}</p>

              {/* Product Count */}
              <div class="flex items-center gap-2 flex-wrap">
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-muted text-muted-foreground">
                  {cat.productCount} producto{cat.productCount !== 1 ? "s" : ""}
                </span>
                <span
                  class:list={[
                    "inline-flex items-center px-2 py-1 rounded-md text-xs font-medium",
                    cat.size_type === "footwear"
                      ? "bg-blue-500/20 text-blue-600 dark:text-blue-400"
                      : cat.size_type === "universal"
                        ? "bg-purple-500/20 text-purple-600 dark:text-purple-400"
                        : "bg-green-500/20 text-green-600 dark:text-green-400",
                  ]}
                >
                  {cat.size_type === "footwear"
                    ? "Calzado"
                    : cat.size_type === "universal"
                      ? "Única"
                      : "Ropa"}
                </span>
              </div>
            </div>
          ))
        ) : (
          <div class="col-span-full text-center py-12 text-muted-foreground bg-muted/30 rounded-lg border border-border">
            <Tag className="w-16 h-16 mx-auto mb-4 opacity-30" />
            <p>No hay categorías todavía</p>
          </div>
        )
      }
    </div>
  </div>

  <!-- Category Modal -->
  <div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div
      class="absolute inset-0 bg-background/80 backdrop-blur-sm"
      id="modal-backdrop"
    >
    </div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div
        class="bg-card border border-border rounded-2xl max-w-md w-full shadow-2xl"
      >
        <!-- Modal Header -->
        <div
          class="flex items-center justify-between p-6 border-b border-border"
        >
          <h3 id="modal-title" class="font-heading text-xl text-foreground">
            Nueva Categoría
          </h3>
          <button
            type="button"
            id="close-modal-x"
            class="p-2 rounded-lg hover:bg-muted transition-colors text-muted-foreground hover:text-foreground"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <form id="category-form" class="p-6 space-y-5">
          <input type="hidden" id="category-id" value="" />

          <!-- Name Field -->
          <div>
            <label
              for="category-name"
              class="block text-sm font-medium text-foreground mb-2"
            >
              Nombre <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="category-name"
              required
              class="admin-input w-full"
              placeholder="Ej: Camisetas"
            />
          </div>

          <!-- Slug Field -->
          <div>
            <label
              for="category-slug"
              class="block text-sm font-medium text-foreground mb-2"
            >
              Slug (URL) <span class="text-red-500">*</span>
              <span
                class="ml-1 text-muted-foreground cursor-help"
                title="El slug es la parte de la URL que identifica esta categoría. Ejemplo: /categoria/camisetas"
              >
                <svg
                  class="w-4 h-4 inline -mt-0.5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </span>
            </label>
            <div class="relative">
              <span
                class="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground"
                >/</span
              >
              <input
                type="text"
                id="category-slug"
                required
                class="admin-input w-full pl-8"
                placeholder="camisetas"
              />
            </div>
            <label class="flex items-center gap-2 mt-2 cursor-pointer group">
              <input
                type="checkbox"
                id="auto-slug"
                checked
                class="w-4 h-4 rounded border-input bg-background text-primary focus:ring-primary focus:ring-offset-0"
              />
              <span
                class="text-xs text-muted-foreground group-hover:text-foreground transition-colors"
                >Auto-generar desde nombre</span
              >
            </label>
            <p class="text-xs text-muted-foreground mt-2">
              URL: <span class="font-mono text-primary">/categoria/</span><span
                id="slug-value"
                class="font-mono text-primary">...</span
              >
            </p>
          </div>

          <!-- Size Type Field -->
          <div>
            <label
              for="category-size-type"
              class="block text-sm font-medium text-foreground mb-2"
            >
              Tipo de Tallas
            </label>
            <select id="category-size-type" class="admin-select w-full">
              <option value="clothing">Ropa (XXS - XXL)</option>
              <option value="footwear">Calzado (36 - 46)</option>
              <option value="universal">Talla Única</option>
            </select>
            <p class="text-xs text-muted-foreground mt-1.5">
              Define qué tallas estarán disponibles para productos de esta
              categoría
            </p>
          </div>

          <!-- Error Message -->
          <div
            id="form-error"
            class="hidden p-3 bg-red-500/10 border border-red-500/30 text-red-600 dark:text-red-400 rounded-lg text-sm"
          >
          </div>

          <!-- Actions -->
          <div class="flex justify-end gap-3 pt-2">
            <button
              type="button"
              id="cancel-modal"
              class="px-5 py-2.5 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground transition-all"
            >
              Cancelar
            </button>
            <button
              type="submit"
              id="save-category"
              class="px-5 py-2.5 rounded-lg bg-primary text-primary-foreground font-medium hover:shadow-[0_0_20px_rgba(204,255,0,0.3)] transition-all"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="admin-card max-w-md w-full">
        <h3 class="font-heading text-xl mb-4">¿Eliminar categoría?</h3>
        <p class="text-muted-foreground mb-2">
          Vas a eliminar: <strong class="text-foreground" id="delete-name"
          ></strong>
        </p>
        <p id="delete-warning" class="text-sm text-muted-foreground mb-4"></p>
        <div
          id="delete-error"
          class="hidden p-3 mb-4 bg-red-500/10 border border-red-500/30 text-red-600 dark:text-red-400 rounded-lg text-sm"
        >
        </div>
        <input type="hidden" id="delete-id" />
        <div class="flex justify-end gap-3">
          <button id="cancel-delete" class="admin-btn-secondary">
            Cancelar
          </button>
          <button id="confirm-delete" class="admin-btn-danger">
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById("category-modal");
    const deleteModal = document.getElementById("delete-modal");
    const modalTitle = document.getElementById("modal-title");
    const categoryIdInput = document.getElementById(
      "category-id",
    ) as HTMLInputElement;
    const categoryNameInput = document.getElementById(
      "category-name",
    ) as HTMLInputElement;
    const categorySlugInput = document.getElementById(
      "category-slug",
    ) as HTMLInputElement;
    const categorySizeTypeSelect = document.getElementById(
      "category-size-type",
    ) as HTMLSelectElement;
    const formError = document.getElementById("form-error");
    const autoSlugCheckbox = document.getElementById(
      "auto-slug",
    ) as HTMLInputElement;
    const saveBtn = document.getElementById(
      "save-category",
    ) as HTMLButtonElement;
    const deleteWarning = document.getElementById("delete-warning");
    const deleteError = document.getElementById("delete-error");
    const slugPreview = document.getElementById("slug-value");

    // Toast helper
    function showToast(message: string, type: "success" | "error" = "success") {
      const toast = document.createElement("div");
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in ${
        type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
      }`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${
            type === "success"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
              : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
          }
        </svg>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.3s";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Auto-generate slug (respects checkbox)
    categoryNameInput?.addEventListener("input", () => {
      if (autoSlugCheckbox?.checked) {
        const slug = categoryNameInput.value
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-|-$/g, "");
        categorySlugInput.value = slug;
      }
      // Update slug preview
      if (slugPreview) {
        slugPreview.textContent = categorySlugInput.value || "...";
      }
    });

    // Update slug preview on direct input
    categorySlugInput?.addEventListener("input", () => {
      if (slugPreview) {
        slugPreview.textContent = categorySlugInput.value || "...";
      }
    });

    // Open new category modal
    document
      .getElementById("new-category-btn")
      ?.addEventListener("click", () => {
        if (modalTitle) modalTitle.textContent = "Nueva Categoría";
        categoryIdInput.value = "";
        categoryNameInput.value = "";
        categorySlugInput.value = "";
        categorySizeTypeSelect.value = "clothing";
        autoSlugCheckbox.checked = true;
        formError?.classList.add("hidden");
        if (slugPreview) slugPreview.textContent = "...";
        modal?.classList.remove("hidden");
      });

    // Open edit modal
    document.querySelectorAll(".edit-category").forEach((btn) => {
      btn.addEventListener("click", () => {
        const { id, name, slug, sizeType } = (btn as HTMLElement).dataset;
        if (modalTitle) modalTitle.textContent = "Editar Categoría";
        categoryIdInput.value = id || "";
        categoryNameInput.value = name || "";
        categorySlugInput.value = slug || "";
        categorySizeTypeSelect.value = sizeType || "clothing";
        autoSlugCheckbox.checked = false; // Uncheck for editing to preserve existing slug
        formError?.classList.add("hidden");
        if (slugPreview) slugPreview.textContent = slug || "...";
        modal?.classList.remove("hidden");
      });
    });

    // Close modal
    document.getElementById("cancel-modal")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });
    document.getElementById("modal-backdrop")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });
    document.getElementById("close-modal-x")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });

    // Save category
    document
      .getElementById("category-form")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();
        formError?.classList.add("hidden");

        const id = categoryIdInput.value;
        const data = {
          name: categoryNameInput.value,
          slug: categorySlugInput.value,
          size_type: categorySizeTypeSelect.value,
        };

        // Show loading state
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `
          <svg class="animate-spin w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Guardando...
        `;

        try {
          const response = await fetch("/api/admin/categorias", {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(id ? { id, ...data } : data),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Error al guardar");
          }

          showToast(
            id ? "Categoría actualizada" : "Categoría creada",
            "success",
          );
          setTimeout(() => window.location.reload(), 800);
        } catch (error: any) {
          // Reset button
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalContent;

          if (formError) {
            formError.textContent = error.message;
            formError.classList.remove("hidden");
          }
        }
      });

    // Delete modal - show product count warning
    document.querySelectorAll(".delete-category").forEach((btn) => {
      btn.addEventListener("click", () => {
        const { id, name, count } = (btn as HTMLElement).dataset;
        const productCount = parseInt(count || "0");

        (document.getElementById("delete-id") as HTMLInputElement).value =
          id || "";
        (document.getElementById("delete-name") as HTMLElement).textContent =
          name || "";

        // Dynamic warning based on product count
        if (deleteWarning) {
          const triangle = `<svg class="w-4 h-4 inline-block text-yellow-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
          deleteWarning.innerHTML =
            productCount > 0
              ? `${triangle} ${productCount} producto${productCount !== 1 ? "s" : ""} quedará${productCount !== 1 ? "n" : ""} sin categoría.`
              : "Esta categoría no tiene productos asociados.";
        }

        // Hide previous errors
        deleteError?.classList.add("hidden");

        deleteModal?.classList.remove("hidden");
      });
    });

    document.getElementById("cancel-delete")?.addEventListener("click", () => {
      deleteModal?.classList.add("hidden");
    });

    document
      .getElementById("confirm-delete")
      ?.addEventListener("click", async () => {
        const id = (document.getElementById("delete-id") as HTMLInputElement)
          .value;
        const confirmBtn = document.getElementById(
          "confirm-delete",
        ) as HTMLButtonElement;

        // Show loading state
        const originalContent = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `
          <svg class="animate-spin w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Eliminando...
        `;

        try {
          const response = await fetch("/api/admin/categorias", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          if (response.ok) {
            showToast("Categoría eliminada", "success");
            setTimeout(() => window.location.reload(), 800);
          } else {
            const result = await response.json();
            throw new Error(result.error || "Error al eliminar");
          }
        } catch (error: any) {
          // Reset button
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalContent;

          // Show inline error instead of alert
          if (deleteError) {
            deleteError.textContent = error.message;
            deleteError.classList.remove("hidden");
          }
        }
      });
  </script>
</AdminLayout>

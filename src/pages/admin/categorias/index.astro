---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createAuthenticatedClient } from "@/lib/supabase";
import { Plus, Tag, Edit2, Trash2, ExternalLink } from "lucide-react";

// Get authenticated client for RLS compliance
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch categories with product count
const { data: categories, error } = await authClient
  .from("categories")
  .select(
    `
    *,
    products:products(count)
  `,
  )
  .order("display_order", { ascending: true })
  .order("name", { ascending: true });

const categoriesWithCount = categories?.map((cat: any) => ({
  ...cat,
  productCount: cat.products?.[0]?.count || 0,
}));
---

<AdminLayout title="Categor칤as">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <p class="text-muted-foreground">
        {categories?.length || 0} categor칤as
      </p>
      <button
        id="new-category-btn"
        class="admin-btn-primary flex items-center gap-2"
      >
        <Plus className="w-5 h-5" />
        Nueva Categor칤a
      </button>
    </div>

    {
      error && (
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-600 dark:text-red-400">
          Error: {error.message}
        </div>
      )
    }

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {
        categoriesWithCount && categoriesWithCount.length > 0 ? (
          categoriesWithCount.map((cat: any) => (
            <div
              class="bg-card hover:bg-muted/50 border border-border rounded-xl p-5 transition-all group"
              data-id={cat.id}
            >
              <div class="flex items-start justify-between mb-4">
                {/* Category Icon */}
                <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
                  <Tag className="w-6 h-6 text-primary" />
                </div>

                {/* Actions */}
                <div class="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                  <button
                    class="edit-category p-2 rounded-lg hover:bg-muted transition-colors"
                    title="Editar"
                    data-id={cat.id}
                    data-name={cat.name}
                    data-slug={cat.slug}
                    data-size-type={cat.size_type || "clothing"}
                    data-description={cat.description || ""}
                    data-color-theme={cat.color_theme || "default"}
                    data-featured={cat.featured || false}
                    data-display-order={cat.display_order || 0}
                  >
                    <Edit2 className="w-4 h-4 text-muted-foreground" />
                  </button>
                  <button
                    class="delete-category p-2 rounded-lg hover:bg-red-500/10 transition-colors"
                    title="Eliminar"
                    data-id={cat.id}
                    data-name={cat.name}
                    data-count={cat.productCount}
                  >
                    <Trash2 className="w-4 h-4 text-red-600 dark:text-red-400" />
                  </button>
                  <a
                    href={`/categoria/${cat.slug}`}
                    target="_blank"
                    class="p-2 rounded-lg hover:bg-muted transition-colors"
                    title="Ver en tienda"
                  >
                    <ExternalLink className="w-4 h-4 text-muted-foreground" />
                  </a>
                </div>
              </div>

              {/* Category Info */}
              <h3 class="font-semibold text-lg text-foreground mb-1">
                {cat.name}
              </h3>
              <p class="text-sm text-muted-foreground mb-3">/{cat.slug}</p>

              {/* Product Count */}
              <div class="flex items-center gap-2 flex-wrap">
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-muted text-muted-foreground">
                  {cat.productCount} producto{cat.productCount !== 1 ? "s" : ""}
                </span>
                <span
                  class:list={[
                    "inline-flex items-center px-2 py-1 rounded-md text-xs font-medium",
                    cat.size_type === "footwear"
                      ? "bg-blue-500/20 text-blue-600 dark:text-blue-400"
                      : cat.size_type === "universal"
                        ? "bg-purple-500/20 text-purple-600 dark:text-purple-400"
                        : "bg-green-500/20 text-green-600 dark:text-green-400",
                  ]}
                >
                  {cat.size_type === "footwear"
                    ? "Calzado"
                    : cat.size_type === "universal"
                      ? "칔nica"
                      : "Ropa"}
                </span>
              </div>
            </div>
          ))
        ) : (
          <div class="col-span-full text-center py-12 text-muted-foreground bg-muted/30 rounded-lg border border-border">
            <Tag className="w-16 h-16 mx-auto mb-4 opacity-30" />
            <p>No hay categor칤as todav칤a</p>
          </div>
        )
      }
    </div>
  </div>

  <!-- Category Modal -->
  <div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div
      class="absolute inset-0 bg-black/60 backdrop-blur-sm"
      id="modal-backdrop"
    >
    </div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div
        class="bg-card border border-border rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl"
      >
        <!-- Modal Header -->
        <div
          class="flex items-center justify-between p-6 border-b border-border bg-gradient-to-r from-primary/5 to-primary/10"
        >
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
              </svg>
            </div>
            <div>
              <h3 id="modal-title" class="font-heading text-xl text-foreground">
                Nueva Categor칤a
              </h3>
              <p class="text-sm text-muted-foreground">Organiza tus productos por categor칤as</p>
            </div>
          </div>
          <button
            type="button"
            id="close-modal-x"
            class="p-2 rounded-lg hover:bg-muted transition-colors text-muted-foreground hover:text-foreground"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <form id="category-form" class="p-6 space-y-6">
          <input type="hidden" id="category-id" value="" />

          <!-- Basic Information Section -->
          <div class="space-y-4">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                <span class="text-primary text-sm font-bold">1</span>
              </div>
              <h4 class="font-medium text-foreground">Informaci칩n B치sica</h4>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Name Field -->
              <div class="md:col-span-2">
                <label
                  for="category-name"
                  class="block text-sm font-medium text-foreground mb-2"
                >
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    Nombre de la Categor칤a
                    <span class="text-red-500">*</span>
                  </span>
                </label>
                <input
                  type="text"
                  id="category-name"
                  required
                  class="admin-input w-full text-lg"
                  placeholder="Ej: Camisetas y Tops"
                />
                <p class="text-xs text-muted-foreground mt-1">Nombre que ver치n los clientes en la tienda</p>
              </div>

              <!-- Slug Field -->
              <div class="md:col-span-2">
                <label
                  for="category-slug"
                  class="block text-sm font-medium text-foreground mb-2"
                >
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    URL de la Categor칤a
                    <span class="text-red-500">*</span>
                    <span
                      class="ml-1 text-muted-foreground cursor-help"
                      title="El slug es la parte de la URL que identifica esta categor칤a. Ejemplo: /categoria/camisetas-y-tops"
                    >
                      <svg
                        class="w-4 h-4 inline"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                      </svg>
                    </span>
                  </span>
                </label>
                <div class="relative">
                  <span
                    class="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground font-mono text-sm"
                    >/categoria/</span
                  >
                  <input
                    type="text"
                    id="category-slug"
                    required
                    class="admin-input w-full pl-20 font-mono"
                    placeholder="camisetas-y-tops"
                  />
                </div>
                <div class="mt-2 space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      id="auto-slug"
                      checked
                      class="w-4 h-4 rounded border-input bg-background text-primary focus:ring-primary focus:ring-offset-0"
                    />
                    <span
                      class="text-xs text-muted-foreground group-hover:text-foreground transition-colors"
                      >Auto-generar desde nombre</span
                    >
                  </label>
                  <div class="p-2 bg-muted/30 rounded-lg border border-border">
                    <p class="text-xs text-muted-foreground">
                      Vista previa: <span class="font-mono text-primary">/categoria/</span><span
                        id="slug-value"
                        class="font-mono text-primary">...</span
                      >
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Configuration Section -->
          <div class="space-y-4">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                <span class="text-primary text-sm font-bold">2</span>
              </div>
              <h4 class="font-medium text-foreground">Configuraci칩n</h4>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Size Type Field -->
              <div>
                <label
                  for="category-size-type"
                  class="block text-sm font-medium text-foreground mb-2"
                >
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m0 0V1m0 2h2m0 0V1m0 2h2m0 0V1m0 2h4a1 1 0 011 1v4M3 12h18m-9 4h.01M8 16h.01M16 16h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Tipo de Tallas
                  </span>
                </label>
                <select id="category-size-type" class="admin-select w-full">
                  <option value="clothing">游녯 Ropa (XXS - XXL)</option>
                  <option value="footwear">游 Calzado (36 - 46)</option>
                  <option value="universal">游닍 Talla 칔nica</option>
                </select>
                <p class="text-xs text-muted-foreground mt-1.5">
                  Define qu칠 tallas estar치n disponibles para productos
                </p>
              </div>

              <!-- Color Theme Field -->
              <div>
                <label
                  for="category-color-theme"
                  class="block text-sm font-medium text-foreground mb-2"
                >
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"/>
                    </svg>
                    Tema de Color
                  </span>
                </label>
                <select id="category-color-theme" class="admin-select w-full">
                  <option value="default">游댖 Por defecto (Gris)</option>
                  <option value="blue">游댯 Azul</option>
                  <option value="green">游릭 Verde</option>
                  <option value="purple">游릮 Morado</option>
                  <option value="orange">游 Naranja</option>
                  <option value="red">游댮 Rojo</option>
                  <option value="pink">游뽕 Rosa</option>
                  <option value="yellow">游리 Amarillo</option>
                </select>
                <p class="text-xs text-muted-foreground mt-1.5">
                  Color para el fondo y gradientes de la categor칤a
                </p>
              </div>
            </div>

            <!-- Description Field -->
            <div>
              <label
                for="category-description"
                class="block text-sm font-medium text-foreground mb-2"
              >
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                  </svg>
                  Descripci칩n
                </span>
              </label>
              <textarea
                id="category-description"
                rows="3"
                class="admin-input w-full resize-none"
                placeholder="Ej: Encuentra tu estilo perfecto con nuestra colecci칩n de camisetas y tops"
              ></textarea>
              <p class="text-xs text-muted-foreground mt-1.5">
                Descripci칩n breve que aparecer치 en la tarjeta de la categor칤a
              </p>
            </div>
          </div>

          <!-- Display Settings Section -->
          <div class="space-y-4">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                <span class="text-primary text-sm font-bold">3</span>
              </div>
              <h4 class="font-medium text-foreground">Configuraci칩n de Visualizaci칩n</h4>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Featured Field -->
              <div class="p-4 border border-border rounded-lg bg-muted/20">
                <label class="flex items-center gap-3 cursor-pointer group">
                  <input
                    type="checkbox"
                    id="category-featured"
                    class="w-5 h-5 rounded border-input bg-background text-primary focus:ring-primary focus:ring-offset-0"
                  />
                  <div>
                    <span class="text-sm font-medium text-foreground group-hover:text-primary transition-colors flex items-center gap-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                      </svg>
                      Categor칤a Destacada
                    </span>
                    <p class="text-xs text-muted-foreground mt-1">
                      Se mostrar치 en la secci칩n principal de categor칤as destacadas
                    </p>
                  </div>
                </label>
              </div>

              <!-- Display Order Field -->
              <div>
                <label
                  for="category-display-order"
                  class="block text-sm font-medium text-foreground mb-2"
                >
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                    </svg>
                    Orden de Visualizaci칩n
                  </span>
                </label>
                <input
                  type="number"
                  id="category-display-order"
                  min="0"
                  step="1"
                  value="0"
                  class="admin-input w-full"
                  placeholder="0"
                />
                <p class="text-xs text-muted-foreground mt-1.5">
                  N칰mero menor aparece primero (0 = primera posici칩n)
                </p>
              </div>
            </div>
          </div>

          <!-- Error Message -->
          <div
            id="form-error"
            class="hidden p-3 bg-red-500/10 border border-red-500/30 text-red-600 dark:text-red-400 rounded-lg text-sm"
          >
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-border">
            <button
              type="button"
              id="cancel-modal"
              class="px-6 py-3 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground transition-all flex items-center justify-center gap-2"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Cancelar
            </button>
            <button
              type="submit"
              id="save-category"
              class="px-6 py-3 rounded-lg bg-primary text-primary-foreground font-medium hover:shadow-[0_0_20px_rgba(204,255,0,0.3)] transition-all flex items-center justify-center gap-2"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              <span id="save-btn-text">Guardar Categor칤a</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-card border border-border rounded-2xl max-w-md w-full shadow-2xl">
        <!-- Header -->
        <div class="p-6 border-b border-border">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div>
              <h3 class="font-heading text-xl text-foreground">Confirmar Eliminaci칩n</h3>
              <p class="text-sm text-muted-foreground">Esta acci칩n no se puede deshacer</p>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-4">
          <p class="text-muted-foreground">
            Vas a eliminar la categor칤a: <strong class="text-foreground" id="delete-name"></strong>
          </p>
          <div id="delete-warning" class="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg"></div>
          <div
            id="delete-error"
            class="hidden p-3 bg-red-500/10 border border-red-500/30 text-red-600 dark:text-red-400 rounded-lg text-sm"
          >
          </div>
          <input type="hidden" id="delete-id" />
        </div>

        <!-- Actions -->
        <div class="p-6 border-t border-border flex flex-col sm:flex-row justify-end gap-3">
          <button id="cancel-delete" class="px-6 py-3 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground transition-all flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancelar
          </button>
          <button id="confirm-delete" class="px-6 py-3 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-all flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            <span id="delete-btn-text">Eliminar Categor칤a</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById("category-modal");
    const deleteModal = document.getElementById("delete-modal");
    const modalTitle = document.getElementById("modal-title");
    const categoryIdInput = document.getElementById(
      "category-id",
    ) as HTMLInputElement;
    const categoryNameInput = document.getElementById(
      "category-name",
    ) as HTMLInputElement;
    const categorySlugInput = document.getElementById(
      "category-slug",
    ) as HTMLInputElement;
    const categorySizeTypeSelect = document.getElementById(
      "category-size-type",
    ) as HTMLSelectElement;
    const categoryDescriptionInput = document.getElementById(
      "category-description",
    ) as HTMLTextAreaElement;
    const categoryColorThemeSelect = document.getElementById(
      "category-color-theme",
    ) as HTMLSelectElement;
    const categoryFeaturedCheckbox = document.getElementById(
      "category-featured",
    ) as HTMLInputElement;
    const categoryDisplayOrderInput = document.getElementById(
      "category-display-order",
    ) as HTMLInputElement;
    const formError = document.getElementById("form-error");
    const autoSlugCheckbox = document.getElementById(
      "auto-slug",
    ) as HTMLInputElement;
    const saveBtn = document.getElementById(
      "save-category",
    ) as HTMLButtonElement;
    const deleteWarning = document.getElementById("delete-warning");
    const deleteError = document.getElementById("delete-error");
    const slugPreview = document.getElementById("slug-value");

    // Toast helper
    function showToast(message: string, type: "success" | "error" = "success") {
      const toast = document.createElement("div");
      toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in ${
        type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
      }`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${
            type === "success"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
              : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
          }
        </svg>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.3s";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Auto-generate slug (respects checkbox)
    categoryNameInput?.addEventListener("input", () => {
      if (autoSlugCheckbox?.checked) {
        const slug = categoryNameInput.value
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-|-$/g, "");
        categorySlugInput.value = slug;
      }
      // Update slug preview
      if (slugPreview) {
        slugPreview.textContent = categorySlugInput.value || "...";
      }
    });

    // Update slug preview on direct input
    categorySlugInput?.addEventListener("input", () => {
      if (slugPreview) {
        slugPreview.textContent = categorySlugInput.value || "...";
      }
    });

    // Open new category modal
    document
      .getElementById("new-category-btn")
      ?.addEventListener("click", () => {
        if (modalTitle) modalTitle.textContent = "Nueva Categor칤a";
        categoryIdInput.value = "";
        categoryNameInput.value = "";
        categorySlugInput.value = "";
        categorySizeTypeSelect.value = "clothing";
        categoryDescriptionInput.value = "";
        categoryColorThemeSelect.value = "default";
        categoryFeaturedCheckbox.checked = false;
        categoryDisplayOrderInput.value = "0";
        autoSlugCheckbox.checked = true;
        formError?.classList.add("hidden");
        if (slugPreview) slugPreview.textContent = "...";
        modal?.classList.remove("hidden");
      });

    // Open edit modal
    document.querySelectorAll(".edit-category").forEach((btn) => {
      btn.addEventListener("click", () => {
        const { 
          id, name, slug, sizeType, description, colorTheme, featured, displayOrder 
        } = (btn as HTMLElement).dataset;
        if (modalTitle) modalTitle.textContent = "Editar Categor칤a";
        categoryIdInput.value = id || "";
        categoryNameInput.value = name || "";
        categorySlugInput.value = slug || "";
        categorySizeTypeSelect.value = sizeType || "clothing";
        categoryDescriptionInput.value = description || "";
        categoryColorThemeSelect.value = colorTheme || "default";
        categoryFeaturedCheckbox.checked = featured === "true";
        categoryDisplayOrderInput.value = displayOrder || "0";
        autoSlugCheckbox.checked = false; // Uncheck for editing to preserve existing slug
        formError?.classList.add("hidden");
        if (slugPreview) slugPreview.textContent = slug || "...";
        modal?.classList.remove("hidden");
      });
    });

    // Close modal
    document.getElementById("cancel-modal")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });
    document.getElementById("modal-backdrop")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });
    document.getElementById("close-modal-x")?.addEventListener("click", () => {
      modal?.classList.add("hidden");
    });

    // Save category
    document
      .getElementById("category-form")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();
        formError?.classList.add("hidden");

        const id = categoryIdInput.value;
        const data = {
          name: categoryNameInput.value,
          slug: categorySlugInput.value,
          size_type: categorySizeTypeSelect.value,
          description: categoryDescriptionInput.value,
          icon_name: 'tag', // Valor por defecto
          color_theme: categoryColorThemeSelect.value,
          featured: categoryFeaturedCheckbox.checked,
          display_order: parseInt(categoryDisplayOrderInput.value) || 0,
        };

        // Show loading state
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `
          <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <span>Guardando...</span>
        `;

        try {
          const response = await fetch("/api/admin/categorias", {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(id ? { id, ...data } : data),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Error al guardar");
          }

          showToast(
            id ? "Categor칤a actualizada" : "Categor칤a creada",
            "success",
          );
          setTimeout(() => window.location.reload(), 800);
        } catch (error: any) {
          // Reset button
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalContent;

          if (formError) {
            formError.textContent = error.message;
            formError.classList.remove("hidden");
          }
        }
      });

    // Delete modal - show product count warning
    document.querySelectorAll(".delete-category").forEach((btn) => {
      btn.addEventListener("click", () => {
        const { id, name, count } = (btn as HTMLElement).dataset;
        const productCount = parseInt(count || "0");

        (document.getElementById("delete-id") as HTMLInputElement).value =
          id || "";
        (document.getElementById("delete-name") as HTMLElement).textContent =
          name || "";

        // Dynamic warning based on product count
        if (deleteWarning) {
          const triangle = `<svg class="w-4 h-4 inline-block text-yellow-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
          deleteWarning.innerHTML =
            productCount > 0
              ? `${triangle} ${productCount} producto${productCount !== 1 ? "s" : ""} quedar치${productCount !== 1 ? "n" : ""} sin categor칤a.`
              : "Esta categor칤a no tiene productos asociados.";
        }

        // Hide previous errors
        deleteError?.classList.add("hidden");

        deleteModal?.classList.remove("hidden");
      });
    });

    document.getElementById("cancel-delete")?.addEventListener("click", () => {
      deleteModal?.classList.add("hidden");
    });

    document
      .getElementById("confirm-delete")
      ?.addEventListener("click", async () => {
        const id = (document.getElementById("delete-id") as HTMLInputElement)
          .value;
        const confirmBtn = document.getElementById(
          "confirm-delete",
        ) as HTMLButtonElement;

        // Show loading state
        const originalContent = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `
          <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <span>Eliminando...</span>
        `;

        try {
          const response = await fetch("/api/admin/categorias", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          if (response.ok) {
            showToast("Categor칤a eliminada", "success");
            setTimeout(() => window.location.reload(), 800);
          } else {
            const result = await response.json();
            throw new Error(result.error || "Error al eliminar");
          }
        } catch (error: any) {
          // Reset button
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalContent;

          // Show inline error instead of alert
          if (deleteError) {
            deleteError.textContent = error.message;
            deleteError.classList.remove("hidden");
          }
        }
      });
  </script>
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";

// Fetch orders with pagination
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const limit = 20;
const offset = (page - 1) * limit;

const { data: orders, count } = await supabase
  .from("orders")
  .select("*", { count: "exact" })
  .order("created_at", { ascending: false })
  .range(offset, offset + limit - 1);

const totalPages = count ? Math.ceil(count / limit) : 0;

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const statusColors: Record<string, string> = {
  pending: "bg-yellow-500/20 text-yellow-400 border-yellow-500/50",
  paid: "bg-primary/20 text-primary border-primary/50",
  shipped: "bg-blue-500/20 text-blue-400 border-blue-500/50",
  delivered: "bg-green-500/20 text-green-400 border-green-500/50",
  cancelled: "bg-accent/20 text-accent border-accent/50",
};

const statusLabels: Record<string, string> = {
  pending: "Pendiente",
  paid: "Pagado",
  shipped: "Enviado",
  delivered: "Entregado",
  cancelled: "Cancelado",
};
---

<AdminLayout title="Pedidos">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-display text-3xl text-primary">Pedidos</h1>
        <p class="text-muted-foreground mt-1">{count || 0} pedidos en total</p>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="glass border border-border rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-muted/50 border-b border-border">
            <tr>
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Pedido</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Cliente</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Fecha</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Total</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Estado</th
              >
              <th
                class="text-right px-6 py-4 text-sm font-medium text-muted-foreground"
                >Acciones</th
              >
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {
              orders && orders.length > 0 ? (
                orders.map((order) => (
                  <tr class="hover:bg-muted/30 transition-colors">
                    <td class="px-6 py-4">
                      <span class="font-mono text-sm">
                        #{order.id.slice(0, 8)}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <div>
                        <p class="font-medium">{order.customer_name}</p>
                        <p class="text-sm text-muted-foreground">
                          {order.customer_email}
                        </p>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-muted-foreground">
                      {formatDate(order.created_at)}
                    </td>
                    <td class="px-6 py-4 font-medium">
                      {formatPrice(order.total_amount)}
                    </td>
                    <td class="px-6 py-4">
                      <span
                        class={`inline-block px-3 py-1 rounded-full text-xs font-medium border ${statusColors[order.status]}`}
                      >
                        {statusLabels[order.status]}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <a
                        href={`/admin/pedidos/${order.id}`}
                        class="inline-flex items-center gap-2 px-3 py-1.5 border border-border rounded-lg hover:bg-muted transition-colors text-sm"
                      >
                        Ver detalles
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                          />
                        </svg>
                      </a>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td
                    colspan="6"
                    class="px-6 py-12 text-center text-muted-foreground"
                  >
                    <svg
                      class="w-16 h-16 mx-auto mb-4 opacity-50"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                      />
                    </svg>
                    <p>No hay pedidos todavía</p>
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      {
        totalPages > 1 && (
          <div class="flex items-center justify-between px-6 py-4 border-t border-border">
            <p class="text-sm text-muted-foreground">
              Página {page} de {totalPages}
            </p>
            <div class="flex gap-2">
              {page > 1 && (
                <a
                  href={`/admin/pedidos?page=${page - 1}`}
                  class="px-4 py-2 border border-border rounded-lg hover:bg-muted transition-colors"
                >
                  Anterior
                </a>
              )}
              {page < totalPages && (
                <a
                  href={`/admin/pedidos?page=${page + 1}`}
                  class="px-4 py-2 border border-border rounded-lg hover:bg-muted transition-colors"
                >
                  Siguiente
                </a>
              )}
            </div>
          </div>
        )
      }
    </div>
  </div>
</AdminLayout>

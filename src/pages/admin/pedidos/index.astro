---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import OrdersList from "@/components/islands/admin/OrdersList";

// Fetch orders with pagination
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const statusFilter = Astro.url.searchParams.get("status") || "";
const limit = 20;
const offset = (page - 1) * limit;

let query = supabase
  .from("orders")
  .select("id, order_number, customer_name, customer_email, total_amount, status, created_at", { count: "exact" })
  .order("created_at", { ascending: false });

if (statusFilter) {
  query = query.eq("status", statusFilter);
}

const { data: orders, count, error } = await query.range(offset, offset + limit - 1);
---

<AdminLayout title="Pedidos">
  {error ? (
    <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-600 dark:text-red-400">
      Error cargando pedidos: {error.message}
    </div>
  ) : (
    <OrdersList
      client:load
      initialOrders={orders || []}
      totalCount={count || 0}
      currentPage={page}
      pageSize={limit}
      initialStatus={statusFilter}
    />
  )}
</AdminLayout>

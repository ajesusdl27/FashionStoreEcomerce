---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import { formatOrderId, parseOrderId } from "@/lib/order-utils";
import {
  ORDER_STATUS_CONFIG,
  ORDER_STATUS_OPTIONS,
} from "@/lib/constants/order-status";

// Fetch orders with pagination and search
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const statusFilter = Astro.url.searchParams.get("status") || "";
const searchQuery = Astro.url.searchParams.get("q") || "";
const limit = 20;
const offset = (page - 1) * limit;

let query = supabase
  .from("orders")
  .select("*, order_number", { count: "exact" })
  .order("created_at", { ascending: false });

if (statusFilter) {
  query = query.eq("status", statusFilter);
}

// Search by order number, customer name, or email
if (searchQuery) {
  const parsedOrderNum = parseOrderId(searchQuery);
  if (parsedOrderNum) {
    // Search by order number
    query = query.eq("order_number", parsedOrderNum);
  } else {
    // Search by customer name or email
    query = query.or(
      `customer_name.ilike.%${searchQuery}%,customer_email.ilike.%${searchQuery}%`
    );
  }
}

const { data: orders, count } = await query.range(offset, offset + limit - 1);

const totalPages = count ? Math.ceil(count / limit) : 0;

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

// Use shared status config
const statusConfig = ORDER_STATUS_CONFIG;
const statusOptions = ORDER_STATUS_OPTIONS;
---

<AdminLayout title="Pedidos">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
    >
      <p class="text-muted-foreground">{count || 0} pedidos en total</p>

      <div class="flex flex-col sm:flex-row gap-3">
        <!-- Search Input -->
        <form id="search-form" class="relative">
          <input
            type="text"
            name="q"
            id="search-input"
            placeholder="Buscar (#A000001, nombre, email...)"
            value={searchQuery}
            class="admin-input w-64 pl-10 pr-10"
          />
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          {
            searchQuery && (
              <button
                type="button"
                id="clear-search"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors"
                title="Limpiar búsqueda"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            )
          }
          {
            statusFilter && (
              <input type="hidden" name="status" value={statusFilter} />
            )
          }
        </form>

        <!-- Status Filter -->
        <select id="status-filter" class="admin-select w-48">
          {
            statusOptions.map((opt) => (
              <option value={opt.value} selected={statusFilter === opt.value}>
                {opt.label}
              </option>
            ))
          }
        </select>
      </div>
    </div>

    <!-- Active Search Badge -->
    {
      searchQuery && (
        <div class="flex items-center gap-2 text-sm">
          <span class="text-muted-foreground">Resultados para:</span>
          <span class="bg-primary/10 text-primary px-3 py-1 rounded-full font-medium">
            "{searchQuery}"
          </span>
          <a
            href={
              statusFilter
                ? `/admin/pedidos?status=${statusFilter}`
                : "/admin/pedidos"
            }
            class="text-muted-foreground hover:text-foreground underline"
          >
            Limpiar búsqueda
          </a>
        </div>
      )
    }

    <!-- Orders List -->
    <div class="space-y-2">
      {
        orders && orders.length > 0 ? (
          orders.map((order) => {
            const status = statusConfig[order.status] || statusConfig.pending;
            return (
              <div
                class={`bg-card hover:bg-muted/50 border border-border rounded-lg p-4 transition-all border-l-4 ${status.borderColor}`}
              >
                <div class="flex items-center gap-4">
                  {/* Order ID */}
                  <div class="flex-shrink-0 w-24">
                    <span class="font-mono text-sm text-muted-foreground">
                      {order.order_number
                        ? formatOrderId(order.order_number)
                        : `#${order.id.slice(0, 8)}`}
                    </span>
                  </div>

                  {/* Main Info */}
                  <div class="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                    {/* Customer */}
                    <div class="md:col-span-1">
                      <p class="font-semibold text-foreground truncate">
                        {order.customer_name}
                      </p>
                      <p class="text-xs text-muted-foreground truncate">
                        {order.customer_email}
                      </p>
                    </div>

                    {/* Date */}
                    <div class="text-sm text-muted-foreground">
                      {formatDate(order.created_at)}
                    </div>

                    {/* Total */}
                    <div class="text-right">
                      <p class="font-bold tabular-nums text-foreground">
                        {formatPrice(order.total_amount)}
                      </p>
                    </div>

                    {/* Status */}
                    <div class="flex justify-end">
                      <span
                        class={`inline-flex items-center px-3 py-1.5 rounded-md text-xs font-semibold ${status.bgClass} ${status.textClass}`}
                      >
                        {status.label}
                      </span>
                    </div>
                  </div>

                  {/* Actions */}
                  <div class="flex-shrink-0">
                    <a
                      href={`/admin/pedidos/${order.id}`}
                      class="inline-flex items-center gap-2 px-4 py-2 bg-muted hover:bg-muted/80 border border-border rounded-lg text-sm font-medium transition-colors"
                    >
                      Ver detalles
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            );
          })
        ) : (
          <div class="text-center py-12 text-muted-foreground bg-muted/30 rounded-lg border border-border">
            <svg
              class="w-16 h-16 mx-auto mb-4 opacity-30"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <p>No hay pedidos {statusFilter ? "con este estado" : "todavía"}</p>
          </div>
        )
      }
    </div>

    {/* Pagination */}
    {
      totalPages > 1 && (
        <div class="flex items-center justify-between p-4 bg-muted/30 rounded-lg border border-border">
          <p class="text-sm text-muted-foreground">
            Página {page} de {totalPages}
          </p>
          <div class="flex gap-2">
            {page > 1 && (
              <a
                href={`/admin/pedidos?page=${page - 1}${statusFilter ? `&status=${statusFilter}` : ""}${searchQuery ? `&q=${encodeURIComponent(searchQuery)}` : ""}`}
                class="px-4 py-2 bg-muted hover:bg-muted/80 border border-border rounded-lg text-sm transition-colors"
              >
                Anterior
              </a>
            )}
            {page < totalPages && (
              <a
                href={`/admin/pedidos?page=${page + 1}${statusFilter ? `&status=${statusFilter}` : ""}${searchQuery ? `&q=${encodeURIComponent(searchQuery)}` : ""}`}
                class="px-4 py-2 bg-muted hover:bg-muted/80 border border-border rounded-lg text-sm transition-colors"
              >
                Siguiente
              </a>
            )}
          </div>
        </div>
      )
    }
  </div>

  <script define:vars={{ searchQuery, statusFilter }}>
    // Status filter change handler
    const statusSelect = document.getElementById("status-filter");
    statusSelect?.addEventListener("change", (e) => {
      const value = e.target.value;
      let url = "/admin/pedidos";
      const params = new URLSearchParams();
      if (value) params.set("status", value);
      if (searchQuery) params.set("q", searchQuery);
      if (params.toString()) url += "?" + params.toString();
      window.location.href = url;
    });

    // Clear search button
    const clearBtn = document.getElementById("clear-search");
    clearBtn?.addEventListener("click", () => {
      let url = "/admin/pedidos";
      if (statusFilter) url += "?status=" + statusFilter;
      window.location.href = url;
    });
  </script>
</AdminLayout>

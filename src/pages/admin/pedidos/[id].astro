---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";

const { id } = Astro.params;

// Fetch order with items
const { data: order, error } = await supabase
  .from("orders")
  .select(
    `
    *,
    items:order_items(
      id,
      quantity,
      price_at_purchase,
      product:products(id, name, slug),
      variant:product_variants(id, size)
    )
  `
  )
  .eq("id", id)
  .single();

if (error || !order) {
  return Astro.redirect("/admin/pedidos?error=not-found");
}

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const statusConfig: Record<
  string,
  { label: string; bgClass: string; textClass: string }
> = {
  pending: {
    label: "Pendiente",
    bgClass: "bg-yellow-500/20",
    textClass: "text-yellow-400",
  },
  paid: {
    label: "Pagado",
    bgClass: "bg-green-500/20",
    textClass: "text-green-400",
  },
  shipped: {
    label: "Enviado",
    bgClass: "bg-blue-500/20",
    textClass: "text-blue-400",
  },
  delivered: {
    label: "Entregado",
    bgClass: "bg-green-500/20",
    textClass: "text-green-400",
  },
  cancelled: {
    label: "Cancelado",
    bgClass: "bg-red-500/20",
    textClass: "text-red-400",
  },
};

const statuses = ["pending", "paid", "shipped", "delivered", "cancelled"];
const currentStatus = statusConfig[order.status] || statusConfig.pending;
---

<AdminLayout title={`Pedido #${order.id.slice(0, 8)}`}>
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a
          href="/admin/pedidos"
          class="p-2 hover:bg-zinc-800 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-foreground">
            Pedido #{order.id.slice(0, 8)}
          </h1>
          <p class="text-zinc-500">{formatDate(order.created_at)}</p>
        </div>
      </div>
      <span
        class={`px-4 py-2 rounded-lg text-sm font-semibold ${currentStatus.bgClass} ${currentStatus.textClass}`}
      >
        {currentStatus.label}
      </span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Order Details -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Items -->
        <div class="admin-card p-0">
          <div class="p-5 border-b border-zinc-800">
            <h2 class="font-semibold text-lg">
              Productos ({order.items?.length || 0})
            </h2>
          </div>
          <div class="divide-y divide-zinc-800">
            {
              order.items?.map((item: any) => (
                <div class="flex items-center gap-4 p-5">
                  <div class="w-12 h-12 rounded-lg bg-zinc-800 flex items-center justify-center flex-shrink-0">
                    <svg
                      class="w-6 h-6 text-zinc-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="font-medium text-foreground">
                      {item.product?.name || "Producto eliminado"}
                    </p>
                    <p class="text-sm text-zinc-500">
                      Talla: {item.variant?.size || "N/A"} · Cantidad:{" "}
                      {item.quantity}
                    </p>
                  </div>
                  <p class="font-bold tabular-nums text-foreground">
                    {formatPrice(item.price_at_purchase * item.quantity)}
                  </p>
                </div>
              ))
            }
          </div>
          <div
            class="p-5 border-t border-zinc-800 flex justify-between items-center bg-zinc-800/30"
          >
            <span class="font-semibold">Total</span>
            <span class="text-2xl font-bold text-primary">
              {formatPrice(order.total_amount)}
            </span>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="admin-card">
          <h2 class="font-semibold text-lg mb-4">Datos del Cliente</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-zinc-500 mb-1">Nombre</label>
              <p class="font-medium text-foreground">{order.customer_name}</p>
            </div>
            <div>
              <label class="block text-sm text-zinc-500 mb-1">Email</label>
              <p class="font-medium text-foreground">{order.customer_email}</p>
            </div>
            {
              order.customer_phone && (
                <div>
                  <label class="block text-sm text-zinc-500 mb-1">
                    Teléfono
                  </label>
                  <p class="font-medium text-foreground">
                    {order.customer_phone}
                  </p>
                </div>
              )
            }
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="admin-card">
          <h2 class="font-semibold text-lg mb-4">Dirección de Envío</h2>
          <div class="space-y-1">
            <p class="font-medium text-foreground">{order.customer_name}</p>
            <p class="text-zinc-400">{order.shipping_address}</p>
            <p class="text-zinc-400">
              {order.shipping_postal_code}
              {order.shipping_city}
            </p>
            <p class="text-zinc-400">{order.shipping_country}</p>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Status Update -->
        <div class="admin-card">
          <h2 class="font-semibold text-lg mb-4">Cambiar Estado</h2>
          <select
            id="status-select"
            class="admin-select w-full mb-3"
            data-order-id={order.id}
          >
            {
              statuses.map((status) => (
                <option value={status} selected={status === order.status}>
                  {statusConfig[status]?.label || status}
                </option>
              ))
            }
          </select>
          <button id="update-status" class="admin-btn-primary w-full">
            Actualizar Estado
          </button>
          <div id="status-message" class="hidden mt-3 p-3 rounded-lg text-sm">
          </div>
        </div>

        <!-- Quick Info -->
        <div class="admin-card">
          <h2 class="font-semibold text-lg mb-4">Información</h2>
          <div class="space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">ID Pedido</span>
              <span class="font-mono text-foreground"
                >{order.id.slice(0, 8)}</span
              >
            </div>
            {
              order.stripe_session_id && (
                <div class="flex justify-between text-sm">
                  <span class="text-zinc-500">Stripe Session</span>
                  <span
                    class="font-mono truncate max-w-[120px] text-foreground"
                    title={order.stripe_session_id}
                  >
                    {order.stripe_session_id.slice(0, 16)}...
                  </span>
                </div>
              )
            }
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Fecha</span>
              <span class="text-foreground">{formatDate(order.created_at)}</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusSelect = document.getElementById(
      "status-select"
    ) as HTMLSelectElement;
    const updateBtn = document.getElementById("update-status");
    const messageDiv = document.getElementById("status-message");
    const orderId = statusSelect?.dataset.orderId;

    updateBtn?.addEventListener("click", async () => {
      const newStatus = statusSelect.value;

      try {
        const response = await fetch("/api/admin/pedidos", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: orderId, status: newStatus }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error al actualizar");
        }

        if (messageDiv) {
          messageDiv.className =
            "mt-3 p-3 rounded-lg text-sm bg-green-500/20 text-green-400";
          messageDiv.textContent = "✅ Estado actualizado";
          messageDiv.classList.remove("hidden");
        }

        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (error: any) {
        if (messageDiv) {
          messageDiv.className =
            "mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400";
          messageDiv.textContent = error.message;
          messageDiv.classList.remove("hidden");
        }
      }
    });
  </script>
</AdminLayout>

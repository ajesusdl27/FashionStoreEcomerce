---
import AdminLayout from "@/layouts/AdminLayout.astro";
import PromotionCalendar from "@/components/islands/admin/PromotionCalendar";
import { createAuthenticatedClient } from "@/lib/supabase";

// Get authenticated client for RLS compliance
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken) {
  return Astro.redirect("/login?redirect=/admin/promociones/calendario");
}

const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch all promotions with dates
const { data: promotions, error } = await authClient
  .from("promotions")
  .select("id, title, start_date, end_date, is_active, locations, image_url")
  .order("start_date", { ascending: true });

if (error) {
  console.error("Error fetching promotions:", error);
}
---

<AdminLayout title="Calendario de Promociones">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <div class="flex items-center gap-2 mb-2">
          <a
            href="/admin/promociones"
            class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Volver
          </a>
        </div>
        <h1
          class="font-heading text-2xl text-foreground flex items-center gap-3"
        >
          <svg
            class="w-7 h-7 text-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          Calendario de Promociones
        </h1>
        <p class="text-sm text-muted-foreground mt-1">
          Vista mensual de todas las promociones programadas
        </p>
      </div>

      <a
        href="/admin/promociones/nueva"
        class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Nueva Promoci√≥n
      </a>
    </div>

    <!-- Calendar Component -->
    <PromotionCalendar client:load promotions={promotions || []} />
  </div>
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import PromotionWizard from "@/components/islands/admin/PromotionWizard";
import { createAuthenticatedClient } from "@/lib/supabase";

import { Sparkles, ChevronLeft } from "lucide-react";

// Get authenticated client
const accessToken = Astro.cookies.get("sb-access-token")?.value;
// ... (rest of imports are fine, just injecting Sparkles)
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken) {
  return Astro.redirect("/login?redirect=/admin/promociones/nueva");
}

const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch coupons for linking
const { data: coupons } = await authClient
  .from("coupons")
  .select("id, code")
  .eq("is_active", true)
  .order("code", { ascending: true });

// Fetch categories for link selector
const { data: categories } = await authClient
  .from("categories")
  .select("id, name, slug")
  .order("name", { ascending: true });

// Check for existing draft
const { data: existingDraft } = await authClient
  .from("promotion_drafts")
  .select("*")
  .single();
---

<AdminLayout title="Nueva Promoción">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <a
        href="/admin/promociones"
        class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 mb-2"
      >
        <ChevronLeft className="w-4 h-4" />
        Volver al listado
      </a>
      <h1 class="font-heading text-2xl text-foreground flex items-center gap-3">
        <Sparkles className="w-8 h-8 text-yellow-400" />
        Nueva Promoción
      </h1>
      <p class="text-sm text-muted-foreground mt-1">
        Sigue los pasos para crear tu banner promocional
      </p>
    </div>

    <!-- Wizard Component -->
    <PromotionWizard
      client:load
      categories={categories || []}
      coupons={coupons || []}
      existingDraft={existingDraft}
    />
  </div>
</AdminLayout>

<style>
  /* Additional wizard styles */
  .admin-input {
    @apply bg-muted border border-border rounded-lg px-3 py-2 text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all;
  }

  .admin-card {
    @apply bg-card border border-border rounded-xl;
  }

  /* Ensure smooth animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .admin-card {
    animation: fadeIn 0.3s ease-out;
  }
</style>

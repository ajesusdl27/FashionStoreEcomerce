---
import AdminLayout from "@/layouts/AdminLayout.astro";
import ImageUploader from "@/components/islands/ImageUploader";
import { createAuthenticatedClient } from "@/lib/supabase";

// Get authenticated client
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch coupons for search/select
const { data: coupons } = await authClient
  .from("coupons")
  .select("id, code, discount_type, discount_value")
  .eq("is_active", true)
  .order("code", { ascending: true });
---

<AdminLayout title="Nueva Promoci√≥n">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <a
        href="/admin/promociones"
        class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 mb-2"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Volver al listado
      </a>
      <h1 class="font-heading text-2xl text-foreground">Nueva Promoci√≥n</h1>
    </div>

    <!-- Live Preview Panel - At Top for Better UX -->
    <div class="admin-card p-6 mb-8 sticky top-4 z-10 bg-card/95 backdrop-blur">
      <h2
        class="text-lg font-medium border-b border-border pb-2 mb-4 flex items-center gap-2"
      >
        <svg
          class="w-5 h-5 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          ></path>
        </svg>
        Vista Previa en Vivo
      </h2>

      <div
        id="live-preview"
        class="relative aspect-[21/9] bg-muted rounded-lg overflow-hidden border border-border"
      >
        <!-- Placeholder when no image -->
        <div
          id="preview-placeholder"
          class="absolute inset-0 flex flex-col items-center justify-center text-muted-foreground"
        >
          <svg
            class="w-16 h-16 mb-4 opacity-30"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <p class="text-sm">Sube una imagen para ver la vista previa</p>
        </div>

        <!-- Preview Image -->
        <img
          id="preview-image"
          class="absolute inset-0 w-full h-full object-cover hidden"
          src=""
          alt="Preview"
        />

        <!-- Overlay Gradient -->
        <div
          id="preview-overlay"
          class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/30 to-transparent hidden"
        >
        </div>

        <!-- Preview Content -->
        <div
          id="preview-content"
          class="absolute inset-0 flex flex-col justify-center p-8 hidden"
          style="max-width: 60%;"
        >
          <h3
            id="preview-title"
            class="text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg"
          >
            T√≠tulo de la Promoci√≥n
          </h3>
          <p
            id="preview-description"
            class="text-base text-white/90 mb-4 line-clamp-2"
          >
          </p>
          <div class="flex items-center gap-4">
            <button
              id="preview-cta"
              class="bg-primary text-primary-foreground px-6 py-2 rounded font-medium text-sm"
            >
              Comprar Ahora
            </button>
          </div>
        </div>
      </div>

      <p class="text-xs text-muted-foreground mt-3">
        üí° La vista previa se actualiza mientras rellenas el formulario.
      </p>
    </div>

    <form id="promo-form" class="space-y-8">
      <!-- Section 1: Visuals -->
      <div class="admin-card p-6 space-y-6">
        <h2 class="text-lg font-medium border-b border-border pb-2">
          1. Im√°genes del Banner
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Desktop Image -->
          <div>
            <label
              class="block text-sm font-medium mb-2 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-muted-foreground"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                ></path>
              </svg>
              Imagen Desktop *
            </label>
            <ImageUploader
              client:load
              inputName="images"
              inputId="images-input"
            />
            <p class="text-xs text-muted-foreground mt-1">
              Imagen principal para pantallas grandes (recomendado: 1920x800)
            </p>
          </div>

          <!-- Mobile Image -->
          <div>
            <label
              class="block text-sm font-medium mb-2 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-muted-foreground"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
                ></path>
              </svg>
              Imagen M√≥vil
              <span class="text-xs text-muted-foreground font-normal"
                >(opcional)</span
              >
            </label>
            <ImageUploader
              client:load
              inputName="mobile_images"
              inputId="mobile-images-input"
            />
            <p class="text-xs text-muted-foreground mt-1">
              Versi√≥n optimizada para m√≥viles (recomendado: 750x1000, vertical)
            </p>
          </div>
        </div>
      </div>

      <!-- Section 2: Content -->
      <div class="admin-card p-6 space-y-6">
        <h2 class="text-lg font-medium border-b border-border pb-2">
          2. Contenido
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">T√≠tulo *</label>
              <input
                type="text"
                name="title"
                required
                placeholder="Ej: REBAJAS DE VERANO"
                class="admin-input w-full"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Descripci√≥n</label>
              <textarea
                name="description"
                rows="3"
                placeholder="Hasta 50% de descuento en seleccionados..."
                class="admin-input w-full"></textarea>
            </div>
          </div>

          <div
            class="space-y-4 bg-muted/50 p-4 rounded-lg border border-border"
          >
            <label class="block text-sm font-medium text-muted-foreground mb-2"
              >Estilos Texto</label
            >
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-muted-foreground mb-1"
                  >Color del texto</label
                >
                <select name="style_text_color" class="admin-input w-full">
                  <option value="white">‚ö™ Blanco (fondos oscuros)</option>
                  <option value="black">‚ö´ Negro (fondos claros)</option>
                  <option value="gold">üü° Dorado (premium)</option>
                  <option value="red">üî¥ Rojo (urgencia)</option>
                  <option value="gray">‚ö™ Gris claro</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-muted-foreground mb-1"
                  >Alineaci√≥n</label
                >
                <select name="style_text_align" class="admin-input w-full">
                  <option value="left">Izquierda</option>
                  <option value="center">Centro</option>
                  <option value="right">Derecha</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- CTA Section -->
        <div class="border-t border-border pt-6">
          <label class="block text-sm font-medium mb-4 flex items-center gap-2">
            <svg
              class="w-4 h-4 text-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"
              ></path>
            </svg>
            Bot√≥n de Acci√≥n (CTA)
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-muted-foreground mb-1"
                >Texto del bot√≥n</label
              >
              <input
                type="text"
                name="cta_text"
                placeholder="Ej: Comprar Ahora, Ver Ofertas..."
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Si est√° vac√≠o, usar√° "Comprar Ahora" por defecto
              </p>
            </div>
            <div>
              <label class="block text-xs text-muted-foreground mb-1"
                >Enlace del bot√≥n</label
              >
              <input
                type="text"
                name="cta_link"
                placeholder="Ej: /productos, /categoria/ofertas..."
                class="admin-input w-full"
              />
              <p class="text-xs text-muted-foreground mt-1">
                Si est√° vac√≠o, redirige a /productos
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 3: Configuration -->
      <div class="admin-card p-6 space-y-6">
        <h2 class="text-lg font-medium border-b border-border pb-2">
          3. Configuraci√≥n
        </h2>

        <div>
          <label class="block text-sm font-medium mb-3">Ubicaci√≥n *</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <!-- home_hero -->
            <label
              class="group flex items-center gap-4 p-4 rounded-lg border border-border hover:border-primary/50 bg-muted/30 hover:bg-muted/50 cursor-pointer transition-all"
            >
              <input
                type="checkbox"
                name="locations"
                value="home_hero"
                class="mt-0.5 rounded border-border bg-background text-primary focus:ring-primary"
              />
              <div class="flex items-center gap-3 flex-1">
                <div
                  class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-xl"
                >
                  üè†
                </div>
                <div>
                  <span class="block text-sm font-medium text-foreground"
                    >Home Hero</span
                  >
                  <span class="block text-xs text-muted-foreground"
                    >Banner principal de la p√°gina de inicio</span
                  >
                </div>
              </div>
            </label>

            <!-- announcement_top -->
            <label
              class="group flex items-center gap-4 p-4 rounded-lg border border-border hover:border-primary/50 bg-muted/30 hover:bg-muted/50 cursor-pointer transition-all"
            >
              <input
                type="checkbox"
                name="locations"
                value="announcement_top"
                class="mt-0.5 rounded border-border bg-background text-primary focus:ring-primary"
              />
              <div class="flex items-center gap-3 flex-1">
                <div
                  class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center text-xl"
                >
                  üì¢
                </div>
                <div>
                  <span class="block text-sm font-medium text-foreground"
                    >Barra Superior</span
                  >
                  <span class="block text-xs text-muted-foreground"
                    >Aviso fijo en el header de la tienda</span
                  >
                </div>
              </div>
            </label>

            <!-- cart_sidebar -->
            <label
              class="group flex items-center gap-4 p-4 rounded-lg border border-border hover:border-primary/50 bg-muted/30 hover:bg-muted/50 cursor-pointer transition-all"
            >
              <input
                type="checkbox"
                name="locations"
                value="cart_sidebar"
                class="mt-0.5 rounded border-border bg-background text-primary focus:ring-primary"
              />
              <div class="flex items-center gap-3 flex-1">
                <div
                  class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-xl"
                >
                  üõí
                </div>
                <div>
                  <span class="block text-sm font-medium text-foreground"
                    >Banner Carrito</span
                  >
                  <span class="block text-xs text-muted-foreground"
                    >Banner lateral en el carrito de compras</span
                  >
                </div>
              </div>
            </label>

            <!-- product_page -->
            <label
              class="group flex items-center gap-4 p-4 rounded-lg border border-border hover:border-primary/50 bg-muted/30 hover:bg-muted/50 cursor-pointer transition-all"
            >
              <input
                type="checkbox"
                name="locations"
                value="product_page"
                class="mt-0.5 rounded border-border bg-background text-primary focus:ring-primary"
              />
              <div class="flex items-center gap-3 flex-1">
                <div
                  class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center text-xl"
                >
                  üì¶
                </div>
                <div>
                  <span class="block text-sm font-medium text-foreground"
                    >Ficha Producto</span
                  >
                  <span class="block text-xs text-muted-foreground"
                    >Debajo del bot√≥n a√±adir al carrito</span
                  >
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2">Prioridad</label>
          <input
            type="number"
            name="priority"
            value="10"
            min="1"
            class="admin-input w-full"
          />
          <p class="text-xs text-muted-foreground mt-1">
            Menor n√∫mero = M√°s arriba
          </p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Fecha Inicio</label>
          <input
            type="datetime-local"
            name="start_date"
            class="admin-input w-full"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Fecha Fin</label>
          <input
            type="datetime-local"
            name="end_date"
            class="admin-input w-full"
          />
        </div>
      </div>

      <!-- Section 4: Coupon (Optional) -->
      <div class="admin-card p-6 space-y-6">
        <h2 class="text-lg font-medium border-b border-border pb-2">
          4. Cup√≥n (Opcional)
        </h2>

        <div>
          <label class="block text-sm font-medium mb-2">Vincular Cup√≥n</label>
          <select name="coupon_id" class="admin-input w-full">
            <option value="">-- Sin cup√≥n vinculado --</option>
            {
              coupons?.map((coupon: any) => (
                <option value={coupon.id}>
                  {coupon.code} -{" "}
                  {coupon.discount_type === "percentage"
                    ? `${coupon.discount_value}%`
                    : `${coupon.discount_value}‚Ç¨`}
                </option>
              ))
            }
          </select>
          <p class="text-xs text-muted-foreground mt-1">
            Si se selecciona, el banner mostrar√° el c√≥digo y permitir√° copiarlo
            o aplicarlo.
          </p>
        </div>
      </div>

      <!-- Submit Actions -->
      <div
        class="flex items-center justify-end gap-4 border-t border-border pt-6"
      >
        <a href="/admin/promociones" class="admin-btn">Cancelar</a>
        <button
          type="submit"
          id="btn-submit"
          class="admin-btn admin-btn-primary"
        >
          <span id="btn-text">Crear Promoci√≥n</span>
          <svg
            id="btn-spinner"
            class="hidden animate-spin w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>

      <div
        id="form-error"
        class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400"
      >
      </div>

      <!-- Success Toast -->
      <div
        id="form-success"
        class="hidden fixed bottom-6 right-6 p-4 bg-green-500/90 text-white rounded-lg shadow-xl flex items-center gap-3 animate-bounce z-50"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"></path>
        </svg>
        <span class="font-medium">¬°Promoci√≥n creada correctamente!</span>
      </div>
    </form>

    <!-- Live Preview Panel -->
    <div class="admin-card p-6 mt-8">
      <h2
        class="text-lg font-medium border-b border-border pb-2 mb-4 flex items-center gap-2"
      >
        <svg
          class="w-5 h-5 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          ></path>
        </svg>
        Vista Previa en Vivo
      </h2>

      <div
        id="live-preview"
        class="relative aspect-[21/9] bg-muted rounded-lg overflow-hidden border border-border"
      >
        <!-- Placeholder when no image -->
        <div
          id="preview-placeholder"
          class="absolute inset-0 flex flex-col items-center justify-center text-muted-foreground"
        >
          <svg
            class="w-16 h-16 mb-4 opacity-30"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <p class="text-sm">Sube una imagen para ver la vista previa</p>
        </div>

        <!-- Preview Image -->
        <img
          id="preview-image"
          class="absolute inset-0 w-full h-full object-cover hidden"
          src=""
          alt="Preview"
        />

        <!-- Overlay Gradient -->
        <div
          id="preview-overlay"
          class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/30 to-transparent hidden"
        >
        </div>

        <!-- Preview Content -->
        <div
          id="preview-content"
          class="absolute inset-0 flex flex-col justify-center p-8 hidden"
          style="max-width: 60%;"
        >
          <h3
            id="preview-title"
            class="text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg"
          >
          </h3>
          <p
            id="preview-description"
            class="text-base text-white/90 mb-4 line-clamp-2"
          >
          </p>
          <div class="flex items-center gap-4">
            <button
              id="preview-cta"
              class="bg-primary text-primary-foreground px-6 py-2 rounded font-medium text-sm"
            >
              Comprar Ahora
            </button>
          </div>
        </div>
      </div>

      <p class="text-xs text-muted-foreground mt-3">
        üí° Esta es una aproximaci√≥n de c√≥mo se ver√° el banner en el sitio.
      </p>
    </div>
  </div>
</AdminLayout>

<script>
  const form = document.getElementById("promo-form") as HTMLFormElement;
  const btnSubmit = document.getElementById("btn-submit") as HTMLButtonElement;
  const btnText = document.getElementById("btn-text") as HTMLElement;
  const btnSpinner = document.getElementById("btn-spinner") as HTMLElement;
  const formError = document.getElementById("form-error") as HTMLElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    btnSubmit.disabled = true;
    btnText.classList.add("hidden");
    btnSpinner.classList.remove("hidden");
    formError.classList.add("hidden");

    const formData = new FormData(form);
    const data: Record<string, any> = {};
    const locations: string[] = [];

    // Process FormData
    formData.forEach((value, key) => {
      if (key === "locations") {
        locations.push(value as string);
      } else if (key === "images") {
        // Desktop images come as JSON string from ImageUploader
        try {
          const urls = JSON.parse(value as string);
          if (urls && urls.length > 0) {
            data["image_url"] = urls[0];
          }
        } catch (e) {
          console.error("Error parsing images", e);
        }
      } else if (key === "mobile_images") {
        // Mobile images
        try {
          const urls = JSON.parse(value as string);
          if (urls && urls.length > 0) {
            data["mobile_image_url"] = urls[0];
          }
        } catch (e) {
          console.error("Error parsing mobile images", e);
        }
      } else if (key.startsWith("style_")) {
        // Group styles
        if (!data["style_config"]) data["style_config"] = {};
        const styleKey = key.replace("style_", "");
        data["style_config"][styleKey] = value;
      } else if (value !== "") {
        data[key] = value;
      }
    });

    data["locations"] = locations;

    // Default manual validations
    if (!data["image_url"]) {
      formError.textContent = "Debes subir al menos una imagen para el banner.";
      formError.classList.remove("hidden");
      btnSubmit.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
      return;
    }

    if (locations.length === 0) {
      formError.textContent = "Debes seleccionar al menos una ubicaci√≥n.";
      formError.classList.remove("hidden");
      btnSubmit.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
      return;
    }

    try {
      const response = await fetch("/api/admin/promociones", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Error al crear la promoci√≥n");
      }

      // Show success toast
      const successToast = document.getElementById("form-success");
      successToast?.classList.remove("hidden");

      // Redirect after short delay
      setTimeout(() => {
        window.location.href = "/admin/promociones";
      }, 1500);
    } catch (error: any) {
      formError.textContent = error.message;
      formError.classList.remove("hidden");
      btnSubmit.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    }
  });

  // ========== LIVE PREVIEW FUNCTIONALITY ==========
  const previewPlaceholder = document.getElementById("preview-placeholder");
  const previewImage = document.getElementById(
    "preview-image"
  ) as HTMLImageElement;
  const previewOverlay = document.getElementById("preview-overlay");
  const previewContent = document.getElementById("preview-content");
  const previewTitle = document.getElementById("preview-title");
  const previewDescription = document.getElementById("preview-description");
  const previewCta = document.getElementById("preview-cta");

  // Watch for image changes via hidden input
  const imagesInput = document.getElementById("images-input");

  function updatePreviewImage() {
    try {
      const value = (imagesInput as HTMLInputElement)?.value;
      if (value) {
        const urls = JSON.parse(value);
        if (urls && urls.length > 0) {
          previewImage?.setAttribute("src", urls[0]);
          previewImage?.classList.remove("hidden");
          previewPlaceholder?.classList.add("hidden");
          previewOverlay?.classList.remove("hidden");
          previewContent?.classList.remove("hidden");
          return;
        }
      }
    } catch (e) {}

    // No image - show placeholder
    previewImage?.classList.add("hidden");
    previewPlaceholder?.classList.remove("hidden");
    previewOverlay?.classList.add("hidden");
    previewContent?.classList.add("hidden");
  }

  // Use MutationObserver to watch for changes to hidden input value
  if (imagesInput) {
    const observer = new MutationObserver(updatePreviewImage);
    observer.observe(imagesInput, {
      attributes: true,
      attributeFilter: ["value"],
    });

    // Also poll periodically as some changes might not trigger mutation
    setInterval(updatePreviewImage, 1000);
  }

  // Watch title input
  const titleInput = document.querySelector('input[name="title"]');
  titleInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (previewTitle)
      previewTitle.textContent = value || "T√≠tulo de la Promoci√≥n";
  });

  // Watch description input
  const descInput = document.querySelector('textarea[name="description"]');
  descInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLTextAreaElement).value;
    if (previewDescription) previewDescription.textContent = value || "";
  });

  // Watch CTA text input
  const ctaTextInput = document.querySelector('input[name="cta_text"]');
  ctaTextInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (previewCta) previewCta.textContent = value || "Comprar Ahora";
  });

  // Watch text color select
  const textColorSelect = document.querySelector(
    'select[name="style_text_color"]'
  );
  textColorSelect?.addEventListener("change", (e) => {
    const value = (e.target as HTMLSelectElement).value;
    const isWhite = value === "white";

    if (previewTitle) {
      previewTitle.className = `text-3xl md:text-4xl font-bold mb-2 drop-shadow-lg ${isWhite ? "text-white" : "text-black"}`;
    }
    if (previewDescription) {
      previewDescription.className = `text-base mb-4 line-clamp-2 ${isWhite ? "text-white/90" : "text-black/90"}`;
    }
    if (previewOverlay) {
      previewOverlay.className = `absolute inset-0 ${isWhite ? "bg-gradient-to-r from-black/70 via-black/30 to-transparent" : "bg-gradient-to-r from-white/70 via-white/30 to-transparent"}`;
    }
  });
</script>

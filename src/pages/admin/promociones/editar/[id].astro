---
import AdminLayout from "@/layouts/AdminLayout.astro";
import PromotionWizard from "@/components/islands/admin/PromotionWizard";
import { createAuthenticatedClient } from "@/lib/supabase";
import {
  Plus,
  Pencil,
  CheckCircle,
  PauseCircle,
  Trash2,
  FileText,
  ChevronLeft,
  History,
} from "lucide-react";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/admin/promociones");
}

// Get authenticated client
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken) {
  return Astro.redirect("/login?redirect=/admin/promociones");
}

const authClient = createAuthenticatedClient(accessToken, refreshToken);

// Fetch promotion details
const { data: promotion, error } = await authClient
  .from("promotions")
  .select("*")
  .eq("id", id)
  .single();

if (error || !promotion) {
  return Astro.redirect("/admin/promociones");
}

// Fetch coupons for search/select
const { data: coupons } = await authClient
  .from("coupons")
  .select("id, code, discount_type, discount_value")
  .eq("is_active", true)
  .order("code", { ascending: true });

// Fetch categories for link selector
const { data: categories } = await authClient
  .from("categories")
  .select("id, name, slug")
  .order("name", { ascending: true });

// Fetch promotion history
const { data: history } = await authClient
  .from("promotion_history")
  .select("id, action, changes, created_at")
  .eq("promotion_id", id)
  .order("created_at", { ascending: false })
  .limit(10);

const historyData = history || [];

// Action config for history display
const actionConfig: Record<string, { label: string; color: string }> = {
  created: { label: "Creada", color: "text-green-400" },
  updated: { label: "Editada", color: "text-blue-400" },
  activated: { label: "Activada", color: "text-emerald-400" },
  deactivated: { label: "Desactivada", color: "text-yellow-400" },
  deleted: { label: "Eliminada", color: "text-red-400" },
};

const timeAgo = (date: string) => {
  const now = new Date();
  const then = new Date(date);
  const diffMs = now.getTime() - then.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return "Ahora mismo";
  if (diffMins < 60) return `Hace ${diffMins} min`;
  if (diffHours < 24) return `Hace ${diffHours}h`;
  if (diffDays < 7) return `Hace ${diffDays} días`;
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
  });
};
---

<AdminLayout title="Editar Promoción">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <a
        href="/admin/promociones"
        class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 mb-2"
      >
        <ChevronLeft className="w-4 h-4" />
        Volver al listado
      </a>
      <h1 class="font-heading text-2xl text-foreground flex items-center gap-3">
        <Pencil className="w-6 h-6 text-primary" />
        Editar Promoción
      </h1>
      <p class="text-sm text-muted-foreground mt-1">
        Modifica los datos de tu banner promocional
      </p>
    </div>

    <!-- Wizard Component (Edit Mode) -->
    <PromotionWizard
      client:load
      categories={categories || []}
      coupons={coupons || []}
      initialData={promotion}
      mode="edit"
      promotionId={promotion.id}
    />

    <!-- History Section -->
    <div class="admin-card p-6 mt-8">
      <h2
        class="text-lg font-medium border-b border-border pb-2 mb-4 flex items-center gap-2"
      >
        <History className="w-5 h-5 text-muted-foreground" />
        Historial de Cambios
      </h2>

      {
        historyData.length > 0 ? (
          <div class="space-y-3">
            {historyData.map((entry: any) => {
              const defaultConfig = {
                label: "Cambio",
                icon: <Pencil className="w-5 h-5" />,
                color: "text-muted-foreground",
              };
              const config = actionConfig[entry.action] ?? defaultConfig;
              return (
                <div class="flex items-start gap-3 text-sm">
                  <span class="text-lg">
                    {entry.action === "created" && <Plus className="w-5 h-5" />}
                    {entry.action === "updated" && (
                      <Pencil className="w-5 h-5" />
                    )}
                    {entry.action === "activated" && (
                      <CheckCircle className="w-5 h-5" />
                    )}
                    {entry.action === "deactivated" && (
                      <PauseCircle className="w-5 h-5" />
                    )}
                    {entry.action === "deleted" && (
                      <Trash2 className="w-5 h-5" />
                    )}
                    {![
                      "created",
                      "updated",
                      "activated",
                      "deactivated",
                      "deleted",
                    ].includes(entry.action) && (
                      <FileText className="w-5 h-5" />
                    )}
                  </span>
                  <div class="flex-1">
                    <span class={`font-medium ${config.color}`}>
                      {config.label}
                    </span>
                    <span class="text-muted-foreground ml-2">
                      {timeAgo(entry.created_at)}
                    </span>
                  </div>
                </div>
              );
            })}
            <a
              href="/admin/promociones/historial"
              class="text-xs text-primary hover:underline inline-flex items-center gap-1 mt-2"
            >
              Ver historial completo →
            </a>
          </div>
        ) : (
          <p class="text-sm text-muted-foreground">
            No hay cambios registrados aún. Los cambios aparecerán aquí después
            de ejecutar la migración.
          </p>
        )
      }
    </div>
  </div>
</AdminLayout>

<style>
  .admin-input {
    @apply bg-muted border border-border rounded-lg px-3 py-2 text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all;
  }

  .admin-card {
    @apply bg-card border border-border rounded-xl;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .admin-card {
    animation: fadeIn 0.3s ease-out;
  }
</style>

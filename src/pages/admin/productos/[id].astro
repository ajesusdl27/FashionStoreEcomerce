---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import ImageUploader from "@/components/islands/ImageUploader";

const { id } = Astro.params;

// Fetch product with all relations
const { data: product, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name, size_type),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .eq("id", id)
  .single();

if (error || !product) {
  return Astro.redirect("/admin/productos?error=not-found");
}

// Fetch categories for dropdown with size_type
const { data: categories } = await supabase
  .from("categories")
  .select("id, name, size_type")
  .order("name");

// Size mappings by category type
const sizeMappings = {
  clothing: ["XXS", "XS", "S", "M", "L", "XL", "XXL"],
  footwear: ["36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46"],
  universal: ["Única"],
};

// Create category to size_type mapping
const categoryTypes: Record<string, string> = {};
categories?.forEach((cat: any) => {
  categoryTypes[cat.id] = cat.size_type || "clothing";
});

// Get existing variant data as JSON for JS
const existingVariants: Record<string, number> = {};
product.variants?.forEach((v: any) => {
  existingVariants[v.size] = v.stock || 0;
});

// Get sorted images
const sortedImages =
  product.images?.sort((a: any, b: any) => a.order - b.order) || [];
---

<AdminLayout title={`Editar: ${product.name}`}>
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a
          href="/admin/productos"
          class="p-2 hover:bg-muted rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div>
          <h1 class="font-display text-3xl text-primary">Editar Producto</h1>
          <p class="text-muted-foreground mt-1">{product.name}</p>
        </div>
      </div>
      <button
        id="delete-btn"
        class="px-4 py-2 bg-accent/20 text-accent rounded-lg hover:bg-accent/30 transition-colors"
      >
        Eliminar
      </button>
    </div>

    <!-- Form -->
    <form id="product-form" class="space-y-6">
      <input type="hidden" id="product-id" value={id} />

      <!-- Basic Info -->
      <div class="glass border border-border rounded-xl p-6 space-y-4">
        <h2 class="font-heading text-lg">Información Básica</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="name"
              class="block text-sm font-medium text-muted-foreground mb-2"
            >
              Nombre <span class="text-accent">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              value={product.name}
              class="w-full px-4 py-3 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            />
          </div>
          <div>
            <label
              for="slug"
              class="block text-sm font-medium text-muted-foreground mb-2"
            >
              Slug (URL) <span class="text-accent">*</span>
            </label>
            <input
              type="text"
              id="slug"
              name="slug"
              required
              value={product.slug}
              class="w-full px-4 py-3 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            />
          </div>
        </div>

        <div>
          <label
            for="description"
            class="block text-sm font-medium text-muted-foreground mb-2"
          >
            Descripción
          </label>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="w-full px-4 py-3 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"
            >{product.description}</textarea
          >
        </div>

        <div>
          <label
            for="category_id"
            class="block text-sm font-medium text-muted-foreground mb-2"
          >
            Categoría
          </label>
          <select
            id="category_id"
            name="category_id"
            class="w-full px-4 py-3 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
          >
            <option value="">Sin categoría</option>
            {
              categories?.map((cat) => (
                <option
                  value={cat.id}
                  selected={cat.id === product.category_id}
                >
                  {cat.name}
                </option>
              ))
            }
          </select>
        </div>
      </div>

      <!-- Pricing -->
      <div class="glass border border-border rounded-xl p-6 space-y-4">
        <h2 class="font-heading text-lg">Precios</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label
              for="price"
              class="block text-sm font-medium text-muted-foreground mb-2"
            >
              Precio <span class="text-accent">*</span>
            </label>
            <div class="relative">
              <input
                type="number"
                id="price"
                name="price"
                required
                min="0"
                step="0.01"
                value={product.price}
                class="w-full px-4 py-3 pr-12 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
              />
              <span
                class="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground"
                >€</span
              >
            </div>
          </div>
          <div>
            <label
              for="offer_price"
              class="block text-sm font-medium text-muted-foreground mb-2"
            >
              Precio Oferta
            </label>
            <div class="relative">
              <input
                type="number"
                id="offer_price"
                name="offer_price"
                min="0"
                step="0.01"
                value={product.offer_price || ""}
                class="w-full px-4 py-3 pr-12 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
              />
              <span
                class="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground"
                >€</span
              >
            </div>
          </div>
          <div class="flex items-end">
            <label class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="is_offer"
                name="is_offer"
                checked={product.is_offer}
                class="w-5 h-5 rounded border-border bg-card text-primary focus:ring-primary"
              />
              <span class="text-sm">Es oferta</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Stock by Size -->
      <div class="glass border border-border rounded-xl p-6 space-y-4">
        <h2 class="font-heading text-lg">Stock por Talla</h2>

        <div
          id="sizes-container"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4"
        >
          <!-- Sizes will be rendered dynamically via JS -->
        </div>
      </div>

      <!-- Inject data for JS -->
      <script
        define:vars={{
          sizeMappings,
          categoryTypes,
          existingVariants,
          currentCategoryId: product.category_id,
        }}
      >
        window.sizeMappings = sizeMappings;
        window.categoryTypes = categoryTypes;
        window.existingVariants = existingVariants;
        window.currentCategoryId = currentCategoryId;
      </script>

      <!-- Images - React Component -->
      <div class="glass border border-border rounded-xl p-6 space-y-4">
        <h2 class="font-heading text-lg">Imágenes</h2>
        <p class="text-sm text-muted-foreground">
          Arrastra imágenes o haz click para seleccionar. Se convertirán
          automáticamente a WebP.
        </p>

        <div id="image-uploader-container">
          <ImageUploader
            client:load
            initialImages={sortedImages.map((img: any) => img.image_url)}
            inputName="uploaded_images"
            inputId="uploaded-images"
          />
        </div>
      </div>

      <!-- Status -->
      <div class="glass border border-border rounded-xl p-6">
        <label class="flex items-center gap-3 cursor-pointer">
          <input
            type="checkbox"
            id="active"
            name="active"
            checked={product.active}
            class="w-5 h-5 rounded border-border bg-card text-primary focus:ring-primary"
          />
          <div>
            <span class="font-medium">Producto Activo</span>
            <p class="text-sm text-muted-foreground">
              El producto será visible en la tienda
            </p>
          </div>
        </label>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-4">
        <a
          href="/admin/productos"
          class="px-6 py-3 border border-border rounded-lg hover:bg-muted transition-colors"
        >
          Cancelar
        </a>
        <button
          type="submit"
          id="submit-btn"
          class="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:shadow-[0_0_20px_rgba(204,255,0,0.4)] transition-all disabled:opacity-50"
        >
          Guardar Cambios
        </button>
      </div>

      <div id="form-message" class="hidden p-4 rounded-lg"></div>
    </form>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-card border border-border rounded-xl p-6 max-w-md w-full">
        <h3 class="font-heading text-xl mb-4">¿Eliminar producto?</h3>
        <p class="text-muted-foreground mb-6">
          Esta acción no se puede deshacer. Se eliminarán también todas las
          variantes e imágenes.
        </p>
        <div class="flex justify-end gap-3">
          <button
            id="cancel-delete"
            class="px-4 py-2 border border-border rounded-lg hover:bg-muted"
          >
            Cancelar
          </button>
          <button
            id="confirm-delete"
            class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/80"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Type declarations for window data
    declare global {
      interface Window {
        sizeMappings: Record<string, string[]>;
        categoryTypes: Record<string, string>;
        existingVariants: Record<string, number>;
        currentCategoryId: string | null;
      }
    }

    const productId = (
      document.getElementById("product-id") as HTMLInputElement
    ).value;

    // Dynamic size rendering based on category
    const categorySelect = document.getElementById(
      "category_id"
    ) as HTMLSelectElement;
    const sizesContainer = document.getElementById(
      "sizes-container"
    ) as HTMLDivElement;
    let currentSizes: string[] = [];

    function renderSizes(sizeType: string) {
      const sizes =
        (window.sizeMappings as any)[sizeType] || window.sizeMappings.clothing;
      currentSizes = sizes;

      sizesContainer.innerHTML = sizes
        .map((size: string) => {
          const existingStock = (window.existingVariants as any)[size] || 0;
          return `
          <div>
            <label for="stock-${size}" class="block text-sm font-medium text-muted-foreground mb-2 text-center">
              ${size}
            </label>
            <input
              type="number"
              id="stock-${size}"
              name="stock-${size}"
              min="0"
              value="${existingStock}"
              class="w-full px-4 py-3 bg-card border border-border rounded-lg text-foreground text-center transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            />
          </div>
        `;
        })
        .join("");
    }

    categorySelect?.addEventListener("change", () => {
      const categoryId = categorySelect.value;
      if (categoryId) {
        const sizeType =
          (window.categoryTypes as any)[categoryId] || "clothing";
        renderSizes(sizeType);
      } else {
        sizesContainer.innerHTML = "";
        currentSizes = [];
      }
    });

    // Initialize with current category
    if (window.currentCategoryId) {
      const sizeType =
        (window.categoryTypes as any)[window.currentCategoryId] || "clothing";
      renderSizes(sizeType);
    } else if (categorySelect?.value) {
      const sizeType =
        (window.categoryTypes as any)[categorySelect.value] || "clothing";
      renderSizes(sizeType);
    }

    // Form submission
    const form = document.getElementById("product-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
      "submit-btn"
    ) as HTMLButtonElement;
    const messageDiv = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    // Track form modifications for unsaved changes warning
    let formModified = false;

    // Detect changes in the form
    form?.addEventListener("input", () => {
      formModified = true;
    });

    // Warn before leaving with unsaved changes
    window.addEventListener("beforeunload", (e) => {
      if (formModified) {
        e.preventDefault();
        e.returnValue =
          "¿Seguro que quieres salir? Los cambios no guardados se perderán.";
      }
    });

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = "Guardando...";
      messageDiv.className = "hidden";

      try {
        const formData = new FormData(form);

        const productData = {
          name: formData.get("name"),
          slug: formData.get("slug"),
          description: formData.get("description") || null,
          category_id: formData.get("category_id") || null,
          price: parseFloat(formData.get("price") as string),
          offer_price: formData.get("offer_price")
            ? parseFloat(formData.get("offer_price") as string)
            : null,
          is_offer: formData.get("is_offer") === "on",
          active: formData.get("active") === "on",
        };

        // Frontend validation: offer price must be less than base price
        const price = productData.price as number;
        const offerPrice = productData.offer_price as number | null;
        const isOffer = productData.is_offer as boolean;

        if (isOffer && offerPrice != null && offerPrice >= price) {
          throw new Error(
            "El precio de oferta debe ser menor que el precio base"
          );
        }

        // Get stock values from dynamically rendered sizes
        const variants: { size: string; stock: number }[] = [];
        currentSizes.forEach((size) => {
          const stock = parseInt(formData.get(`stock-${size}`) as string) || 0;
          variants.push({ size, stock });
        });

        const imageInputs = formData.get("uploaded_images");
        let images: string[] = [];
        if (imageInputs) {
          try {
            images = JSON.parse(imageInputs as string);
          } catch (e) {
            console.error("Error parsing images", e);
          }
        }

        // Also support manual images array just in case (though we removed the UI)
        // const manualImages = formData.getAll("images[]"); ...

        const response = await fetch("/api/admin/productos", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: productId,
            product: productData,
            variants,
            images,
          }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error al guardar");
        }

        messageDiv.className = "p-4 rounded-lg bg-primary/20 text-primary";
        messageDiv.textContent = "✅ Cambios guardados correctamente";

        // Clear form modified flag after successful save
        formModified = false;

        submitBtn.disabled = false;
        submitBtn.textContent = "Guardar Cambios";
      } catch (error: any) {
        messageDiv.className = "p-4 rounded-lg bg-accent/20 text-accent";
        messageDiv.textContent = error.message;
        submitBtn.disabled = false;
        submitBtn.textContent = "Guardar Cambios";
      }
    });

    // Delete handling
    const deleteBtn = document.getElementById("delete-btn");
    const deleteModal = document.getElementById("delete-modal");
    const cancelDelete = document.getElementById("cancel-delete");
    const confirmDelete = document.getElementById("confirm-delete");

    deleteBtn?.addEventListener("click", () => {
      deleteModal?.classList.remove("hidden");
    });

    cancelDelete?.addEventListener("click", () => {
      deleteModal?.classList.add("hidden");
    });

    confirmDelete?.addEventListener("click", async () => {
      try {
        const response = await fetch("/api/admin/productos", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: productId }),
        });

        if (response.ok) {
          window.location.href = "/admin/productos?deleted=true";
        } else {
          const result = await response.json();
          alert("Error: " + result.error);
        }
      } catch (error: any) {
        alert("Error: " + error.message);
      }
    });
  </script>
</AdminLayout>

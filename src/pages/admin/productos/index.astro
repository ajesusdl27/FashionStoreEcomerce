---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import ProductsList from "@/components/islands/admin/ProductsList";

// Fetch products with category and first image
const { data: products, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .is("deleted_at", null) // Exclude soft-deleted products
  .order("created_at", { ascending: false });

// Fetch categories for filter
const { data: categories } = await supabase
  .from("categories")
  .select("id, name")
  .order("name");

const uniqueCategories = categories || [];
---

<AdminLayout title="Productos">
  {
    error ? (
      <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-600 dark:text-red-400">
        Error cargando productos: {error.message}
      </div>
    ) : (
      <ProductsList 
        client:load 
        initialProducts={products || []} 
        categories={uniqueCategories}
      />
    )
  }
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";

// Fetch products with category and first image
const { data: products, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .order("created_at", { ascending: false });

// Fetch categories for filter
const { data: categories } = await supabase
  .from("categories")
  .select("id, name")
  .order("name");

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const getTotalStock = (variants: { stock: number }[]) => {
  return variants?.reduce((sum, v) => sum + v.stock, 0) || 0;
};

const getFirstImage = (images: { image_url: string; order: number }[]) => {
  if (!images || images.length === 0) return "/placeholder.jpg";
  const sorted = [...images].sort((a, b) => a.order - b.order);
  return sorted[0].image_url;
};

// Extract unique category names for filter
const uniqueCategories = categories || [];
---

<AdminLayout title="Productos">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
    >
      <div>
        <h1 class="font-display text-3xl text-primary">Productos</h1>
        <p class="text-muted-foreground mt-1" id="products-count">
          {products?.length || 0} productos
        </p>
      </div>
      <a
        href="/admin/productos/nuevo"
        class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:shadow-[0_0_20px_rgba(204,255,0,0.4)] transition-all"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Producto
      </a>
    </div>

    <!-- Filters -->
    <div class="glass border border-border rounded-xl p-4">
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- Search -->
        <div class="relative flex-1">
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Buscar productos..."
            class="w-full pl-10 pr-4 py-2.5 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
          />
        </div>

        <!-- Category Filter -->
        <select
          id="category-filter"
          class="px-4 py-2.5 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary min-w-[180px]"
        >
          <option value="">Todas las categorías</option>
          {
            uniqueCategories.map((cat) => (
              <option value={cat.id}>{cat.name}</option>
            ))
          }
        </select>

        <!-- Status Filter -->
        <select
          id="status-filter"
          class="px-4 py-2.5 bg-card border border-border rounded-lg text-foreground transition-all focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary min-w-[140px]"
        >
          <option value="">Todos los estados</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
          <option value="offer">En oferta</option>
          <option value="low-stock">Stock bajo</option>
        </select>
      </div>
    </div>

    {
      error && (
        <div class="p-4 bg-accent/20 border border-accent rounded-lg text-accent">
          Error cargando productos: {error.message}
        </div>
      )
    }

    <!-- Products Table -->
    <div class="glass border border-border rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full" id="products-table">
          <thead class="bg-muted/50 border-b border-border">
            <tr>
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Producto</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Categoría</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Precio</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Stock</th
              >
              <th
                class="text-left px-6 py-4 text-sm font-medium text-muted-foreground"
                >Estado</th
              >
              <th
                class="text-right px-6 py-4 text-sm font-medium text-muted-foreground"
                >Acciones</th
              >
            </tr>
          </thead>
          <tbody class="divide-y divide-border" id="products-tbody">
            {
              products && products.length > 0 ? (
                products.map((product: any) => {
                  const totalStock = getTotalStock(product.variants);
                  return (
                    <tr
                      class="hover:bg-muted/30 transition-colors product-row"
                      data-name={product.name.toLowerCase()}
                      data-slug={product.slug.toLowerCase()}
                      data-category-id={product.category?.id || ""}
                      data-category-name={
                        product.category?.name?.toLowerCase() || "sin categoría"
                      }
                      data-active={product.active ? "true" : "false"}
                      data-offer={product.is_offer ? "true" : "false"}
                      data-stock={totalStock}
                    >
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                          <img
                            src={getFirstImage(product.images)}
                            alt={product.name}
                            class="w-12 h-12 object-cover rounded-lg"
                          />
                          <div>
                            <p class="font-medium">{product.name}</p>
                            <p class="text-sm text-muted-foreground">
                              {product.slug}
                            </p>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <span class="px-2 py-1 bg-muted rounded text-sm">
                          {product.category?.name || "Sin categoría"}
                        </span>
                      </td>
                      <td class="px-6 py-4">
                        <div>
                          {product.is_offer && product.offer_price ? (
                            <>
                              <p class="text-sm text-muted-foreground line-through">
                                {formatPrice(product.price)}
                              </p>
                              <p class="font-medium text-accent">
                                {formatPrice(product.offer_price)}
                              </p>
                            </>
                          ) : (
                            <p class="font-medium">
                              {formatPrice(product.price)}
                            </p>
                          )}
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <span
                          class={`px-2 py-1 rounded text-sm ${
                            totalStock === 0
                              ? "bg-accent/20 text-accent"
                              : totalStock < 10
                                ? "bg-yellow-500/20 text-yellow-400"
                                : "bg-primary/20 text-primary"
                          }`}
                        >
                          {totalStock} uds
                        </span>
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                          {product.active ? (
                            <span class="px-2 py-1 bg-primary/20 text-primary rounded text-sm">
                              Activo
                            </span>
                          ) : (
                            <span class="px-2 py-1 bg-muted text-muted-foreground rounded text-sm">
                              Inactivo
                            </span>
                          )}
                          {product.is_offer && (
                            <span class="px-2 py-1 bg-accent/20 text-accent rounded text-sm">
                              Oferta
                            </span>
                          )}
                        </div>
                      </td>
                      <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                          <a
                            href={`/admin/productos/${product.id}`}
                            class="p-2 hover:bg-muted rounded-lg transition-colors"
                            title="Editar"
                          >
                            <svg
                              class="w-5 h-5"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                              />
                            </svg>
                          </a>
                          <a
                            href={`/productos/${product.slug}`}
                            target="_blank"
                            class="p-2 hover:bg-muted rounded-lg transition-colors"
                            title="Ver en tienda"
                          >
                            <svg
                              class="w-5 h-5"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                              />
                            </svg>
                          </a>
                        </div>
                      </td>
                    </tr>
                  );
                })
              ) : (
                <tr id="empty-row">
                  <td
                    colspan="6"
                    class="px-6 py-12 text-center text-muted-foreground"
                  >
                    <svg
                      class="w-16 h-16 mx-auto mb-4 opacity-50"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>
                    <p>No hay productos todavía</p>
                    <a
                      href="/admin/productos/nuevo"
                      class="inline-block mt-4 text-primary hover:underline"
                    >
                      Crear primer producto →
                    </a>
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>

      <!-- No results message (hidden by default) -->
      <div
        id="no-results"
        class="hidden p-12 text-center text-muted-foreground"
      >
        <svg
          class="w-16 h-16 mx-auto mb-4 opacity-50"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <p>No se encontraron productos con los filtros actuales</p>
        <button id="clear-filters" class="mt-4 text-primary hover:underline">
          Limpiar filtros
        </button>
      </div>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById(
      "search-input"
    ) as HTMLInputElement;
    const categoryFilter = document.getElementById(
      "category-filter"
    ) as HTMLSelectElement;
    const statusFilter = document.getElementById(
      "status-filter"
    ) as HTMLSelectElement;
    const productsCount = document.getElementById(
      "products-count"
    ) as HTMLParagraphElement;
    const noResultsDiv = document.getElementById(
      "no-results"
    ) as HTMLDivElement;
    const clearFiltersBtn = document.getElementById(
      "clear-filters"
    ) as HTMLButtonElement;
    const productRows = document.querySelectorAll(
      ".product-row"
    ) as NodeListOf<HTMLTableRowElement>;
    const emptyRow = document.getElementById(
      "empty-row"
    ) as HTMLTableRowElement | null;

    function filterProducts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const categoryId = categoryFilter.value;
      const status = statusFilter.value;

      let visibleCount = 0;

      productRows.forEach((row) => {
        const name = row.dataset.name || "";
        const slug = row.dataset.slug || "";
        const rowCategoryId = row.dataset.categoryId || "";
        const isActive = row.dataset.active === "true";
        const isOffer = row.dataset.offer === "true";
        const stock = parseInt(row.dataset.stock || "0", 10);

        // Search filter
        const matchesSearch =
          searchTerm === "" ||
          name.includes(searchTerm) ||
          slug.includes(searchTerm);

        // Category filter
        const matchesCategory =
          categoryId === "" || rowCategoryId === categoryId;

        // Status filter
        let matchesStatus = true;
        if (status === "active") {
          matchesStatus = isActive;
        } else if (status === "inactive") {
          matchesStatus = !isActive;
        } else if (status === "offer") {
          matchesStatus = isOffer;
        } else if (status === "low-stock") {
          matchesStatus = stock < 10;
        }

        const isVisible = matchesSearch && matchesCategory && matchesStatus;
        row.style.display = isVisible ? "" : "none";

        if (isVisible) {
          visibleCount++;
        }
      });

      // Update count
      productsCount.textContent = `${visibleCount} producto${visibleCount !== 1 ? "s" : ""}`;

      // Show/hide no results message
      if (visibleCount === 0 && productRows.length > 0) {
        noResultsDiv.classList.remove("hidden");
        if (emptyRow) emptyRow.style.display = "none";
      } else {
        noResultsDiv.classList.add("hidden");
      }
    }

    // Event listeners
    searchInput?.addEventListener("input", filterProducts);
    categoryFilter?.addEventListener("change", filterProducts);
    statusFilter?.addEventListener("change", filterProducts);

    clearFiltersBtn?.addEventListener("click", () => {
      searchInput.value = "";
      categoryFilter.value = "";
      statusFilter.value = "";
      filterProducts();
    });
  </script>
</AdminLayout>

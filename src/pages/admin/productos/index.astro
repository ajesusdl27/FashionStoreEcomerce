---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";

// Fetch products with category and first image
const { data: products, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .order("created_at", { ascending: false });

// Fetch categories for filter
const { data: categories } = await supabase
  .from("categories")
  .select("id, name")
  .order("name");

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const getTotalStock = (variants: { stock: number }[]) => {
  return variants?.reduce((sum, v) => sum + v.stock, 0) || 0;
};

const getFirstImage = (images: { image_url: string; order: number }[]) => {
  if (!images || images.length === 0) return "/placeholder.jpg";
  const sorted = [...images].sort((a, b) => a.order - b.order);
  return sorted[0]?.image_url || "/placeholder.jpg";
};

const uniqueCategories = categories || [];
---

<AdminLayout title="Productos">
  <div class="space-y-6">
    <!-- Header -->
    <div
      class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
    >
      <p class="text-zinc-400" id="products-count">
        {products?.length || 0} productos en total
      </p>
      <a href="/admin/productos/nuevo" class="admin-btn-primary">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Producto
      </a>
    </div>

    <!-- Filters -->
    <div class="admin-filter-bar">
      <div class="flex flex-col md:flex-row gap-4">
        <!-- Search -->
        <div class="relative flex-1">
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-zinc-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Buscar por nombre o slug..."
            class="admin-input pl-10"
          />
        </div>

        <!-- Category Filter -->
        <select id="category-filter" class="admin-select md:w-48">
          <option value="">Todas las categorías</option>
          {
            uniqueCategories.map((cat) => (
              <option value={cat.id}>{cat.name}</option>
            ))
          }
        </select>

        <!-- Status Filter -->
        <select id="status-filter" class="admin-select md:w-40">
          <option value="">Todos</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
          <option value="offer">En oferta</option>
          <option value="low-stock">Stock bajo</option>
        </select>
      </div>
    </div>

    {
      error && (
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400">
          Error cargando productos: {error.message}
        </div>
      )
    }

    <!-- Products List as Cards (Better for this design) -->
    <div class="space-y-2" id="products-list">
      {
        products && products.length > 0 ? (
          products.map((product: any) => {
            const totalStock = getTotalStock(product.variants);
            return (
              <div
                class="product-row bg-zinc-900/50 hover:bg-zinc-800/70 border border-zinc-800 rounded-lg p-4 transition-all"
                data-name={product.name.toLowerCase()}
                data-slug={product.slug.toLowerCase()}
                data-category-id={product.category?.id || ""}
                data-active={product.active ? "true" : "false"}
                data-offer={product.is_offer ? "true" : "false"}
                data-stock={totalStock}
              >
                <div class="flex items-center gap-4">
                  {/* Image */}
                  <div class="flex-shrink-0">
                    <img
                      src={getFirstImage(product.images)}
                      alt={product.name}
                      class="w-16 h-16 object-cover rounded-lg bg-zinc-800 ring-1 ring-zinc-700"
                    />
                  </div>

                  {/* Main Info */}
                  <div class="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                    {/* Product Name & Slug */}
                    <div class="md:col-span-2">
                      <p class="font-semibold text-foreground truncate">
                        {product.name}
                      </p>
                      <p class="text-xs text-zinc-500 truncate">
                        {product.slug}
                      </p>
                    </div>

                    {/* Category */}
                    <div>
                      <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-zinc-700 text-zinc-200">
                        {product.category?.name || "Sin categoría"}
                      </span>
                    </div>

                    {/* Price */}
                    <div class="text-right">
                      {product.is_offer && product.offer_price ? (
                        <div>
                          <p class="text-xs text-zinc-500 line-through">
                            {formatPrice(product.price)}
                          </p>
                          <p class="font-bold text-red-400">
                            {formatPrice(product.offer_price)}
                          </p>
                        </div>
                      ) : (
                        <p class="font-bold tabular-nums text-foreground">
                          {formatPrice(product.price)}
                        </p>
                      )}
                    </div>

                    {/* Stock & Status */}
                    <div class="flex items-center justify-end gap-2 flex-wrap">
                      <span
                        class={`inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold ${
                          totalStock === 0
                            ? "bg-red-500/20 text-red-400"
                            : totalStock < 10
                              ? "bg-yellow-500/20 text-yellow-400"
                              : "bg-green-500/20 text-green-400"
                        }`}
                      >
                        {totalStock} uds
                      </span>
                      {product.active ? (
                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-green-500/20 text-green-400">
                          Activo
                        </span>
                      ) : (
                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-zinc-600/50 text-zinc-400">
                          Inactivo
                        </span>
                      )}
                      {product.is_offer && (
                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-red-500/20 text-red-400">
                          Oferta
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Actions */}
                  <div class="flex items-center gap-1 flex-shrink-0">
                    <a
                      href={`/admin/productos/${product.id}`}
                      class="p-2 rounded-lg hover:bg-zinc-700 transition-colors"
                      title="Editar"
                    >
                      <svg
                        class="w-5 h-5 text-zinc-400 hover:text-foreground"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                        />
                      </svg>
                    </a>
                    <a
                      href={`/productos/${product.slug}`}
                      target="_blank"
                      class="p-2 rounded-lg hover:bg-zinc-700 transition-colors"
                      title="Ver en tienda"
                    >
                      <svg
                        class="w-5 h-5 text-zinc-400 hover:text-foreground"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            );
          })
        ) : (
          <div class="text-center py-12 text-zinc-500">
            <svg
              class="w-16 h-16 mx-auto mb-4 opacity-30"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              />
            </svg>
            <p>No hay productos todavía</p>
            <a
              href="/admin/productos/nuevo"
              class="inline-block mt-4 text-primary hover:underline"
            >
              Crear primer producto →
            </a>
          </div>
        )
      }
    </div>

    <!-- No results message (hidden by default) -->
    <div
      id="no-results"
      class="hidden p-12 text-center text-zinc-500 bg-zinc-900/50 rounded-lg border border-zinc-800"
    >
      <svg
        class="w-16 h-16 mx-auto mb-4 opacity-30"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <p>No se encontraron productos</p>
      <button id="clear-filters" class="mt-4 text-primary hover:underline">
        Limpiar filtros
      </button>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById(
      "search-input"
    ) as HTMLInputElement;
    const categoryFilter = document.getElementById(
      "category-filter"
    ) as HTMLSelectElement;
    const statusFilter = document.getElementById(
      "status-filter"
    ) as HTMLSelectElement;
    const productsCount = document.getElementById(
      "products-count"
    ) as HTMLParagraphElement;
    const noResultsDiv = document.getElementById(
      "no-results"
    ) as HTMLDivElement;
    const clearFiltersBtn = document.getElementById(
      "clear-filters"
    ) as HTMLButtonElement;
    const productRows = document.querySelectorAll(
      ".product-row"
    ) as NodeListOf<HTMLElement>;

    function filterProducts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const categoryId = categoryFilter.value;
      const status = statusFilter.value;

      let visibleCount = 0;

      productRows.forEach((row) => {
        const name = row.dataset.name || "";
        const slug = row.dataset.slug || "";
        const rowCategoryId = row.dataset.categoryId || "";
        const isActive = row.dataset.active === "true";
        const isOffer = row.dataset.offer === "true";
        const stock = parseInt(row.dataset.stock || "0", 10);

        const matchesSearch =
          searchTerm === "" ||
          name.includes(searchTerm) ||
          slug.includes(searchTerm);
        const matchesCategory =
          categoryId === "" || rowCategoryId === categoryId;

        let matchesStatus = true;
        if (status === "active") matchesStatus = isActive;
        else if (status === "inactive") matchesStatus = !isActive;
        else if (status === "offer") matchesStatus = isOffer;
        else if (status === "low-stock") matchesStatus = stock < 10;

        const isVisible = matchesSearch && matchesCategory && matchesStatus;
        row.style.display = isVisible ? "" : "none";
        if (isVisible) visibleCount++;
      });

      productsCount.textContent = `${visibleCount} producto${visibleCount !== 1 ? "s" : ""} encontrado${visibleCount !== 1 ? "s" : ""}`;

      if (visibleCount === 0 && productRows.length > 0) {
        noResultsDiv.classList.remove("hidden");
      } else {
        noResultsDiv.classList.add("hidden");
      }
    }

    searchInput?.addEventListener("input", filterProducts);
    categoryFilter?.addEventListener("change", filterProducts);
    statusFilter?.addEventListener("change", filterProducts);

    clearFiltersBtn?.addEventListener("click", () => {
      searchInput.value = "";
      categoryFilter.value = "";
      statusFilter.value = "";
      filterProducts();
    });
  </script>
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import WysiwygEditor from "@/components/islands/WysiwygEditor";
---

<AdminLayout title="Nueva CampaÃ±a - Newsletter">
  <div class="max-w-3xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a
        href="/admin/newsletter"
        class="p-2 hover:bg-muted rounded-lg transition-colors"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <div>
        <h1 class="text-2xl font-bold text-foreground">Nueva CampaÃ±a</h1>
        <p class="text-muted-foreground">
          Crea un nuevo email para tus suscriptores
        </p>
      </div>
    </div>

    <!-- Form -->
    <form id="campaign-form" class="space-y-6">
      <div class="admin-card space-y-4">
        <div>
          <label class="block text-sm font-medium text-foreground mb-2"
            >Asunto *</label
          >
          <input
            type="text"
            id="subject"
            name="subject"
            class="admin-input w-full"
            placeholder="Â¡Novedades de esta semana!"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-foreground mb-2"
            >Contenido *</label
          >
          
          <!-- Tab switcher -->
          <div class="flex gap-2 mb-3">
            <button
              type="button"
              id="tab-wysiwyg"
              class="px-3 py-1.5 text-sm rounded-lg bg-primary text-primary-foreground"
            >
              Editor Visual
            </button>
            <button
              type="button"
              id="tab-html"
              class="px-3 py-1.5 text-sm rounded-lg bg-secondary text-secondary-foreground"
            >
              HTML
            </button>
          </div>

          <!-- WYSIWYG Editor -->
          <div id="editor-wysiwyg">
            <WysiwygEditor 
              client:load
              content=""
              onChange={(html: string) => {
                const contentInput = document.getElementById('content') as HTMLTextAreaElement;
                if (contentInput) contentInput.value = html;
              }}
              placeholder="Escribe el contenido de tu email aquÃ­..."
            />
          </div>
          
          <!-- HTML Editor (hidden by default) -->
          <div id="editor-html" class="hidden">
            <textarea
              id="content-html"
              rows="15"
              class="admin-input w-full font-mono text-sm"
              placeholder="Escribe HTML aquÃ­..."
            ></textarea>
          </div>
          
          <!-- Hidden field to store content -->
          <input type="hidden" id="content" name="content" />
          
          <p class="text-xs text-muted-foreground mt-2">
            Usa el editor visual o escribe HTML directamente.
          </p>
        </div>
      </div>

      <div class="flex gap-4">
        <button
          type="button"
          id="save-draft"
          class="flex-1 py-3 px-4 bg-secondary text-secondary-foreground rounded-lg font-medium hover:bg-secondary/80 transition-colors"
        >
          ðŸ’¾ Guardar Borrador
        </button>
        <button
          type="button"
          id="save-and-send"
          class="flex-1 py-3 px-4 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
        >
          ðŸ“¤ Guardar y Enviar
        </button>
      </div>

      <div id="form-message" class="hidden p-4 rounded-lg text-sm"></div>
    </form>
  </div>

  <script>
    const subjectInput = document.getElementById("subject") as HTMLInputElement;
    const contentInput = document.getElementById("content") as HTMLInputElement;
    const contentHtmlTextarea = document.getElementById("content-html") as HTMLTextAreaElement;
    const saveDraftBtn = document.getElementById("save-draft");
    const saveAndSendBtn = document.getElementById("save-and-send");
    const messageDiv = document.getElementById("form-message");
    
    // Tab switching
    const tabWysiwyg = document.getElementById("tab-wysiwyg");
    const tabHtml = document.getElementById("tab-html");
    const editorWysiwyg = document.getElementById("editor-wysiwyg");
    const editorHtml = document.getElementById("editor-html");
    
    let activeTab: 'wysiwyg' | 'html' = 'wysiwyg';

    function switchTab(tab: 'wysiwyg' | 'html') {
      activeTab = tab;
      
      if (tab === 'wysiwyg') {
        tabWysiwyg?.classList.replace('bg-secondary', 'bg-primary');
        tabWysiwyg?.classList.replace('text-secondary-foreground', 'text-primary-foreground');
        tabHtml?.classList.replace('bg-primary', 'bg-secondary');
        tabHtml?.classList.replace('text-primary-foreground', 'text-secondary-foreground');
        editorWysiwyg?.classList.remove('hidden');
        editorHtml?.classList.add('hidden');
        
        // Sync HTML to WYSIWYG would require re-initializing the editor
        // For now, we just show a warning if there's content
        if (contentHtmlTextarea?.value) {
          contentInput.value = contentHtmlTextarea.value;
        }
      } else {
        tabHtml?.classList.replace('bg-secondary', 'bg-primary');
        tabHtml?.classList.replace('text-secondary-foreground', 'text-primary-foreground');
        tabWysiwyg?.classList.replace('bg-primary', 'bg-secondary');
        tabWysiwyg?.classList.replace('text-primary-foreground', 'text-secondary-foreground');
        editorWysiwyg?.classList.add('hidden');
        editorHtml?.classList.remove('hidden');
        
        // Sync WYSIWYG content to HTML textarea
        if (contentInput?.value) {
          contentHtmlTextarea.value = contentInput.value;
        }
      }
    }

    tabWysiwyg?.addEventListener('click', () => switchTab('wysiwyg'));
    tabHtml?.addEventListener('click', () => switchTab('html'));
    
    // Sync HTML textarea changes to hidden input
    contentHtmlTextarea?.addEventListener('input', () => {
      contentInput.value = contentHtmlTextarea.value;
    });

    async function saveCampaign(andSend: boolean) {
      const subject = subjectInput.value.trim();
      
      // Get content from active editor
      let content = contentInput.value.trim();
      if (activeTab === 'html') {
        content = contentHtmlTextarea.value.trim();
      }

      if (!subject || !content) {
        showMessage("Por favor, completa todos los campos", "error");
        return;
      }

      try {
        const response = await fetch("/api/admin/newsletter/campaigns", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subject, content }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error al guardar");
        }

        if (andSend) {
          window.location.href = `/admin/newsletter/send/${result.id}`;
        } else {
          showMessage("Borrador guardado correctamente", "success");
          setTimeout(() => {
            window.location.href = "/admin/newsletter";
          }, 1000);
        }
      } catch (error: any) {
        showMessage(error.message, "error");
      }
    }

    function showMessage(text: string, type: "success" | "error") {
      if (!messageDiv) return;
      messageDiv.textContent = text;
      messageDiv.classList.remove("hidden");
      messageDiv.className = `p-4 rounded-lg text-sm ${
        type === "success"
          ? "bg-green-500/20 text-green-400"
          : "bg-destructive/10 text-destructive"
      }`;
    }

    saveDraftBtn?.addEventListener("click", () => saveCampaign(false));
    saveAndSendBtn?.addEventListener("click", () => saveCampaign(true));
  </script>
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import { CAMPAIGN_STATUS, CAMPAIGN_STATUS_LABELS } from "@/lib/constants/newsletter";

const { id } = Astro.params;

// Fetch campaign
const { data: campaign, error } = await supabase
  .from("newsletter_campaigns")
  .select("*")
  .eq("id", id)
  .single();

if (error || !campaign) {
  return Astro.redirect("/admin/newsletter?error=not-found");
}

// Only allow editing drafts and failed campaigns
const canEdit = campaign.status === CAMPAIGN_STATUS.DRAFT || campaign.status === CAMPAIGN_STATUS.FAILED;
if (!canEdit) {
  return Astro.redirect(`/admin/newsletter?error=cannot-edit-${campaign.status}`);
}

const statusLabel = CAMPAIGN_STATUS_LABELS[campaign.status as keyof typeof CAMPAIGN_STATUS_LABELS] || campaign.status;
---

<AdminLayout title={`Editar: ${campaign.subject}`}>
  <div class="max-w-3xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a
        href="/admin/newsletter"
        class="p-2 hover:bg-muted rounded-lg transition-colors"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <div>
        <h1 class="text-2xl font-bold text-foreground">Editar Campa침a</h1>
        <p class="text-muted-foreground">
          Estado actual: <span class="font-medium">{statusLabel}</span>
        </p>
      </div>
    </div>

    <!-- Failed campaign warning -->
    {campaign.status === CAMPAIGN_STATUS.FAILED && campaign.last_error && (
      <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
        <p class="text-sm text-red-400">
          <strong>丘멆잺 Esta campa침a fall칩:</strong> {campaign.last_error}
        </p>
        <p class="text-xs text-red-400/70 mt-1">
          Puedes editarla y volver a intentar el env칤o.
        </p>
      </div>
    )}

    <!-- Form -->
    <form id="campaign-form" class="space-y-6">
      <div class="admin-card space-y-4">
        <div>
          <label class="block text-sm font-medium text-foreground mb-2"
            >Asunto *</label
          >
          <input
            type="text"
            id="subject"
            name="subject"
            class="admin-input w-full"
            value={campaign.subject}
            placeholder="춰Novedades de esta semana!"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-foreground mb-2"
            >Contenido *</label
          >
          <textarea
            id="content"
            name="content"
            rows="15"
            class="admin-input w-full font-mono text-sm"
            placeholder="Escribe el contenido de tu email aqu칤..."
            required>{campaign.content}</textarea>
          <p class="text-xs text-muted-foreground mt-2">
            Puedes usar HTML para formatear el contenido.
          </p>
        </div>
      </div>

      <div class="flex gap-4">
        <button
          type="button"
          id="save-draft"
          class="flex-1 py-3 px-4 bg-secondary text-secondary-foreground rounded-lg font-medium hover:bg-secondary/80 transition-colors"
        >
          游 Guardar Cambios
        </button>
        <button
          type="button"
          id="save-and-send"
          class="flex-1 py-3 px-4 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
        >
          游닋 Guardar y Enviar
        </button>
      </div>

      <div id="form-message" class="hidden p-4 rounded-lg text-sm"></div>
    </form>

    <!-- Danger Zone -->
    <div class="admin-card border-red-500/30">
      <h3 class="text-sm font-medium text-red-400 mb-3">Zona de peligro</h3>
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-foreground">Eliminar campa침a</p>
          <p class="text-xs text-muted-foreground">Esta acci칩n no se puede deshacer.</p>
        </div>
        <button
          id="delete-campaign"
          class="px-4 py-2 bg-red-500/10 text-red-400 rounded-lg text-sm font-medium hover:bg-red-500/20 transition-colors"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <script define:vars={{ campaignId: id }}>
    window.campaignId = campaignId;
  </script>

  <script>
    const subjectInput = document.getElementById("subject") as HTMLInputElement;
    const contentInput = document.getElementById("content") as HTMLTextAreaElement;
    const saveDraftBtn = document.getElementById("save-draft");
    const saveAndSendBtn = document.getElementById("save-and-send");
    const deleteCampaignBtn = document.getElementById("delete-campaign");
    const messageDiv = document.getElementById("form-message");
    const campaignId = (window as any).campaignId;

    async function updateCampaign(andSend: boolean) {
      const subject = subjectInput.value.trim();
      const content = contentInput.value.trim();

      if (!subject || !content) {
        showMessage("Por favor, completa todos los campos", "error");
        return;
      }

      // Disable buttons during save
      if (saveDraftBtn) (saveDraftBtn as HTMLButtonElement).disabled = true;
      if (saveAndSendBtn) (saveAndSendBtn as HTMLButtonElement).disabled = true;

      try {
        const response = await fetch("/api/admin/newsletter/update-campaign", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: campaignId, subject, content }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error al guardar");
        }

        if (andSend) {
          window.location.href = `/admin/newsletter/send/${campaignId}`;
        } else {
          showMessage("Cambios guardados correctamente", "success");
          setTimeout(() => {
            window.location.href = "/admin/newsletter";
          }, 1000);
        }
      } catch (error: any) {
        showMessage(error.message, "error");
        if (saveDraftBtn) (saveDraftBtn as HTMLButtonElement).disabled = false;
        if (saveAndSendBtn) (saveAndSendBtn as HTMLButtonElement).disabled = false;
      }
    }

    async function deleteCampaign() {
      if (!confirm("쮼st치s seguro de que quieres eliminar esta campa침a? Esta acci칩n no se puede deshacer.")) {
        return;
      }

      try {
        const response = await fetch("/api/admin/newsletter/delete-campaign", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: campaignId }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error al eliminar");
        }

        window.location.href = "/admin/newsletter?deleted=true";
      } catch (error: any) {
        showMessage(error.message, "error");
      }
    }

    function showMessage(text: string, type: "success" | "error") {
      if (!messageDiv) return;
      messageDiv.textContent = text;
      messageDiv.classList.remove("hidden");
      messageDiv.className = `p-4 rounded-lg text-sm ${
        type === "success"
          ? "bg-green-500/20 text-green-400"
          : "bg-destructive/10 text-destructive"
      }`;
    }

    saveDraftBtn?.addEventListener("click", () => updateCampaign(false));
    saveAndSendBtn?.addEventListener("click", () => updateCampaign(true));
    deleteCampaignBtn?.addEventListener("click", deleteCampaign);
  </script>
</AdminLayout>

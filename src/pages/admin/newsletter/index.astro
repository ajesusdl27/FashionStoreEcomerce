---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createAuthenticatedClient } from "@/lib/supabase";
import { CAMPAIGN_STATUS, CAMPAIGN_STATUS_LABELS, CAMPAIGN_STATUS_COLORS, type CampaignStatus } from "@/lib/constants/newsletter";

// Get auth tokens from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;
const supabase = createAuthenticatedClient(accessToken, refreshToken);

// Fetch campaigns and subscriber count
const { data: campaigns } = await supabase
  .from("newsletter_campaigns")
  .select("*")
  .order("created_at", { ascending: false });

const { count: subscriberCount } = await supabase
  .from("newsletter_subscribers")
  .select("*", { count: "exact", head: true })
  .eq("is_active", true);

// Fetch coupon BIENVENIDA10 metrics
const { data: welcomeCoupon } = await supabase
  .from("coupons")
  .select("id, code, current_uses")
  .eq("code", "BIENVENIDA10")
  .single();

// Get usage count and calculate revenue for BIENVENIDA10
let couponUsageCount = 0;
let couponRevenue = 0;
let conversionRate = 0;

if (welcomeCoupon) {
  couponUsageCount = welcomeCoupon.current_uses || 0;
  
  // Get orders that used this coupon
  const { data: couponUsages } = await supabase
    .from("coupon_usages")
    .select("order_id")
    .eq("coupon_id", welcomeCoupon.id);
  
  if (couponUsages && couponUsages.length > 0) {
    const orderIds = couponUsages.map(u => u.order_id).filter(Boolean);
    if (orderIds.length > 0) {
      const { data: orders } = await supabase
        .from("orders")
        .select("total")
        .in("id", orderIds);
      
      if (orders) {
        couponRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
      }
    }
  }
  
  // Calculate conversion rate (subscribers who used the coupon)
  if (subscriberCount && subscriberCount > 0) {
    conversionRate = (couponUsageCount / subscriberCount) * 100;
  }
}

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
};

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount);
};

// Helper to get status label and color
const getStatusInfo = (status: string) => {
  const typedStatus = status as CampaignStatus;
  return {
    label: CAMPAIGN_STATUS_LABELS[typedStatus] || status,
    color: CAMPAIGN_STATUS_COLORS[typedStatus] || 'bg-muted text-muted-foreground'
  };
};
---

<AdminLayout title="Newsletter">
  <div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-foreground">Newsletter</h1>
        <p class="text-muted-foreground">
          Gestiona tus campañas y suscriptores
        </p>
      </div>
      <a href="/admin/newsletter/new" class="admin-btn-primary">
        + Nueva Campaña
      </a>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Suscriptores Activos</p>
        <p class="text-3xl font-bold text-primary">{subscriberCount || 0}</p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Campañas Enviadas</p>
        <p class="text-3xl font-bold text-foreground">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.SENT).length || 0}
        </p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Borradores</p>
        <p class="text-3xl font-bold text-foreground">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.DRAFT).length || 0}
        </p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Fallidas</p>
        <p class="text-3xl font-bold text-red-400">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.FAILED).length || 0}
        </p>
      </div>
    </div>

    <!-- BIENVENIDA10 Coupon Metrics -->
    <div class="admin-card">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="font-semibold text-lg text-foreground flex items-center gap-2">
              Promoción Newsletter
            <span class="px-2 py-0.5 bg-primary/10 text-primary text-xs font-medium rounded">BIENVENIDA10</span>
          </h2>
          <p class="text-sm text-muted-foreground">Métricas del cupón de bienvenida del 10%</p>
        </div>
        <a href="/admin/cupones" class="text-sm text-primary hover:underline">
          Gestionar cupones →
        </a>
      </div>
      
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-muted/50 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p class="text-sm text-muted-foreground">Usos del Cupón</p>
          </div>
          <p class="text-2xl font-bold text-foreground">{couponUsageCount}</p>
          <p class="text-xs text-muted-foreground mt-1">
            {welcomeCoupon ? 'Total de veces usado' : 'Cupón no configurado'}
          </p>
        </div>
        
        <div class="bg-muted/50 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 7c-.7-1.5-2.5-3-5-3-4.5 0-7 3.5-7 8s2.5 8 7 8c2.5 0 4.3-1.5 5-3"></path>
              <path d="M3 10h8"></path>
              <path d="M3 14h8"></path>
            </svg>
            <p class="text-sm text-muted-foreground">Revenue Generado</p>
          </div>
          <p class="text-2xl font-bold text-green-500">{formatCurrency(couponRevenue)}</p>
          <p class="text-xs text-muted-foreground mt-1">Pedidos con cupón</p>
        </div>
        
        <div class="bg-muted/50 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <p class="text-sm text-muted-foreground">Tasa de Conversión</p>
          </div>
          <p class="text-2xl font-bold text-foreground">{conversionRate.toFixed(1)}%</p>
          <p class="text-xs text-muted-foreground mt-1">Suscriptores que compraron</p>
        </div>
      </div>
      
      {!welcomeCoupon && (
        <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
          <p class="text-sm text-yellow-600 dark:text-yellow-400">
            ⚠️ El cupón <strong>BIENVENIDA10</strong> no está configurado. 
            <a href="/admin/cupones" class="underline hover:no-underline">Créalo aquí</a> para activar la promoción del newsletter.
          </p>
        </div>
      )}
    </div>

    <!-- Quick Links -->
    <div class="flex gap-4">
      <a
        href="/admin/newsletter/subscribers"
        class="text-sm text-primary hover:underline"
      >
        Ver todos los suscriptores →
      </a>
    </div>

    <!-- Campaigns List -->
    <div class="admin-card p-0">
      <div class="p-5 border-b border-border">
        <h2 class="font-semibold text-lg">Campañas</h2>
      </div>

      {
        !campaigns || campaigns.length === 0 ? (
          <div class="p-8 text-center text-muted-foreground">
            <p>No hay campañas todavía.</p>
            <a
              href="/admin/newsletter/new"
              class="text-primary hover:underline mt-2 inline-block"
            >
              Crear tu primera campaña
            </a>
          </div>
        ) : (
          <div class="divide-y divide-border">
            {campaigns.map((campaign) => {
              const statusInfo = getStatusInfo(campaign.status);
              return (
                <div class="p-5 flex items-center justify-between hover:bg-muted/50 transition-colors">
                  <div class="flex-1">
                    <h3 class="font-medium text-foreground">
                      {campaign.subject}
                    </h3>
                    <p class="text-sm text-muted-foreground">
                      {formatDate(campaign.created_at)}
                      {campaign.status === CAMPAIGN_STATUS.SENT && campaign.sent_count && (
                        <span class="ml-2">
                          · Enviado a {campaign.sent_count} suscriptores
                          {campaign.failed_count > 0 && (
                            <span class="text-red-400"> ({campaign.failed_count} fallidos)</span>
                          )}
                        </span>
                      )}
                      {campaign.status === CAMPAIGN_STATUS.FAILED && campaign.last_error && (
                        <span class="ml-2 text-red-400">
                          · Error: {campaign.last_error.substring(0, 50)}...
                        </span>
                      )}
                    </p>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class={`px-3 py-1 rounded-full text-xs font-medium ${statusInfo.color}`}>
                      {statusInfo.label}
                    </span>
                    {/* Edit button for drafts and failed campaigns */}
                    {(campaign.status === CAMPAIGN_STATUS.DRAFT || campaign.status === CAMPAIGN_STATUS.FAILED) && (
                      <a
                        href={`/admin/newsletter/edit/${campaign.id}`}
                        class="text-sm text-muted-foreground hover:text-foreground transition-colors"
                        title="Editar campaña"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </a>
                    )}
                    {campaign.status === CAMPAIGN_STATUS.DRAFT && (
                      <a
                        href={`/admin/newsletter/send/${campaign.id}`}
                        class="text-sm text-primary hover:underline"
                      >
                        Enviar
                      </a>
                    )}
                    {campaign.status === CAMPAIGN_STATUS.FAILED && (
                      <a
                        href={`/admin/newsletter/send/${campaign.id}`}
                        class="text-sm text-orange-400 hover:underline"
                        title="Reintentar envío"
                      >
                        Reintentar
                      </a>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  </div>
</AdminLayout>

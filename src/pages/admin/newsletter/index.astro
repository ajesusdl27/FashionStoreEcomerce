---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";
import { CAMPAIGN_STATUS, CAMPAIGN_STATUS_LABELS, CAMPAIGN_STATUS_COLORS, type CampaignStatus } from "@/lib/constants/newsletter";

// Fetch campaigns and subscriber count
const { data: campaigns } = await supabase
  .from("newsletter_campaigns")
  .select("*")
  .order("created_at", { ascending: false });

const { count: subscriberCount } = await supabase
  .from("newsletter_subscribers")
  .select("*", { count: "exact", head: true })
  .eq("is_active", true);

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
};

// Helper to get status label and color
const getStatusInfo = (status: string) => {
  const typedStatus = status as CampaignStatus;
  return {
    label: CAMPAIGN_STATUS_LABELS[typedStatus] || status,
    color: CAMPAIGN_STATUS_COLORS[typedStatus] || 'bg-muted text-muted-foreground'
  };
};
---

<AdminLayout title="Newsletter">
  <div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-foreground">Newsletter</h1>
        <p class="text-muted-foreground">
          Gestiona tus campañas y suscriptores
        </p>
      </div>
      <a href="/admin/newsletter/new" class="admin-btn-primary">
        + Nueva Campaña
      </a>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Suscriptores Activos</p>
        <p class="text-3xl font-bold text-primary">{subscriberCount || 0}</p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Campañas Enviadas</p>
        <p class="text-3xl font-bold text-foreground">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.SENT).length || 0}
        </p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Borradores</p>
        <p class="text-3xl font-bold text-foreground">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.DRAFT).length || 0}
        </p>
      </div>
      <div class="admin-card">
        <p class="text-sm text-muted-foreground">Fallidas</p>
        <p class="text-3xl font-bold text-red-400">
          {campaigns?.filter((c) => c.status === CAMPAIGN_STATUS.FAILED).length || 0}
        </p>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="flex gap-4">
      <a
        href="/admin/newsletter/subscribers"
        class="text-sm text-primary hover:underline"
      >
        Ver todos los suscriptores →
      </a>
    </div>

    <!-- Campaigns List -->
    <div class="admin-card p-0">
      <div class="p-5 border-b border-border">
        <h2 class="font-semibold text-lg">Campañas</h2>
      </div>

      {
        !campaigns || campaigns.length === 0 ? (
          <div class="p-8 text-center text-muted-foreground">
            <p>No hay campañas todavía.</p>
            <a
              href="/admin/newsletter/new"
              class="text-primary hover:underline mt-2 inline-block"
            >
              Crear tu primera campaña
            </a>
          </div>
        ) : (
          <div class="divide-y divide-border">
            {campaigns.map((campaign) => {
              const statusInfo = getStatusInfo(campaign.status);
              return (
                <div class="p-5 flex items-center justify-between hover:bg-muted/50 transition-colors">
                  <div class="flex-1">
                    <h3 class="font-medium text-foreground">
                      {campaign.subject}
                    </h3>
                    <p class="text-sm text-muted-foreground">
                      {formatDate(campaign.created_at)}
                      {campaign.status === CAMPAIGN_STATUS.SENT && campaign.sent_count && (
                        <span class="ml-2">
                          · Enviado a {campaign.sent_count} suscriptores
                          {campaign.failed_count > 0 && (
                            <span class="text-red-400"> ({campaign.failed_count} fallidos)</span>
                          )}
                        </span>
                      )}
                      {campaign.status === CAMPAIGN_STATUS.FAILED && campaign.last_error && (
                        <span class="ml-2 text-red-400">
                          · Error: {campaign.last_error.substring(0, 50)}...
                        </span>
                      )}
                    </p>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class={`px-3 py-1 rounded-full text-xs font-medium ${statusInfo.color}`}>
                      {statusInfo.label}
                    </span>
                    {/* Edit button for drafts and failed campaigns */}
                    {(campaign.status === CAMPAIGN_STATUS.DRAFT || campaign.status === CAMPAIGN_STATUS.FAILED) && (
                      <a
                        href={`/admin/newsletter/edit/${campaign.id}`}
                        class="text-sm text-muted-foreground hover:text-foreground transition-colors"
                        title="Editar campaña"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </a>
                    )}
                    {campaign.status === CAMPAIGN_STATUS.DRAFT && (
                      <a
                        href={`/admin/newsletter/send/${campaign.id}`}
                        class="text-sm text-primary hover:underline"
                      >
                        Enviar
                      </a>
                    )}
                    {campaign.status === CAMPAIGN_STATUS.FAILED && (
                      <a
                        href={`/admin/newsletter/send/${campaign.id}`}
                        class="text-sm text-orange-400 hover:underline"
                        title="Reintentar envío"
                      >
                        Reintentar
                      </a>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  </div>
</AdminLayout>

---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { supabase } from "@/lib/supabase";

// Fetch all subscribers
const { data: subscribers } = await supabase
  .from("newsletter_subscribers")
  .select("*")
  .order("created_at", { ascending: false });

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
};

const activeCount = subscribers?.filter((s) => s.is_active).length || 0;
const inactiveCount = subscribers?.filter((s) => !s.is_active).length || 0;
const totalCount = subscribers?.length || 0;
---

<AdminLayout title="Suscriptores - Newsletter">
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a
          href="/admin/newsletter"
          class="p-2 hover:bg-muted rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-foreground">Suscriptores</h1>
          <p class="text-muted-foreground">
            {activeCount} activos · {inactiveCount} inactivos · {totalCount} total
          </p>
        </div>
      </div>
      
      <!-- Export CSV Button -->
      <button
        id="export-csv"
        class="flex items-center gap-2 px-4 py-2 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/80 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Exportar CSV
      </button>
    </div>

    <!-- Search and Filter Bar -->
    <div class="admin-card p-4">
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- Search Input -->
        <div class="flex-1 relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Buscar por email..."
            class="admin-input w-full pl-10"
          />
        </div>
        
        <!-- Filter Dropdown -->
        <select id="status-filter" class="admin-input w-full sm:w-auto">
          <option value="all">Todos los estados</option>
          <option value="active">Solo activos</option>
          <option value="inactive">Solo inactivos</option>
        </select>
      </div>
      
      <!-- Results count -->
      <p id="results-count" class="text-sm text-muted-foreground mt-3">
        Mostrando {totalCount} suscriptores
      </p>
    </div>

    <!-- Subscribers List -->
    <div class="admin-card p-0">
      {
        !subscribers || subscribers.length === 0 ? (
          <div class="p-8 text-center text-muted-foreground">
            <p>No hay suscriptores todavía.</p>
          </div>
        ) : (
          <div id="subscribers-list" class="divide-y divide-border">
            {subscribers.map((subscriber) => (
              <div 
                class="subscriber-row p-4 flex items-center justify-between hover:bg-muted/50 transition-colors"
                data-email={subscriber.email.toLowerCase()}
                data-active={subscriber.is_active ? "true" : "false"}
              >
                <div class="flex items-center gap-3">
                  <div
                    class={`w-2 h-2 rounded-full ${subscriber.is_active ? "bg-green-500" : "bg-muted-foreground"}`}
                  />
                  <span class="text-foreground">{subscriber.email}</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  <span class="text-muted-foreground">
                    {formatDate(subscriber.created_at)}
                  </span>
                  <button
                    class="toggle-status text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    data-id={subscriber.id}
                    data-active={subscriber.is_active ? "true" : "false"}
                  >
                    {subscriber.is_active ? "Desactivar" : "Activar"}
                  </button>
                </div>
              </div>
            ))}
          </div>
        )
      }
      
      <!-- No results message (hidden by default) -->
      <div id="no-results" class="p-8 text-center text-muted-foreground hidden">
        <p>No se encontraron suscriptores con esos criterios.</p>
      </div>
    </div>

    <!-- Toast notification container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
  </div>

  <!-- Pass subscribers data to client -->
  <script define:vars={{ subscribers }}>
    window.subscribersData = subscribers || [];
  </script>

  <script>
    // Toast notification helper
    function showToast(message: string, type: 'success' | 'error') {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-2 opacity-0 ${
        type === 'success' 
          ? 'bg-green-500 text-white' 
          : 'bg-red-500 text-white'
      }`;
      toast.textContent = message;
      container.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.classList.remove('translate-y-2', 'opacity-0');
      });

      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('translate-y-2', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ========== SEARCH & FILTER ==========
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
    const subscriberRows = document.querySelectorAll('.subscriber-row');
    const resultsCount = document.getElementById('results-count');
    const noResults = document.getElementById('no-results');
    const subscribersList = document.getElementById('subscribers-list');

    function filterSubscribers() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const statusValue = statusFilter.value;
      let visibleCount = 0;

      subscriberRows.forEach((row) => {
        const email = (row as HTMLElement).dataset.email || '';
        const isActive = (row as HTMLElement).dataset.active === 'true';
        
        const matchesSearch = email.includes(searchTerm);
        const matchesStatus = 
          statusValue === 'all' ||
          (statusValue === 'active' && isActive) ||
          (statusValue === 'inactive' && !isActive);

        if (matchesSearch && matchesStatus) {
          (row as HTMLElement).classList.remove('hidden');
          visibleCount++;
        } else {
          (row as HTMLElement).classList.add('hidden');
        }
      });

      // Update results count
      if (resultsCount) {
        resultsCount.textContent = `Mostrando ${visibleCount} suscriptor${visibleCount !== 1 ? 'es' : ''}`;
      }

      // Show/hide no results message
      if (noResults && subscribersList) {
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
          subscribersList.classList.add('hidden');
        } else {
          noResults.classList.add('hidden');
          subscribersList.classList.remove('hidden');
        }
      }
    }

    searchInput?.addEventListener('input', filterSubscribers);
    statusFilter?.addEventListener('change', filterSubscribers);

    // ========== EXPORT CSV ==========
    document.getElementById('export-csv')?.addEventListener('click', () => {
      const data = (window as any).subscribersData;
      if (!data || data.length === 0) {
        showToast('No hay suscriptores para exportar', 'error');
        return;
      }

      // Build CSV content
      const headers = ['Email', 'Estado', 'Fecha de suscripción'];
      const rows = data.map((s: any) => [
        s.email,
        s.is_active ? 'Activo' : 'Inactivo',
        new Date(s.created_at).toLocaleDateString('es-ES')
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map((row: string[]) => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      // Download file
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `suscriptores_newsletter_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showToast(`Exportados ${data.length} suscriptores`, 'success');
    });

    // ========== TOGGLE STATUS ==========
    document.querySelectorAll(".toggle-status").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const button = btn as HTMLButtonElement;
        const id = button.dataset.id;
        const isActive = button.dataset.active === "true";

        // Disable button while processing
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Procesando...';

        try {
          const response = await fetch(
            "/api/admin/newsletter/toggle-subscriber",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id, is_active: !isActive }),
            }
          );

          if (response.ok) {
            showToast(
              isActive ? 'Suscriptor desactivado' : 'Suscriptor activado',
              'success'
            );
            // Delay reload to show toast
            setTimeout(() => window.location.reload(), 500);
          } else {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.error || 'Error al actualizar el estado');
          }
        } catch (error) {
          console.error("Error toggling subscriber:", error);
          showToast(
            error instanceof Error ? error.message : 'Error al actualizar el suscriptor',
            'error'
          );
          // Restore button state
          button.disabled = false;
          button.textContent = originalText;
        }
      });
    });
  </script>
</AdminLayout>

---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { supabase } from "@/lib/supabase";
import OrderActions from "@/components/orders/OrderActions";
import InvoiceButton from "@/components/InvoiceButton";
import OrderTimeline from "@/components/ui/OrderTimeline";
import { formatOrderId } from "@/lib/order-utils";
import { getShippingConfig } from "@/lib/settings";
import { formatPrice } from "@/lib/formatters";
import { ArrowLeft, Package, MapPin, Mail, Phone, Truck, MessageCircle } from "lucide-react";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/cuenta/login");
}

// Fetch order with items AND verify ownership
const { data: order, error } = await supabase
  .from("orders")
  .select(
    `
    *,
    order_number,
    items:order_items(
      id,
      quantity,
      price_at_purchase,
      product:products(
        id, 
        name, 
        slug,
        images:product_images(image_url)
      ),
      variant:product_variants(id, size)
    ),
    coupon_usages(
      coupons(
        code,
        discount_type,
        discount_value
      )
    )
  `
  )
  .eq("id", id)
  .eq("customer_email", user.email) // Security check
  .single();

if (error) {
  console.error("Error fetching order:", error);
  // Only for debugging, remove in production
  // return new Response(`Error: ${JSON_stringify(error)}`, { status: 500 });
  return Astro.redirect("/cuenta/pedidos");
}

if (!order) {
  return Astro.redirect("/cuenta/pedidos");
}

// Calculate totals
const subtotal = order.items.reduce(
  (sum: number, item: any) => sum + item.price_at_purchase * item.quantity,
  0
);

// Get coupon info if any
// Supabase returns an array for one-to-many, even if we expect one
const couponUsage = order.coupon_usages?.[0];
const coupon = couponUsage?.coupons;

// Calculate discount
let discountAmount = 0;
if (coupon) {
  if (coupon.discount_type === "percentage") {
    discountAmount = subtotal * (coupon.discount_value / 100);
  } else {
    // Fixed amount
    discountAmount = Number(coupon.discount_value);
  }
}

// Ensure discount doesn't exceed subtotal
discountAmount = Math.min(discountAmount, subtotal);

// Obtener configuración de envío dinámica
const shippingConfigData = await getShippingConfig();

// Calculate shipping using dynamic settings
const shippingCost = subtotal >= shippingConfigData.freeShippingThreshold ? 0 : shippingConfigData.shippingCostEuros;

// Final total
const finalTotal = subtotal + shippingCost - discountAmount;

if (error) {
  console.error("Error fetching order:", error);
  // Only for debugging, remove in production
  // return new Response(`Error: ${JSON_stringify(error)}`, { status: 500 });
  return Astro.redirect("/cuenta/pedidos");
}

if (!order) {
  return Astro.redirect("/cuenta/pedidos");
}

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const statusConfig: Record<
  string,
  { label: string; bgClass: string; textClass: string }
> = {
  pending: {
    label: "Pendiente",
    bgClass: "bg-yellow-500/10",
    textClass: "text-yellow-400",
  },
  paid: {
    label: "Pagado",
    bgClass: "bg-emerald-500/10",
    textClass: "text-emerald-400",
  },
  shipped: {
    label: "Enviado",
    bgClass: "bg-blue-500/10",
    textClass: "text-blue-400",
  },
  delivered: {
    label: "Entregado",
    bgClass: "bg-primary/10",
    textClass: "text-primary",
  },
  cancelled: {
    label: "Cancelado",
    bgClass: "bg-red-500/10",
    textClass: "text-red-400",
  },
};

const currentStatus = statusConfig[order.status] || statusConfig.pending;
---

<PublicLayout title={`Pedido ${order.order_number ? formatOrderId(order.order_number) : `#${order.id.slice(0, 8)}`} - FashionStore`}>
  <div class="container mx-auto px-4 py-8 md:py-12">
    <!-- Breadcrumb -->
    <div class="mb-8">
      <a
        href="/cuenta/pedidos"
        class="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-primary transition-colors mb-4"
      >
        <ArrowLeft className="w-4 h-4" />
        Volver a mis pedidos
      </a>

      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="font-display text-2xl md:text-3xl">
            Pedido {order.order_number ? formatOrderId(order.order_number) : `#${order.id.slice(0, 8).toUpperCase()}`}
          </h1>
          <p class="text-muted-foreground mt-1">
            Realizado el {formatDate(order.created_at)}
          </p>
        </div>
        <span class={`badge ${
          order.status === "paid" ? "badge-success" :
          order.status === "shipped" ? "badge-info" :
          order.status === "delivered" ? "badge-primary" :
          order.status === "cancelled" ? "badge-danger" :
          "badge-warning"
        } text-sm px-4 py-2`}>
          {currentStatus?.label ?? order.status}
        </span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Timeline & Items -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Timeline -->
        <div class="admin-card">
          <h2 class="font-heading text-lg mb-6 flex items-center gap-2">
            <Truck className="w-5 h-5 text-primary" />
            Estado del Pedido
          </h2>
          <OrderTimeline 
            client:load
            currentStatus={order.status}
            createdAt={order.created_at}
            paidAt={order.status !== 'pending' ? order.created_at : undefined}
            shippedAt={order.shipped_at}
            deliveredAt={order.delivered_at}
            cancelledAt={order.cancelled_at}
          />
        </div>

        <!-- Products -->
        <div class="admin-card p-0 overflow-hidden">
          <div class="p-6 border-b border-border">
            <h2 class="font-heading text-lg flex items-center gap-2">
              <Package className="w-5 h-5 text-primary" />
              Productos ({order.items?.length || 0})
            </h2>
          </div>
          <div class="divide-y divide-border">
            {order.items.map((item: any) => (
              <div class="p-4 md:p-6 flex gap-4">
                <div class="w-20 h-20 md:w-24 md:h-24 bg-muted rounded-lg overflow-hidden flex-shrink-0">
                  {item.product?.images?.[0]?.image_url ? (
                    <img
                      src={item.product.images[0].image_url}
                      alt={item.product.name}
                      class="w-full h-full object-cover"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-muted-foreground">
                      <Package className="w-8 h-8" />
                    </div>
                  )}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex justify-between items-start gap-4">
                    <div>
                      <h3 class="font-medium leading-tight">
                        {item.product?.name}
                      </h3>
                      <p class="text-sm text-muted-foreground mt-1">
                        Talla: <span class="text-foreground">{item.variant?.size}</span>
                        {" · "}
                        Cantidad: <span class="text-foreground">{item.quantity}</span>
                      </p>
                    </div>
                    <p class="font-bold whitespace-nowrap">
                      {formatPrice(item.price_at_purchase * item.quantity)}
                    </p>
                  </div>
                  <p class="text-xs text-muted-foreground mt-2">
                    {formatPrice(item.price_at_purchase)} / unidad
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- Right Column: Summary & Info -->
      <div class="space-y-6">
        <!-- Summary -->
        <div class="admin-card">
          <h2 class="font-heading text-lg mb-4">Resumen</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-muted-foreground">Subtotal</span>
              <span>{formatPrice(subtotal)}</span>
            </div>
            {discountAmount > 0 && coupon && (
              <div class="flex justify-between text-green-500">
                <span class="flex items-center gap-1">
                  Descuento
                  <span class="badge badge-success text-xs">{coupon.code}</span>
                </span>
                <span>-{formatPrice(discountAmount)}</span>
              </div>
            )}
            <div class="flex justify-between">
              <span class="text-muted-foreground">Envío</span>
              <span class={shippingCost === 0 ? "text-green-500 font-medium" : ""}>
                {shippingCost === 0 ? "Gratis" : formatPrice(shippingCost)}
              </span>
            </div>
            <div class="border-t border-border pt-3 mt-3 flex justify-between font-bold text-lg">
              <span>Total</span>
              <span class="text-primary">{formatPrice(finalTotal)}</span>
            </div>
          </div>
        </div>

        <!-- Shipping Info -->
        <div class="admin-card">
          <h2 class="font-heading text-lg mb-4">Información de Envío</h2>

          <div class="space-y-4">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                <MapPin className="w-4 h-4 text-primary" />
              </div>
              <div class="text-sm">
                <p class="font-medium">{order.customer_name}</p>
                <p class="text-muted-foreground">{order.shipping_address}</p>
                <p class="text-muted-foreground">
                  {order.shipping_postal_code}, {order.shipping_city}
                </p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                <Mail className="w-4 h-4 text-primary" />
              </div>
              <div class="text-sm">
                <p class="text-muted-foreground">{order.customer_email}</p>
              </div>
            </div>

            {order.customer_phone && (
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                  <Phone className="w-4 h-4 text-primary" />
                </div>
                <div class="text-sm">
                  <p class="text-muted-foreground">{order.customer_phone}</p>
                </div>
              </div>
            )}
          </div>

          {order.status === "shipped" && (
            <div class="mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
              <p class="text-sm font-medium text-blue-400">Tu pedido está en camino</p>
              <p class="text-xs text-blue-400/70 mt-1">
                Recibirás un SMS o email con el seguimiento del envío.
              </p>
            </div>
          )}
        </div>

        <!-- Actions -->
        <div class="space-y-3">
          <!-- Order Actions (Cancel/Return) -->
          <OrderActions
            client:load
            orderId={order.id}
            orderNumber={order.order_number}
            orderStatus={order.status}
            customerEmail={order.customer_email}
            deliveredAt={order.delivered_at}
            orderItems={order.items?.map((item: any) => ({
              id: item.id,
              product_id: item.product?.id,
              variant_id: item.variant?.id,
              quantity: item.quantity,
              price_at_purchase: item.price_at_purchase,
              product: item.product,
              variant: item.variant,
            })) || []}
          />

          <!-- Invoice Button -->
          <InvoiceButton
            client:load
            orderId={order.id}
            orderNumber={order.order_number ? formatOrderId(order.order_number) : order.id.slice(0, 8).toUpperCase()}
            orderStatus={order.status}
          />

          <!-- Contact Support -->
          <a
            href="/contacto"
            class="admin-btn-secondary w-full justify-center"
          >
            <MessageCircle className="w-4 h-4" />
            ¿Necesitas ayuda?
          </a>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

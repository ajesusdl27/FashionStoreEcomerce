---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { supabase } from "@/lib/supabase";
import OrderActions from "@/components/orders/OrderActions";
import InvoiceButton from "@/components/InvoiceButton";
import { formatOrderId } from "@/lib/order-utils";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/cuenta/login");
}

// Fetch order with items AND verify ownership
const { data: order, error } = await supabase
  .from("orders")
  .select(
    `
    *,
    order_number,
    items:order_items(
      id,
      quantity,
      price_at_purchase,
      product:products(
        id, 
        name, 
        slug,
        images:product_images(image_url)
      ),
      variant:product_variants(id, size)
    ),
    coupon_usages(
      coupons(
        code,
        discount_type,
        discount_value
      )
    ),
    returns (
      id,
      status,
      return_label_url,
      created_at
    )
  `
  )
  .eq("id", id)
  .eq("customer_email", user.email) // Security check
  .single();

// ... (existing code)

// Get return info if any
const returnData = order.returns?.[0]; // Assuming closest return

// ... (existing code until InvoiceButton)

        <!-- Invoice Button -->
        <InvoiceButton
          client:load
          orderId={order.id}
          orderNumber={order.order_number
            ? formatOrderId(order.order_number)
            : order.id.slice(0, 8).toUpperCase()}
          orderStatus={order.status}
        />

        {/* Return Label Button */}
        {returnData?.return_label_url && (
           <div class="glass border border-border rounded-2xl p-6">
             <h2 class="font-heading text-lg mb-2">Devolución</h2>
             <p class="text-sm text-muted-foreground mb-4">
               Descarga tu etiqueta de envío para proceder con la devolución.
             </p>
             <a
               href={returnData.return_label_url}
               target="_blank"
               rel="noopener noreferrer"
               class="w-full flex items-center justify-center gap-2 bg-primary text-primary-foreground hover:bg-primary/90 px-4 py-2 rounded-lg font-medium transition-colors"
             >
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
               </svg>
               Descargar Etiqueta de Envío
             </a>
           </div>
        )}

        <div class="text-center">
          <a
            href="/contacto"
            class="text-xs text-muted-foreground hover:text-primary transition-colors underline"
          >
            ¿Necesitas ayuda con este pedido?
          </a>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

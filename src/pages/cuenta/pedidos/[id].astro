---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { supabase } from "@/lib/supabase";
import OrderActions from "@/components/orders/OrderActions";
import InvoiceButton from "@/components/InvoiceButton";
import { formatOrderId } from "@/lib/order-utils";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/cuenta/login");
}

// Fetch order with items AND verify ownership
const { data: order, error } = await supabase
  .from("orders")
  .select(
    `
    *,
    order_number,
    items:order_items(
      id,
      quantity,
      price_at_purchase,
      product:products(
        id, 
        name, 
        slug,
        images:product_images(image_url)
      ),
      variant:product_variants(id, size)
    ),
    coupon_usages(
      coupons(
        code,
        discount_type,
        discount_value
      )
    )
  `
  )
  .eq("id", id)
  .eq("customer_email", user.email) // Security check
  .single();

if (error) {
  console.error("Error fetching order:", error);
  // Only for debugging, remove in production
  // return new Response(`Error: ${JSON_stringify(error)}`, { status: 500 });
  return Astro.redirect("/cuenta/pedidos");
}

if (!order) {
  return Astro.redirect("/cuenta/pedidos");
}

// Calculate totals
const subtotal = order.items.reduce(
  (sum: number, item: any) => sum + item.price_at_purchase * item.quantity,
  0
);

// Get coupon info if any
// Supabase returns an array for one-to-many, even if we expect one
const couponUsage = order.coupon_usages?.[0];
const coupon = couponUsage?.coupons;

// Calculate discount
let discountAmount = 0;
if (coupon) {
  if (coupon.discount_type === "percentage") {
    discountAmount = subtotal * (coupon.discount_value / 100);
  } else {
    // Fixed amount
    discountAmount = Number(coupon.discount_value);
  }
}

// Ensure discount doesn't exceed subtotal
discountAmount = Math.min(discountAmount, subtotal);

// Calculate shipping (re-calculate logic to be safe, though usually 50 is threshold)
// Assuming logic: Free shipping if SUBTOTAL (pre-discount) >= 50?
// Or post-discount? Usually pre-discount for "spend X to get free shipping".
// Looking at create-session.ts: `subtotalCents >= FREE_SHIPPING_THRESHOLD * 100` (which is 50).
// So it based on Subtotal.
const shippingCost = subtotal >= 50 ? 0 : 4.99;

// Final total
const finalTotal = subtotal + shippingCost - discountAmount;

if (error) {
  console.error("Error fetching order:", error);
  // Only for debugging, remove in production
  // return new Response(`Error: ${JSON_stringify(error)}`, { status: 500 });
  return Astro.redirect("/cuenta/pedidos");
}

if (!order) {
  return Astro.redirect("/cuenta/pedidos");
}

const formatPrice = (price: number) => {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const statusConfig: Record<
  string,
  { label: string; bgClass: string; textClass: string }
> = {
  pending: {
    label: "Pendiente",
    bgClass: "bg-yellow-500/10",
    textClass: "text-yellow-400",
  },
  paid: {
    label: "Pagado",
    bgClass: "bg-emerald-500/10",
    textClass: "text-emerald-400",
  },
  shipped: {
    label: "Enviado",
    bgClass: "bg-blue-500/10",
    textClass: "text-blue-400",
  },
  delivered: {
    label: "Entregado",
    bgClass: "bg-primary/10",
    textClass: "text-primary",
  },
  cancelled: {
    label: "Cancelado",
    bgClass: "bg-red-500/10",
    textClass: "text-red-400",
  },
  return_requested: {
    label: "Devolución Solicitada",
    bgClass: "bg-orange-500/10",
    textClass: "text-orange-400",
  },
  return_approved: {
    label: "Devolución Aprobada",
    bgClass: "bg-orange-500/10",
    textClass: "text-orange-400",
  },
  return_shipped: {
    label: "Devolución en Camino",
    bgClass: "bg-purple-500/10",
    textClass: "text-purple-400",
  },
  return_received: {
    label: "Devolución Recibida",
    bgClass: "bg-purple-500/10",
    textClass: "text-purple-400",
  },
  return_completed: {
    label: "Reembolso Completado",
    bgClass: "bg-emerald-500/10",
    textClass: "text-emerald-400",
  },
  partially_refunded: {
    label: "Reembolso Parcial",
    bgClass: "bg-amber-500/10",
    textClass: "text-amber-400",
  },
};

const currentStatus = statusConfig[order.status] || statusConfig.pending;
---

<PublicLayout
  title={`Pedido ${order.order_number ? formatOrderId(order.order_number) : `#${order.id.slice(0, 8)}`} - FashionStore`}
>
  <div class="container mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <div class="mb-8">
      <a
        href="/cuenta/pedidos"
        class="text-sm text-muted-foreground hover:text-primary transition-colors flex items-center gap-1 mb-4"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        Volver a mis pedidos
      </a>

      <div
        class="flex flex-col md:flex-row md:items-center justify-between gap-4"
      >
        <div>
          <h1 class="font-display text-3xl text-foreground">
            PEDIDO {
              order.order_number
                ? formatOrderId(order.order_number)
                : `#${order.id.slice(0, 8).toUpperCase()}`
            }
          </h1>
          <p class="text-muted-foreground mt-2">
            Realizado el {formatDate(order.created_at)}
          </p>
        </div>
        <div
          class={`px-4 py-2 rounded-full font-bold text-sm ${currentStatus?.bgClass ?? ""} ${currentStatus?.textClass ?? ""} inline-flex items-center gap-2 self-start md:self-auto`}
        >
          <span class="relative flex h-2.5 w-2.5">
            <span
              class={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${order.status === "delivered" ? "bg-primary" : "bg-current"}`}
            ></span>
            <span
              class={`relative inline-flex rounded-full h-2.5 w-2.5 ${order.status === "delivered" ? "bg-primary" : "bg-current"}`}
            ></span>
          </span>
          {currentStatus?.label ?? order.status}
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Items -->
      <div class="lg:col-span-2 space-y-6">
        <div class="glass border border-border rounded-2xl overflow-hidden">
          <div class="p-6 border-b border-border bg-muted/30">
            <h2 class="font-heading text-lg">
              Productos ({order.items?.length || 0})
            </h2>
          </div>
          <div class="divide-y divide-border/50">
            {
              order.items.map((item: any) => (
                <div class="p-6 flex gap-4 md:gap-6">
                  <div class="w-20 h-24 md:w-24 md:h-32 bg-muted rounded-lg overflow-hidden flex-shrink-0">
                    {item.product?.images?.[0]?.image_url ? (
                      <img
                        src={item.product.images[0].image_url}
                        alt={item.product.name}
                        class="w-full h-full object-cover"
                      />
                    ) : (
                      <div class="w-full h-full flex items-center justify-center bg-muted text-muted-foreground">
                        <svg
                          class="w-8 h-8"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                          />
                        </svg>
                      </div>
                    )}
                  </div>
                  <div class="flex-1 min-w-0 flex flex-col justify-between">
                    <div>
                      <div class="flex justify-between items-start gap-4">
                        <h3 class="font-medium text-lg leading-tight truncate pr-4">
                          {item.product?.name}
                        </h3>
                        <p class="font-bold whitespace-nowrap">
                          {formatPrice(item.price_at_purchase * item.quantity)}
                        </p>
                      </div>
                      <p class="text-sm text-muted-foreground mt-1">
                        Talla:{" "}
                        <span class="text-foreground font-medium">
                          {item.variant?.size}
                        </span>
                      </p>
                      <p class="text-sm text-muted-foreground">
                        {formatPrice(item.price_at_purchase)} x {item.quantity}{" "}
                        ud{item.quantity > 1 ? "s" : ""}
                      </p>
                    </div>
                  </div>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Right Column: Summary & Shipping -->
      <div class="space-y-6">
        <!-- Summary -->
        <div class="glass border border-border rounded-2xl p-6">
          <h2 class="font-heading text-lg mb-4">Resumen</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between text-muted-foreground">
              <span>Subtotal</span>
              <span>{formatPrice(subtotal)}</span>
            </div>
            {
              discountAmount > 0 && coupon && (
                <div class="flex justify-between text-emerald-500">
                  <span>
                    Descuento ({coupon.code})
                    {coupon.discount_type === "percentage" && (
                      <span class="text-xs ml-1">
                        (-{coupon.discount_value}%)
                      </span>
                    )}
                  </span>
                  <span>-{formatPrice(discountAmount)}</span>
                </div>
              )
            }
            <div class="flex justify-between text-muted-foreground">
              <span>Envío</span>
              <span>
                {shippingCost === 0 ? "Gratis" : formatPrice(shippingCost)}
              </span>
            </div>
            <div
              class="border-t border-border pt-3 mt-3 flex justify-between font-bold text-lg text-foreground"
            >
              <span>Total</span>
              <span>{formatPrice(finalTotal)}</span>
            </div>
          </div>
        </div>

        <!-- Shipping Info -->
        <div class="glass border border-border rounded-2xl p-6">
          <h2 class="font-heading text-lg mb-4">Envío y Datos</h2>

          <div class="space-y-6">
            <div>
              <h3
                class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Dirección de entrega
              </h3>
              <div class="pl-6 text-sm">
                <p class="font-medium text-foreground">{order.customer_name}</p>
                <p class="text-muted-foreground">{order.shipping_address}</p>
                <p class="text-muted-foreground">
                  {order.shipping_postal_code}, {order.shipping_city}
                </p>
                <p class="text-muted-foreground uppercase">
                  {order.shipping_country}
                </p>
              </div>
            </div>

            <div>
              <h3
                class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  ></path>
                </svg>
                Contacto
              </h3>
              <div class="pl-6 text-sm">
                <p class="text-muted-foreground">{order.customer_email}</p>
                {
                  order.customer_phone && (
                    <p class="text-muted-foreground">{order.customer_phone}</p>
                  )
                }
              </div>
            </div>

            {
              order.status === "shipped" && (
                <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                  <h3 class="text-blue-400 text-sm font-bold mb-1">
                    Pedido Enviado
                  </h3>
                  <p class="text-xs text-blue-300/80">
                    Tu pedido está en camino. Recibirás un SMS o email de la
                    empresa de transporte en breve.
                  </p>
                </div>
              )
            }
          </div>
        </div>

        <!-- Order Actions (Cancel/Return) -->
        <OrderActions
          client:load
          orderId={order.id}
          orderNumber={order.order_number}
          orderStatus={order.status}
          customerEmail={order.customer_email}
          deliveredAt={order.delivered_at}
          orderItems={order.items?.map((item: any) => ({
            id: item.id,
            product_id: item.product?.id,
            variant_id: item.variant?.id,
            quantity: item.quantity,
            price_at_purchase: item.price_at_purchase,
            product: item.product,
            variant: item.variant,
          })) || []}
        />

        <!-- Invoice Button -->
        <InvoiceButton
          client:load
          orderId={order.id}
          orderNumber={order.order_number
            ? formatOrderId(order.order_number)
            : order.id.slice(0, 8).toUpperCase()}
          orderStatus={order.status}
        />

        <div class="text-center">
          <a
            href="/contacto"
            class="text-xs text-muted-foreground hover:text-primary transition-colors underline"
          >
            ¿Necesitas ayuda con este pedido?
          </a>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

---
import PublicLayout from "../layouts/PublicLayout.astro";
import AuthErrorHandler from "@/components/islands/AuthErrorHandler";
import CategoryGrid from "@/components/categories/CategoryGrid";
import { supabase } from "@/lib/supabase";
import { getSettings, getShippingConfig } from "@/lib/settings";
import { formatPrice } from "@/lib/formatters";
import { 
  ArrowRight, 
  Copy, 
  Zap, 
  Tag, 
  Package, 
  RefreshCw, 
  ShieldCheck,
  Flame
} from "lucide-react";
import { resolveStyleConfig, getTextColorClass, getTextAlignClass, getContentPositionClasses, getOverlayClasses, normalizeCoupon } from '@/lib/types/promotion';

const now = new Date();

// Fetch store settings for dynamic values
const settings = await getSettings();
const shippingConfig = await getShippingConfig();

// Fetch categories and featured products (now handled by CategoryGrid component)
// const { data: categories } = await supabase
//   .from("categories")
//   .select("*")
//   .order("name");

const { data: featuredProducts } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(name, slug),
    images:product_images(image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .eq("active", true)
  .order("created_at", { ascending: false })
  .limit(8);

const { data: offerProducts } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(name, slug),
    images:product_images(image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .eq("active", true)
  .eq("is_offer", true)
  .limit(4);

// Check if offers are enabled
const { data: offersSetting } = await supabase
  .from("settings")
  .select("value, value_bool")
  .eq("key", "offers_enabled")
  .single();

// Check both value and value_bool for backward compatibility
const offersEnabledSetting =
  offersSetting?.value === "true" || offersSetting?.value_bool === true;

// Get flash offers end date
const { data: offersEndSetting } = await supabase
  .from("settings")
  .select("value")
  .eq("key", "flash_offers_end")
  .single();

const flashOffersEndDate = offersEndSetting?.value ? new Date(offersEndSetting.value) : null;

// Offers are enabled only if: setting is on AND (no end date set OR end date is in the future)
const offersEnabled = offersEnabledSetting && 
  (!flashOffersEndDate || flashOffersEndDate > now);

// Pass end date to client as ISO string (for countdown)
const flashOffersEndISO = flashOffersEndDate?.toISOString() || null;

// FETCH HERO PROMOTION
// We fetch all active promotions (RLS handles date validation) and filter in JS for reliability
const { data: allPromotions } = await supabase
  .from('promotions')
  .select('*, coupons(code, discount_type, discount_value)')
  .eq('is_active', true)
  .order('priority', { ascending: true });

// Filter for home_hero
const heroPromotion = allPromotions?.find(p => 
    Array.isArray(p.locations) && p.locations.includes('home_hero')
);

// Resolve style_config with defaults and compute overlay / text classes
const heroStyle = heroPromotion ? resolveStyleConfig(heroPromotion.style_config) : null;
const heroTextColor = heroStyle ? getTextColorClass(heroStyle.text_color) : '';
const heroTextAlign = heroStyle ? getTextAlignClass(heroStyle.text_align) : '';
const heroPosition = heroStyle ? getContentPositionClasses(heroStyle.overlay_position) : '';
const heroOverlay  = heroStyle ? getOverlayClasses(heroStyle, 'hero') : '';
const heroCoupon   = heroPromotion ? normalizeCoupon(heroPromotion.coupons) : null;
---

<PublicLayout title="Inicio">
  <AuthErrorHandler client:load />
  
  {/* DYNAMIC HERO SECTION (If Promotion Exists) */}
  {heroPromotion ? (
    <section class="relative h-[85vh] min-h-[600px] w-full flex items-center overflow-hidden">
        {/* Background Image with Parallax-like effect - Responsive images */}
        <div class="absolute inset-0 z-0 select-none">
            <picture>
                {heroPromotion.mobile_image_url && (
                    <source 
                        media="(max-width: 767px)" 
                        srcset={heroPromotion.mobile_image_url}
                    />
                )}
                <img 
                    src={heroPromotion.image_url} 
                    alt={heroPromotion.title} 
                    class="w-full h-full object-cover object-center scale-105 animate-zoom-slow"
                    loading="eager"
                />
            </picture>
            {/* Intelligent Gradient Overlay — driven by style_config */}
            <div class={`absolute inset-0 ${heroOverlay}`}></div>
        </div>

        {/* Content Container — overlay_position drives horizontal placement */}
        <div class={`relative z-10 container mx-auto px-6 md:px-12 h-full flex flex-col justify-center ${heroPosition}`}>
            <div class={`max-w-4xl flex flex-col ${heroTextAlign}`}>
                
                {/* Badge / Overline */}
                <div class="overflow-hidden mb-4 sm:mb-6">
                     <span class={`inline-block animate-fade-up px-3 py-1 text-xs sm:text-sm font-bold tracking-[0.2em] uppercase border-l-2 ${
                        heroTextColor.includes('white') ? 'border-primary text-zinc-300' : 'border-black text-zinc-600'
                     }`}>
                        Temporada {new Date().getFullYear()}
                     </span>
                </div>

                {/* Main Title - Responsive sizing fixed */}
                <h1 class={`font-display text-5xl sm:text-7xl md:text-8xl lg:text-9xl font-black tracking-tighter mb-4 sm:mb-6 leading-[0.9] animate-fade-up-delay-1 ${heroTextColor} drop-shadow-2xl`}>
                    {heroPromotion.title}
                </h1>
                
                {/* Description */}
                {heroPromotion.description && (
                    <p class={`text-base sm:text-xl md:text-2xl font-light mb-8 sm:mb-10 max-w-xl animate-fade-up-delay-2 ${heroTextColor} opacity-90 leading-relaxed`}>
                        {heroPromotion.description}
                    </p>
                )}

                {/* Coupon & CTA Block - Better mobile stacking */}
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4 sm:gap-6 animate-fade-up-delay-3 w-full sm:w-auto">
                    <a
                        href={heroPromotion.cta_link || "/productos"}
                        class="group relative inline-flex items-center justify-center px-8 py-4 text-base sm:text-lg font-bold tracking-wider uppercase text-black bg-primary border-2 border-transparent hover:border-primary rounded-none overflow-hidden transition-all hover:bg-transparent hover:text-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px]"
                    >
                        <span class="relative z-10 flex items-center gap-2">
                           {heroPromotion.cta_text || "Comprar Ahora"}
                           <ArrowRight className="w-5 h-5 ml-1 group-hover:translate-x-1 transition-transform" />
                        </span>
                    </a>

                    {heroPromotion.coupon_id && heroCoupon && (
                        <div class="relative group cursor-pointer w-full sm:w-auto" onclick={`navigator.clipboard.writeText('${heroCoupon.code}').then(() => { const t = document.createElement('div'); t.className = 'fixed bottom-6 right-6 p-4 bg-green-500/90 text-white rounded-lg shadow-xl flex items-center gap-3 z-50 animate-fade-in'; t.innerHTML = '<span class=\"font-medium\">¡Cupón ${heroCoupon.code} copiado!</span>'; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); });`}>
                             {/* Glass effect container */}
                             <div class={`relative flex items-center justify-between sm:justify-start gap-4 bg-white/10 backdrop-blur-md border border-white/20 px-5 py-3.5 rounded-lg hover:bg-white/20 transition-all shadow-lg hover:shadow-xl group-active:scale-95`}>
                                <div class="flex flex-col items-start">
                                    <span class="text-[10px] uppercase tracking-widest text-primary font-bold mb-0.5">Cupón Descuento</span>
                                    <span class={`font-mono text-xl font-bold tracking-wider ${heroTextColor}`}>
                                        {heroCoupon.code}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class={`h-8 w-[1px] bg-current opacity-20 ${heroTextColor}`}></div>
                                    <Copy className={`w-5 h-5 ${heroTextColor} opacity-70 group-hover:opacity-100 transition-all`} />
                                </div>
                             </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    </section>

  ) : (
    
    /* DEFAULT HERO SECTION (Fallback) */
    <section
        class="relative h-[80vh] min-h-[500px] flex items-center justify-center overflow-hidden"
        id="hero"
    >
        <!-- Animated gradient background -->
        <div
        class="absolute inset-0 bg-gradient-to-br from-background via-muted to-background animate-gradient z-0"
        >
        </div>
        
        <!-- Pattern overlay -->
        <div class="absolute inset-0 bg-[url('/hero-bg.svg')] bg-cover bg-center opacity-30 z-0">
        </div>
        
        <!-- Gradient overlay for text readability -->
        <div
        class="absolute inset-0 bg-gradient-to-b from-background/40 via-transparent to-background z-10"
        >
        </div>

        <!-- Floating decorative elements -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-5">
        <div class="absolute top-20 left-[10%] w-32 h-32 rounded-full bg-primary/10 blur-3xl animate-float"></div>
        <div class="absolute bottom-32 right-[15%] w-48 h-48 rounded-full bg-primary/5 blur-3xl animate-float-slow"></div>
        <div class="absolute top-1/3 right-[20%] w-24 h-24 rounded-full bg-accent/10 blur-2xl animate-float-delay"></div>
        </div>

        <!-- Main content -->
        <div class="relative z-20 text-center px-4">
        <!-- Badge -->
        <div class="animate-fade-up mb-6">
            <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 border border-primary/20 text-sm text-primary">
            <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
            </span>
            Temporada 2026
            </span>
        </div>
        
        <!-- Title -->
        <h1
            class="font-display text-5xl md:text-7xl lg:text-8xl tracking-wider mb-4 animate-fade-up-delay-1"
        >
            NUEVA <span class="text-shimmer">COLECCIÓN</span>
        </h1>
        
        <!-- Subtitle -->
        <p class="text-lg md:text-xl text-muted-foreground max-w-xl mx-auto mb-8 animate-fade-up-delay-2">
            Descubre las últimas tendencias en streetwear urbano
        </p>
        
        <!-- CTA Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 animate-fade-up-delay-3">
            <a
            href="/productos"
            class="group inline-flex items-center gap-2 bg-primary text-primary-foreground px-8 py-4 font-heading text-lg tracking-wider neon-glow hover:animate-pulse-glow transition-all rounded-lg"
            >
            VER PRODUCTOS
            <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            </a>
            <a
            href="/productos?ofertas=true"
            class="inline-flex items-center gap-2 px-8 py-4 font-heading text-lg tracking-wider text-foreground border border-border hover:border-primary/50 hover:bg-primary/5 transition-all rounded-lg"
            >
            <Flame className="w-5 h-5 text-red-500 fill-red-500" /> OFERTAS
            </a>
        </div>
        </div>
    </section>
  )}

  <!-- Trust Bar -->
  <section class="bg-card border-y border-border py-4">
    <div class="container mx-auto px-4">
      <div
        class="flex flex-wrap justify-center gap-6 md:gap-12 text-sm text-muted-foreground"
      >
        <div class="flex items-center gap-2">
          <Package className="w-5 h-5 text-primary" />
          <span>Envío gratis +{shippingConfig.freeShippingThreshold}€</span>
        </div>
        <div class="flex items-center gap-2">
          <RefreshCw className="w-5 h-5 text-primary" />
          <span>{settings.returnWindowDays} días devolución</span>
        </div>
        <div class="flex items-center gap-2">
          <ShieldCheck className="w-5 h-5 text-primary" />
          <span>Pago 100% seguro</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Categories - Clean Design -->
  <CategoryGrid 
    client:load
    layout="auto"
    maxItems={8}
    showFeaturedOnly={false}
    showHeader={true}
  />

  <!-- Flash Offers (if enabled) -->
  {
    offersEnabled && offerProducts && offerProducts.length > 0 && (
      <section class="py-12 md:py-20 relative overflow-hidden" id="flash-offers" data-end={flashOffersEndISO}>
        <!-- Background gradient -->
        <div class="absolute inset-0 bg-gradient-to-br from-accent/10 via-background to-primary/5"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(239,68,68,0.15),transparent_50%)]"></div>
        
        <div class="container mx-auto px-4 relative z-10">
          <!-- Header with Countdown -->
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-accent/20 flex items-center justify-center animate-pulse">
                <Zap className="w-7 h-7 text-accent fill-accent" />
              </div>
              <div>
                <h2 class="font-display text-3xl md:text-4xl font-bold text-accent tracking-wide">
                  OFERTAS FLASH
                </h2>
                <p class="text-muted-foreground text-sm">¡Descuentos por tiempo limitado!</p>
              </div>
            </div>
            
            <!-- Countdown Timer -->
            <div class="flex items-center gap-3 bg-card/80 backdrop-blur-sm border border-accent/30 rounded-xl px-5 py-3 shadow-lg shadow-accent/10">
              <span class="text-sm text-muted-foreground">Termina en:</span>
              <div class="flex items-center gap-2" id="countdown-timer">
                <div class="flex flex-col items-center">
                  <span class="text-2xl font-bold text-accent tabular-nums" id="hours">00</span>
                  <span class="text-[10px] text-muted-foreground uppercase">hrs</span>
                </div>
                <span class="text-accent font-bold">:</span>
                <div class="flex flex-col items-center">
                  <span class="text-2xl font-bold text-accent tabular-nums" id="minutes">00</span>
                  <span class="text-[10px] text-muted-foreground uppercase">min</span>
                </div>
                <span class="text-accent font-bold">:</span>
                <div class="flex flex-col items-center">
                  <span class="text-2xl font-bold text-accent tabular-nums" id="seconds">00</span>
                  <span class="text-[10px] text-muted-foreground uppercase">seg</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Products Grid -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            {offerProducts.map((product, index) => {
              const discount = Math.round(
                ((product.price - (product.offer_price || product.price)) / product.price) * 100
              );
              const firstImage = product.images?.sort((a: any, b: any) => a.order - b.order)?.[0]?.image_url;
              
              return (
                <a 
                  href={`/productos/${product.slug}`} 
                  class="group relative"
                  style={`animation-delay: ${index * 100}ms`}
                >
                  <div class="relative aspect-square rounded-xl overflow-hidden bg-muted mb-3 border border-border group-hover:border-accent/50 transition-all duration-300 group-hover:shadow-lg group-hover:shadow-accent/20">
                    {firstImage && (
                      <img
                        src={firstImage}
                        alt={product.name}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                      />
                    )}
                    
                    {/* Discount Badge */}
                    <div class="absolute top-3 left-3 bg-accent text-white px-3 py-1.5 text-sm font-bold rounded-lg shadow-lg shadow-accent/30 flex items-center gap-1">
                      <Tag className="w-4 h-4" />
                      -{discount}%
                    </div>
                    
                    {/* Quick view overlay */}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center pb-4">
                      <span class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                        Ver producto
                      </span>
                    </div>
                  </div>
                  
                  <h3 class="font-medium text-sm mb-2 group-hover:text-accent transition-colors line-clamp-2">
                    {product.name}
                  </h3>
                  
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-lg font-bold text-accent">
                      {formatPrice(product.offer_price || product.price)}
                    </span>
                    <span class="text-sm text-muted-foreground line-through">
                      {formatPrice(product.price)}
                    </span>
                  </div>
                </a>
              );
            })}
          </div>

          <!-- View All Link -->
          <div class="text-center mt-10">
            <a
              href="/productos?ofertas=true"
              class="inline-flex items-center gap-2 px-6 py-3 bg-accent text-white rounded-lg font-medium hover:bg-accent/90 transition-colors hover:shadow-lg hover:shadow-accent/30"
            >
              Ver todas las ofertas
              <ArrowRight className="w-5 h-5" />
            </a>
          </div>
        </div>
      </section>
    )
  }

  <script>
    // Countdown timer - uses configured end date or defaults to midnight
    function updateCountdown() {
      const section = document.getElementById('flash-offers');
      if (!section) return;
      
      const endDateStr = section.dataset.end;
      const now = new Date();
      
      let targetDate: Date;
      if (endDateStr) {
        targetDate = new Date(endDateStr);
      } else {
        // Fallback: next midnight
        targetDate = new Date(now);
        targetDate.setDate(targetDate.getDate() + 1);
        targetDate.setHours(0, 0, 0, 0);
      }
      
      const diff = targetDate.getTime() - now.getTime();
      
      // If time is up, hide the section
      if (diff <= 0) {
        section.style.display = 'none';
        return;
      }
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      const hoursEl = document.getElementById('hours');
      const minutesEl = document.getElementById('minutes');
      const secondsEl = document.getElementById('seconds');
      
      if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
      if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
      if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
    }
    
    // Only run if the section exists
    if (document.getElementById('flash-offers')) {
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }
  </script>

  <!-- Featured Products -->
  <section class="py-12 md:py-16">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="font-heading text-2xl md:text-3xl font-bold">Novedades</h2>
          <p class="text-sm text-muted-foreground mt-1">Lo último en nuestra tienda</p>
        </div>
        <a href="/productos" class="admin-btn-secondary text-sm">
          Ver todo
          <ArrowRight className="w-4 h-4" />
        </a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
        {
          featuredProducts?.map((product) => {
            const hasOffer = product.is_offer && product.offer_price;
            const discount = hasOffer 
              ? Math.round(((product.price - product.offer_price) / product.price) * 100)
              : 0;
            const variants = product.variants || [];
            const availableSizes = variants.filter((v: any) => v.stock > 0).map((v: any) => v.size);
            
            return (
              <a href={`/productos/${product.slug}`} class="group">
                <div class="relative aspect-square rounded-xl overflow-hidden bg-muted mb-3 border border-border group-hover:border-primary/30 transition-all duration-300">
                  {product.images?.[0]?.image_url && (
                    <img
                      src={product.images[0].image_url}
                      alt={product.name}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                      loading="lazy"
                    />
                  )}
                  
                  {/* Badges */}
                  <div class="absolute top-2 left-2 flex flex-col gap-1">
                    {hasOffer && (
                      <span class="badge badge-danger font-bold shadow-lg">
                        -{discount}%
                      </span>
                    )}
                    {product.category && (
                      <span class="bg-card/90 backdrop-blur-sm text-foreground text-xs px-2 py-1 rounded-md shadow-sm">
                        {product.category.name}
                      </span>
                    )}
                  </div>
                  
                  {/* Quick View Overlay */}
                  <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 hidden md:flex flex-col items-center justify-end pb-4">
                    <span class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 shadow-lg">
                      Ver Producto
                    </span>
                    {availableSizes.length > 0 && (
                      <div class="flex gap-1 mt-2 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75">
                        {availableSizes.slice(0, 4).map((size: string) => (
                          <span class="px-2 py-1 bg-white/90 text-black text-xs rounded font-medium">
                            {size}
                          </span>
                        ))}
                        {availableSizes.length > 4 && (
                          <span class="px-2 py-1 bg-white/90 text-black text-xs rounded font-medium">
                            +{availableSizes.length - 4}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                </div>
                <h3 class="font-medium text-sm mb-1.5 group-hover:text-primary transition-colors line-clamp-2 leading-snug">
                  {product.name}
                </h3>
                <div class="flex items-center gap-2">
                  <span class={`font-bold text-lg ${hasOffer ? 'text-accent' : ''}`}>
                    {formatPrice(hasOffer ? product.offer_price : product.price)}
                  </span>
                  {hasOffer && (
                    <span class="text-sm text-muted-foreground line-through">
                      {formatPrice(product.price)}
                    </span>
                  )}
                </div>
              </a>
            );
          })
        }
      </div>
    </div>
  </section>


</PublicLayout>

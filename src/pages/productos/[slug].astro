---
import PublicLayout from "@/layouts/PublicLayout.astro";
import Badge from "@/components/ui/Badge.astro";
import CloudinaryImage from "@/components/ui/CloudinaryImage.astro";
import ProductAddToCart from "@/components/islands/ProductAddToCart";
import { supabase } from "@/lib/supabase";
import { getOptimizedUrl, isCloudinaryUrl } from "@/lib/cloudinary";

const { slug } = Astro.params;

// Fetch product with relations
const { data: product, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name, slug),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .eq("slug", slug)
  .eq("active", true)
  .single();

if (error || !product) {
  return Astro.redirect("/productos");
}

// Sort images by order
const sortedImages =
  product.images?.sort((a: any, b: any) => a.order - b.order) || [];
const mainImage =
  sortedImages[0]?.image_url ||
  "https://placehold.co/600x600/1a1a1a/ccff00?text=No+Image";

const hasOffer = product.is_offer && product.offer_price;
const displayPrice = hasOffer ? product.offer_price : product.price;

function formatPrice(price: number): string {
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
  }).format(price);
}

function calculateDiscount(original: number, offer: number): number {
  return Math.round(((original - offer) / original) * 100);
}

// Prepare variants for React component
const variantsForReact = (product.variants || []).map((v: any) => ({
  id: v.id,
  size: v.size,
  stock: v.stock,
}));

// Generate optimized thumbnail URLs for Cloudinary images
const getThumbnailUrl = (url: string) => {
  if (isCloudinaryUrl(url)) {
    return getOptimizedUrl(url, { width: 80, height: 80 });
  }
  return url;
};
---

<PublicLayout
  title={product.name}
  description={product.description || undefined}
>
  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm text-muted-foreground">
      <ol class="flex items-center gap-2 flex-wrap">
        <li>
          <a href="/" class="hover:text-primary transition-colors">Inicio</a>
        </li>
        <li>/</li>
        <li>
          <a href="/productos" class="hover:text-primary transition-colors"
            >Productos</a
          >
        </li>
        {
          product.category && (
            <>
              <li>/</li>
              <li>
                <a
                  href={`/categoria/${product.category.slug}`}
                  class="hover:text-primary transition-colors"
                >
                  {product.category.name}
                </a>
              </li>
            </>
          )
        }
        <li>/</li>
        <li class="text-foreground truncate max-w-[150px]">{product.name}</li>
      </ol>
    </nav>

    <div class="lg:grid lg:grid-cols-2 lg:gap-12">
      <!-- Gallery -->
      <div class="mb-8 lg:mb-0">
        <!-- Main Image -->
        <div
          class="relative aspect-square rounded-lg overflow-hidden bg-muted mb-4"
        >
          <CloudinaryImage
            id="main-image"
            src={mainImage}
            alt={product.name}
            width={800}
            sizes="(max-width: 1024px) 100vw, 50vw"
            class="w-full h-full object-cover"
          />

          {
            hasOffer && (
              <Badge
                variant="error"
                class="absolute top-4 left-4 text-lg font-bold"
              >
                -{calculateDiscount(product.price, product.offer_price!)}%
              </Badge>
            )
          }
        </div>

        <!-- Thumbnails -->
        {
          sortedImages.length > 1 && (
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
              {sortedImages.map((img: any, index: number) => (
                <button
                  class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden bg-muted border-2 border-transparent hover:border-primary transition-colors thumbnail-btn"
                  data-image={img.image_url}
                >
                  <img
                    src={getThumbnailUrl(img.image_url)}
                    alt={`${product.name} - imagen ${index + 1}`}
                    class="w-full h-full object-cover"
                  />
                </button>
              ))}
            </div>
          )
        }
      </div>

      <!-- Product Info -->
      <div>
        <h1 class="font-display text-3xl md:text-4xl lg:text-5xl mb-4">
          {product.name}
        </h1>

        <!-- Price -->
        <div class="flex items-center gap-3 mb-6">
          <span
            class:list={[
              "text-3xl font-bold",
              hasOffer ? "text-accent" : "text-foreground",
            ]}
          >
            {formatPrice(displayPrice!)}
          </span>

          {
            hasOffer && (
              <span class="text-xl text-muted-foreground line-through">
                {formatPrice(product.price)}
              </span>
            )
          }
        </div>

        <!-- Description -->
        {
          product.description && (
            <p class="text-muted-foreground mb-8 leading-relaxed">
              {product.description}
            </p>
          )
        }

        <!-- Size Selector + Add to Cart (React Island) -->
        <ProductAddToCart
          client:load
          productId={product.id}
          productName={product.name}
          productSlug={product.slug}
          price={displayPrice!}
          imageUrl={mainImage}
          variants={variantsForReact}
        />
      </div>
    </div>
  </div>

  <script>
    // Thumbnail click handler
    document.querySelectorAll(".thumbnail-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const mainImg = document.getElementById(
          "main-image"
        ) as HTMLImageElement;
        const newSrc = (btn as HTMLElement).dataset.image;
        if (mainImg && newSrc) {
          mainImg.src = newSrc;
        }

        // Update active state
        document
          .querySelectorAll(".thumbnail-btn")
          .forEach((b) => b.classList.remove("border-primary"));
        btn.classList.add("border-primary");
      });
    });
  </script>
</PublicLayout>

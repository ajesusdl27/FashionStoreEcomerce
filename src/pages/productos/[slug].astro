---
import PublicLayout from "@/layouts/PublicLayout.astro";
import Badge from "@/components/ui/Badge.astro";
import CloudinaryImage from "@/components/ui/CloudinaryImage.astro";
import ProductAddToCart from "@/components/islands/ProductAddToCart";
import PromotionBanner from "@/components/ui/PromotionBanner";
import RelatedProductsCarousel from "@/components/islands/RelatedProductsCarousel";
import { supabase, getRelatedProducts } from "@/lib/supabase";
import { getOptimizedUrl, isCloudinaryUrl } from "@/lib/cloudinary";
import { formatPrice } from "@/lib/formatters";
import { getShippingConfig, getSettings } from "@/lib/settings";
import { RefreshCw, ShieldCheck, Truck } from "lucide-react";

const { slug } = Astro.params;


const { data: product, error } = await supabase
  .from("products")
  .select(
    `
    *,
    category:categories(id, name, slug),
    images:product_images(id, image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .is('deleted_at', null)
  .eq("slug", slug)
  .eq("active", true)
  .single();

if (error || !product) {
  return Astro.redirect("/productos");
}


const sortedImages =
  product.images?.sort((a: any, b: any) => a.order - b.order) || [];
const mainImage =
  sortedImages[0]?.image_url ||
  "https://placehold.co/600x600/1a1a1a/ccff00?text=No+Image";

const hasOffer = product.is_offer && product.offer_price;
const displayPrice = hasOffer ? product.offer_price : product.price;

function calculateDiscount(original: number, offer: number): number {
  return Math.round(((original - offer) / original) * 100);
}


const variantsForReact = (product.variants || []).map((v: any) => ({
  id: v.id,
  size: v.size,
  stock: v.stock,
}));


const getThumbnailUrl = (url: string) => {
  if (isCloudinaryUrl(url)) {
    return getOptimizedUrl(url, { width: 80, height: 80 });
  }
  return url;
};


const shippingConfig = await getShippingConfig();
const settings = await getSettings();

// Get related products from the same category
const relatedProducts = product.category?.id
  ? await getRelatedProducts(product.category.id, product.id, 6)
  : [];
---

<PublicLayout
  title={product.name}
  description={product.description || undefined}
>
  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs with ARIA structure -->
    <nav aria-label="Breadcrumb" class="mb-6 text-sm text-muted-foreground">
      <ol class="flex items-center gap-2 flex-wrap">
        <li>
          <a href="/" class="hover:text-primary transition-colors">Inicio</a>
        </li>
        <li aria-hidden="true">/</li>
        <li>
          <a href="/productos" class="hover:text-primary transition-colors"
            >Productos</a
          >
        </li>
        {
          product.category && (
            <>
              <li aria-hidden="true">/</li>
              <li>
                <a
                  href={`/categoria/${product.category.slug}`}
                  class="hover:text-primary transition-colors"
                >
                  {product.category.name}
                </a>
              </li>
            </>
          )
        }
        <li aria-hidden="true">/</li>
        <li class="text-foreground truncate max-w-[150px]" aria-current="page">{product.name}</li>
      </ol>
    </nav>

    <div class="lg:grid lg:grid-cols-2 lg:gap-12">
      <!-- Gallery -->
      <div class="mb-8 lg:mb-0">
        <!-- Main Image -->
        <div
          class="relative aspect-square rounded-lg overflow-hidden bg-muted mb-4"
        >
          <CloudinaryImage
            id="main-image"
            src={mainImage}
            alt={product.name}
            width={800}
            sizes="(max-width: 1024px) 100vw, 50vw"
            class="w-full h-full object-cover"
          />

          {
            hasOffer && (
              <Badge
                variant="error"
                class="absolute top-4 left-4 text-lg font-bold"
              >
                -{calculateDiscount(product.price, product.offer_price!)}%
              </Badge>
            )
          }
        </div>

        <!-- Thumbnails -->
        {
          sortedImages.length > 1 && (
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
              {sortedImages.map((img: any, index: number) => (
                <button
                  class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden bg-muted border-2 border-transparent hover:border-primary transition-colors thumbnail-btn"
                  data-image={img.image_url}
                >
                  <img
                    src={getThumbnailUrl(img.image_url)}
                    alt={`${product.name} - imagen ${index + 1}`}
                    class="w-full h-full object-cover"
                  />
                </button>
              ))}
            </div>
          )
        }
      </div>

      <!-- Product Info -->
      <div>
        <h1 class="font-display text-3xl md:text-4xl lg:text-5xl mb-4">
          {product.name}
        </h1>

        <!-- Price -->
        <div class="flex items-center gap-3 mb-6">
          <span
            class:list={[
              "text-3xl font-bold",
              hasOffer ? "text-accent" : "text-foreground",
            ]}
          >
            {formatPrice(displayPrice!)}
          </span>

          {
            hasOffer && (
              <span class="text-xl text-muted-foreground line-through">
                {formatPrice(product.price)}
              </span>
            )
          }
        </div>

        <!-- Description -->
        {
          product.description && (
            <p class="text-muted-foreground mb-8 leading-relaxed">
              {product.description}
            </p>
          )
        }

        <!-- Size Selector + Add to Cart (React Island) -->
        <ProductAddToCart
          client:load
          productId={product.id}
          productName={product.name}
          productSlug={product.slug}
          price={displayPrice!}
          imageUrl={mainImage}
          variants={variantsForReact}
        />

        <!-- Trust Badges -->
        <div class="mt-8 p-4 bg-muted/30 rounded-xl border border-border space-y-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
              <Truck className="w-5 h-5 text-primary" />
            </div>
            <div>
              <p class="text-sm font-medium">Envío gratis +{shippingConfig.freeShippingThreshold}€</p>
              <p class="text-xs text-muted-foreground">Entrega en 3-5 días laborables</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
              <RefreshCw className="w-5 h-5 text-primary" />
            </div>
            <div>
              <p class="text-sm font-medium">{settings.returnWindowDays} días para devoluciones</p>
              <p class="text-xs text-muted-foreground">Devolución gratuita y sin complicaciones</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center flex-shrink-0">
              <ShieldCheck className="w-5 h-5 text-green-500" />
            </div>
            <div>
              <p class="text-sm font-medium">Pago 100% seguro</p>
              <p class="text-xs text-muted-foreground">Encriptación SSL y métodos seguros</p>
            </div>
          </div>
        </div>

        <!-- Product Page Promotion Banner -->
        <div class="mt-6">
          <PromotionBanner
            client:load
            zone="product_page"
            className="rounded-lg aspect-[3/1] max-h-[200px]"
          />
        </div>
      </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="mt-12 border-t border-border pt-8">
      <div class="flex gap-6 border-b border-border mb-6 overflow-x-auto no-scrollbar" role="tablist">
        <button 
          class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-primary text-foreground whitespace-nowrap" 
          data-tab="description"
          role="tab"
          aria-selected="true"
        >
          Descripción
        </button>
        <button 
          class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground whitespace-nowrap transition-colors" 
          data-tab="details"
          role="tab"
          aria-selected="false"
        >
          Detalles
        </button>
        <button 
          class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-muted-foreground hover:text-foreground whitespace-nowrap transition-colors" 
          data-tab="shipping"
          role="tab"
          aria-selected="false"
        >
          Envío y Devoluciones
        </button>
      </div>

      <!-- Tab Content: Description -->
      <div class="tab-content" data-tab-content="description">
        <div class="prose prose-sm dark:prose-invert max-w-none">
          {product.description ? (
            <p class="text-muted-foreground leading-relaxed">{product.description}</p>
          ) : (
            <p class="text-muted-foreground italic">Sin descripción disponible.</p>
          )}
        </div>
      </div>

      <!-- Tab Content: Details -->
      <div class="tab-content hidden" data-tab-content="details">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="p-4 bg-muted/30 rounded-lg">
            <p class="text-xs text-muted-foreground uppercase tracking-wider mb-1">Categoría</p>
            <p class="font-medium">{product.category?.name || 'Sin categoría'}</p>
          </div>
          <div class="p-4 bg-muted/30 rounded-lg">
            <p class="text-xs text-muted-foreground uppercase tracking-wider mb-1">SKU</p>
            <p class="font-medium font-mono text-sm">{product.id.slice(0, 8).toUpperCase()}</p>
          </div>
          <div class="p-4 bg-muted/30 rounded-lg">
            <p class="text-xs text-muted-foreground uppercase tracking-wider mb-1">Tallas Disponibles</p>
            <p class="font-medium">{variantsForReact.filter(v => v.stock > 0).map(v => v.size).join(', ') || 'Agotado'}</p>
          </div>
          <div class="p-4 bg-muted/30 rounded-lg">
            <p class="text-xs text-muted-foreground uppercase tracking-wider mb-1">Estado</p>
            <p class="font-medium">{product.active ? 'Disponible' : 'No disponible'}</p>
          </div>
        </div>
      </div>

      <!-- Tab Content: Shipping -->
      <div class="tab-content hidden" data-tab-content="shipping">
        <div class="space-y-6">
          <div class="admin-card">
            <h4 class="font-heading text-lg mb-3 flex items-center gap-2">
              <Truck className="w-5 h-5 text-primary" />
              Información de Envío
            </h4>
            <ul class="space-y-2 text-sm text-muted-foreground">
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Envío gratis en pedidos superiores a {shippingConfig.freeShippingThreshold}€
              </li>
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Entrega en 3-5 días laborables en España peninsular
              </li>
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Seguimiento del envío en tiempo real
              </li>
            </ul>
          </div>
          <div class="admin-card">
            <h4 class="font-heading text-lg mb-3 flex items-center gap-2">
              <RefreshCw className="w-5 h-5 text-primary" />
              Política de Devoluciones
            </h4>
            <ul class="space-y-2 text-sm text-muted-foreground">
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                {settings.returnWindowDays} días para devolver tu pedido
              </li>
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Devolución gratuita en tienda o por envío
              </li>
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Reembolso en el mismo método de pago
              </li>
              <li class="flex items-start gap-2">
                <span class="text-primary">✓</span>
                Productos sin usar y con etiquetas
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products Carousel -->
    {relatedProducts.length > 0 && (
      <RelatedProductsCarousel client:load products={relatedProducts} />
    )}
  </div>

  <script>
    // Thumbnail click handler
    document.querySelectorAll(".thumbnail-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const mainImg = document.getElementById(
          "main-image"
        ) as HTMLImageElement;
        const newSrc = (btn as HTMLElement).dataset.image;
        if (mainImg && newSrc) {
          mainImg.src = newSrc;
        }

        // Update active state
        document
          .querySelectorAll(".thumbnail-btn")
          .forEach((b) => b.classList.remove("border-primary"));
        btn.classList.add("border-primary");
      });
    });

    // Tab functionality
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const tabName = (btn as HTMLElement).dataset.tab;
        
        // Update tab buttons
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.remove("border-primary", "text-foreground");
          b.classList.add("border-transparent", "text-muted-foreground");
          b.setAttribute("aria-selected", "false");
        });
        btn.classList.add("border-primary", "text-foreground");
        btn.classList.remove("border-transparent", "text-muted-foreground");
        btn.setAttribute("aria-selected", "true");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.add("hidden");
        });
        const activeContent = document.querySelector(`[data-tab-content="${tabName}"]`);
        if (activeContent) {
          activeContent.classList.remove("hidden");
        }
      });
    });
  </script>
</PublicLayout>

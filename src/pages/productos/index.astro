---
import PublicLayout from "@/layouts/PublicLayout.astro";
import ProductCard from "@/components/product/ProductCard.astro";
import ProductFilters from "@/components/islands/ProductFilters";
import { supabase } from "@/lib/supabase";

// Get query params
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get("categoria");
const searchQuery = url.searchParams.get("q");
const minPrice = url.searchParams.get("minPrice");
const maxPrice = url.searchParams.get("maxPrice");
const ofertasFilter = url.searchParams.get("ofertas") === "true";
const sortBy = url.searchParams.get("orden") || "created_at";
const sortOrder = url.searchParams.get("dir") === "asc" ? true : false;

// Build query
let query = supabase
  .from("products")
  .select(
    `
    *,
    category:categories(name, slug),
    images:product_images(image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .is('deleted_at', null)
  .eq("active", true);

// Apply search filter
if (searchQuery) {
  query = query.or(
    `name.ilike.%${searchQuery}%,description.ilike.%${searchQuery}%`
  );
}

// Apply category filter
if (categoryFilter) {
  const { data: cat } = await supabase
    .from("categories")
    .select("id")
    .eq("slug", categoryFilter)
    .single();

  if (cat) {
    query = query.eq("category_id", cat.id);
  }
}

// Apply price filters
if (minPrice) {
  query = query.gte("price", parseFloat(minPrice));
}

if (maxPrice) {
  query = query.lte("price", parseFloat(maxPrice));
}

// Apply offers filter
if (ofertasFilter) {
  query = query.eq("is_offer", true);
}

// Apply sorting
query = query.order(sortBy, { ascending: sortOrder });

const { data: products, error } = await query;

// Get categories for filter
const { data: categories } = await supabase
  .from("categories")
  .select("*")
  .order("name");

// Build page title
let pageTitle = "Todos los Productos";
if (searchQuery) {
  pageTitle = `Resultados para "${searchQuery}"`;
} else if (ofertasFilter) {
  pageTitle = "Ofertas";
} else if (categoryFilter) {
  const category = categories?.find((c) => c.slug === categoryFilter);
  pageTitle = category?.name || "Productos";
}

// Determine initial sort value for component
let initialSort = "created_at";
if (sortBy === "price" && sortOrder) {
  initialSort = "price-asc";
} else if (sortBy === "price" && !sortOrder) {
  initialSort = "price-desc";
} else if (sortBy === "name") {
  initialSort = "name";
}
---

<PublicLayout title={pageTitle}>
  <!-- Breadcrumb -->
  <div class="border-b border-border">
    <div class="container mx-auto px-4 py-3">
      <nav class="text-sm text-muted-foreground">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-primary transition-colors">Inicio</a></li>
          <li>/</li>
          <li class="text-foreground">{pageTitle}</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
      <div>
        <h1 class="font-display text-4xl md:text-5xl mb-2">{pageTitle}</h1>
        <p class="text-muted-foreground">
          {products?.length || 0} productos encontrados
        </p>
      </div>
      
      <!-- Active Filters Summary (if any) -->
      {(categoryFilter || searchQuery || minPrice || maxPrice || ofertasFilter) && (
        <div class="flex flex-wrap items-center gap-2">
          {categoryFilter && (
            <span class="badge badge-primary flex items-center gap-1">
              {categories?.find(c => c.slug === categoryFilter)?.name}
              <a href="/productos" class="hover:text-accent ml-1">×</a>
            </span>
          )}
          {searchQuery && (
            <span class="badge badge-muted flex items-center gap-1">
              "{searchQuery}"
              <a href={`/productos${categoryFilter ? `?categoria=${categoryFilter}` : ''}`} class="hover:text-accent ml-1">×</a>
            </span>
          )}
          {ofertasFilter && (
            <span class="badge badge-danger flex items-center gap-1">
              Ofertas
            </span>
          )}
          {(minPrice || maxPrice) && (
            <span class="badge badge-muted">
              {minPrice && `${minPrice}€`} - {maxPrice && `${maxPrice}€`}
            </span>
          )}
          <a href="/productos" class="text-xs text-muted-foreground hover:text-accent underline">
            Limpiar filtros
          </a>
        </div>
      )}
    </div>

    <div class="lg:flex lg:gap-8">
      <!-- Filters Component - Wrapped in card on desktop -->
      <div class="lg:w-64 xl:w-72 flex-shrink-0 mb-6 lg:mb-0">
        <div class="lg:sticky lg:top-24">
          <ProductFilters
            client:load
            categories={categories || []}
            initialCategory={categoryFilter || ""}
            initialSearch={searchQuery || ""}
            initialMinPrice={minPrice || ""}
            initialMaxPrice={maxPrice || ""}
            initialOffers={ofertasFilter}
            initialSort={initialSort}
          />
        </div>
      </div>

      <!-- Products Grid -->
      <div class="flex-1">
        {
          error ? (
            <div class="admin-card text-center py-12">
              <div class="w-16 h-16 mx-auto mb-4 bg-red-500/10 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <p class="text-muted-foreground mb-4">
                Error al cargar productos. Por favor, intenta de nuevo.
              </p>
              <a href="/productos" class="admin-btn-primary inline-flex">
                Reintentar
              </a>
            </div>
          ) : products && products.length > 0 ? (
            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
              {products.map((product) => (
                <ProductCard product={product} />
              ))}
            </div>
          ) : (
            <div class="admin-card text-center py-16">
              <div class="w-20 h-20 mx-auto mb-6 bg-muted rounded-full flex items-center justify-center">
                <svg
                  class="w-10 h-10 text-muted-foreground"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
              </div>
              <h3 class="font-heading text-xl mb-2">No se encontraron productos</h3>
              <p class="text-muted-foreground mb-6 max-w-sm mx-auto">
                Intenta ajustar los filtros o buscar algo diferente.
              </p>
              <a href="/productos" class="admin-btn-primary inline-flex">
                Ver todos los productos
              </a>
            </div>
          )
        }
      </div>
    </div>
  </div>
</PublicLayout>

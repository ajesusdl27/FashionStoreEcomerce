---
import PublicLayout from "@/layouts/PublicLayout.astro";
import ProductCard from "@/components/product/ProductCard.astro";
import ProductFilters from "@/components/islands/ProductFilters";
import { supabase } from "@/lib/supabase";

// Get query params
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get("categoria");
const searchQuery = url.searchParams.get("q");
const minPrice = url.searchParams.get("minPrice");
const maxPrice = url.searchParams.get("maxPrice");
const ofertasFilter = url.searchParams.get("ofertas") === "true";
const sortBy = url.searchParams.get("orden") || "created_at";
const sortOrder = url.searchParams.get("dir") === "asc" ? true : false;

// Build query
let query = supabase
  .from("products")
  .select(
    `
    *,
    category:categories(name, slug),
    images:product_images(image_url, order),
    variants:product_variants(id, size, stock)
  `
  )
  .eq("active", true);

// Apply search filter
if (searchQuery) {
  query = query.or(
    `name.ilike.%${searchQuery}%,description.ilike.%${searchQuery}%`
  );
}

// Apply category filter
if (categoryFilter) {
  const { data: cat } = await supabase
    .from("categories")
    .select("id")
    .eq("slug", categoryFilter)
    .single();

  if (cat) {
    query = query.eq("category_id", cat.id);
  }
}

// Apply price filters
if (minPrice) {
  query = query.gte("price", parseFloat(minPrice));
}

if (maxPrice) {
  query = query.lte("price", parseFloat(maxPrice));
}

// Apply offers filter
if (ofertasFilter) {
  query = query.eq("is_offer", true);
}

// Apply sorting
query = query.order(sortBy, { ascending: sortOrder });

const { data: products, error } = await query;

// Get categories for filter
const { data: categories } = await supabase
  .from("categories")
  .select("*")
  .order("name");

// Build page title
let pageTitle = "Todos los Productos";
if (searchQuery) {
  pageTitle = `Resultados para "${searchQuery}"`;
} else if (ofertasFilter) {
  pageTitle = "Ofertas";
} else if (categoryFilter) {
  const category = categories?.find((c) => c.slug === categoryFilter);
  pageTitle = category?.name || "Productos";
}

// Determine initial sort value for component
let initialSort = "created_at";
if (sortBy === "price" && sortOrder) {
  initialSort = "price-asc";
} else if (sortBy === "price" && !sortOrder) {
  initialSort = "price-desc";
} else if (sortBy === "name") {
  initialSort = "name";
}
---

<PublicLayout title={pageTitle}>
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="font-display text-4xl md:text-5xl mb-2">{pageTitle}</h1>
      <p class="text-muted-foreground">
        {products?.length || 0} productos encontrados
      </p>
    </div>

    <div class="lg:flex lg:gap-8">
      <!-- Filters Component -->
      <ProductFilters
        client:load
        categories={categories || []}
        initialCategory={categoryFilter || ""}
        initialSearch={searchQuery || ""}
        initialMinPrice={minPrice || ""}
        initialMaxPrice={maxPrice || ""}
        initialOffers={ofertasFilter}
        initialSort={initialSort}
      />

      <!-- Products Grid -->
      <div class="flex-1">
        {
          error ? (
            <div class="text-center py-12">
              <p class="text-muted-foreground">
                Error al cargar productos. Por favor, intenta de nuevo.
              </p>
            </div>
          ) : products && products.length > 0 ? (
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
              {products.map((product) => (
                <ProductCard product={product} />
              ))}
            </div>
          ) : (
            <div class="text-center py-12">
              <div class="w-16 h-16 mx-auto mb-4 bg-muted rounded-full flex items-center justify-center">
                <svg
                  class="w-8 h-8 text-muted-foreground"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
              </div>
              <p class="text-muted-foreground mb-4">
                No se encontraron productos.
              </p>
              <a href="/productos" class="text-primary hover:underline">
                Ver todos los productos
              </a>
            </div>
          )
        }
      </div>
    </div>
  </div>
</PublicLayout>

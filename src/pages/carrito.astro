---
import PublicLayout from "@/layouts/PublicLayout.astro";
import Button from "@/components/ui/Button.astro";
import PromotionBanner from "@/components/ui/PromotionBanner";
import { getShippingConfig } from "@/lib/settings";
import { ShoppingBag, ArrowRight, ShieldCheck, Truck, RefreshCw } from "lucide-react";

// Obtener configuraci√≥n de env√≠o desde la base de datos
const shippingConfig = await getShippingConfig();
---

<PublicLayout title="Carrito de Compra">
  <!-- Pasar configuraci√≥n al cliente de forma segura -->
  <script 
    id="shipping-config" 
    type="application/json"
    set:html={JSON.stringify({
      freeShippingThreshold: shippingConfig.freeShippingThreshold,
      shippingCostEuros: shippingConfig.shippingCostEuros
    })}
  />

  <!-- Breadcrumb -->
  <div class="border-b border-border">
    <div class="container mx-auto px-4 py-3">
      <nav class="text-sm text-muted-foreground">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-primary transition-colors">Inicio</a></li>
          <li>/</li>
          <li class="text-foreground">Carrito</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-8">
      <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
        <ShoppingBag className="w-6 h-6 text-primary" />
      </div>
      <div>
        <h1 class="font-display text-3xl md:text-4xl">Tu Carrito</h1>
        <p id="cart-count" class="text-sm text-muted-foreground">0 productos</p>
      </div>
    </div>

    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
      <!-- Cart Items -->
      <div class="lg:col-span-2 mb-8 lg:mb-0">
        <div id="cart-items" class="space-y-4">
          <!-- Items will be rendered by JavaScript -->
        </div>

        <div
          id="cart-empty"
          class="hidden admin-card text-center py-16"
        >
          <div class="w-20 h-20 mx-auto mb-6 bg-muted rounded-full flex items-center justify-center">
            <ShoppingBag className="w-10 h-10 text-muted-foreground" />
          </div>
          <h2 class="font-heading text-xl mb-2">Tu carrito est√° vac√≠o</h2>
          <p class="text-muted-foreground mb-6 max-w-sm mx-auto">
            ¬°Descubre nuestros productos y a√±ade los que m√°s te gusten!
          </p>
          <a href="/productos" class="admin-btn-primary inline-flex">
            Explorar productos
            <ArrowRight className="w-4 h-4" />
          </a>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="admin-card sticky top-24 space-y-6">
          <h2 class="font-heading text-xl">
            Resumen del Pedido
          </h2>

          <!-- Free Shipping Progress -->
          <div id="shipping-progress" class="p-4 bg-muted/30 rounded-lg border border-border">
            <div class="flex items-center gap-2 mb-2">
              <Truck className="w-4 h-4 text-primary" />
              <p id="shipping-message" class="text-sm font-medium"></p>
            </div>
            <div class="h-2 bg-muted rounded-full overflow-hidden">
              <div
                id="shipping-bar"
                class="h-full bg-primary transition-all duration-500 rounded-full"
                style="width: 0%"
              >
              </div>
            </div>
          </div>

          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-muted-foreground">Subtotal</span>
              <span id="subtotal" class="font-medium">0,00 ‚Ç¨</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted-foreground">Env√≠o</span>
              <span id="shipping">{shippingConfig.shippingCostEuros.toFixed(2).replace('.', ',')} ‚Ç¨</span>
            </div>
            <div class="border-t border-border pt-3 flex justify-between font-bold text-lg">
              <span>Total</span>
              <span id="total" class="text-primary">0,00 ‚Ç¨</span>
            </div>
            <p class="text-xs text-muted-foreground">IVA incluido</p>
          </div>

          <Button
            href="/checkout"
            variant="primary"
            size="lg"
            class="w-full"
            glow={true}
          >
            FINALIZAR COMPRA
            <ArrowRight className="w-4 h-4" />
          </Button>

          <a
            href="/productos"
            class="block text-center text-sm text-muted-foreground hover:text-primary transition-colors"
          >
            ‚Üê Continuar comprando
          </a>

          <!-- Trust Badges -->
          <div class="pt-4 border-t border-border space-y-3">
            <div class="flex items-center gap-2 text-xs text-muted-foreground">
              <ShieldCheck className="w-4 h-4 text-green-500" />
              <span>Pago 100% seguro</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-muted-foreground">
              <Truck className="w-4 h-4 text-primary" />
              <span>Env√≠o gratis +{shippingConfig.freeShippingThreshold}‚Ç¨</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-muted-foreground">
              <RefreshCw className="w-4 h-4 text-primary" />
              <span>30 d√≠as de devoluci√≥n</span>
            </div>
          </div>

          <!-- Promotion Banner for Cart -->
          <div class="pt-2">
            <PromotionBanner
              client:visible
              zone="cart_sidebar"
              className="rounded-lg"
              compact={true}
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import {
      $cart,
      $cartSubtotal,
      removeFromCart,
      updateQuantity,
    } from "@/stores/cart";

    // Leer configuraci√≥n de env√≠o desde el servidor
    const configElement = document.getElementById("shipping-config");
    const shippingConfig = configElement 
      ? JSON.parse(configElement.textContent || '{}')
      : { freeShippingThreshold: 50, shippingCostEuros: 4.99 };
    
    const FREE_SHIPPING_THRESHOLD = shippingConfig.freeShippingThreshold;
    const SHIPPING_COST = shippingConfig.shippingCostEuros;

    function formatPrice(price: number): string {
      return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR",
      }).format(price);
    }

    function renderCart() {
      const items = $cart.get();
      const subtotal = $cartSubtotal.get();
      const itemsContainer = document.getElementById("cart-items");
      const emptyContainer = document.getElementById("cart-empty");

      if (!itemsContainer || !emptyContainer) return;

      if (items.length === 0) {
        itemsContainer.classList.add("hidden");
        emptyContainer.classList.remove("hidden");
        updateSummary(0);
        return;
      }

      itemsContainer.classList.remove("hidden");
      emptyContainer.classList.add("hidden");

      // Update cart count
      const cartCountEl = document.getElementById("cart-count");
      if (cartCountEl) {
        const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
        cartCountEl.textContent = `${totalItems} producto${totalItems !== 1 ? 's' : ''}`;
      }

      itemsContainer.innerHTML = items
        .map(
          (item) => `
        <div class="admin-card flex gap-4 p-4 hover:border-primary/30 transition-all" data-item-id="${item.id}">
          <a href="/productos/${item.productSlug}" class="flex-shrink-0 w-20 h-20 md:w-24 md:h-24 rounded-lg overflow-hidden bg-muted border border-border">
            <img src="${item.imageUrl}" alt="${item.productName}" class="w-full h-full object-cover hover:scale-105 transition-transform">
          </a>
          
          <div class="flex-1 min-w-0">
            <a href="/productos/${item.productSlug}" class="font-medium hover:text-primary transition-colors line-clamp-2">
              ${item.productName}
            </a>
            <p class="text-sm text-muted-foreground mt-1">Talla: <span class="text-foreground font-medium">${item.size}</span></p>
            <p class="font-bold text-lg mt-2">${formatPrice(item.price)}</p>
          </div>
          
          <div class="flex flex-col items-end justify-between">
            <div class="inline-flex items-center border border-border rounded-lg overflow-hidden bg-muted/30">
              <button 
                class="qty-btn decrease w-10 h-10 flex items-center justify-center hover:bg-muted transition-colors touch-target"
                data-action="decrease"
                aria-label="Reducir cantidad"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                </svg>
              </button>
              <span class="w-12 text-center font-bold">${item.quantity}</span>
              <button 
                class="qty-btn increase w-10 h-10 flex items-center justify-center hover:bg-muted transition-colors touch-target"
                data-action="increase"
                aria-label="Aumentar cantidad"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>
            <button class="remove-btn text-xs text-muted-foreground hover:text-accent transition-colors flex items-center gap-1 mt-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Eliminar
            </button>
          </div>
        </div>
      `
        )
        .join("");

      // Add event listeners
      itemsContainer.querySelectorAll("[data-item-id]").forEach((el) => {
        const itemId = el.getAttribute("data-item-id")!;
        const item = items.find((i) => i.id === itemId)!;

        el.querySelector(".decrease")?.addEventListener("click", () => {
          updateQuantity(itemId, item.quantity - 1);
        });

        el.querySelector(".increase")?.addEventListener("click", () => {
          updateQuantity(itemId, item.quantity + 1);
        });

        el.querySelector(".remove-btn")?.addEventListener("click", () => {
          removeFromCart(itemId);
        });
      });

      updateSummary(subtotal);
    }

    function updateSummary(subtotal: number) {
      const isFreeShipping = subtotal >= FREE_SHIPPING_THRESHOLD;
      const shipping = isFreeShipping ? 0 : SHIPPING_COST;
      const total = subtotal + shipping;
      const progress = Math.min(
        (subtotal / FREE_SHIPPING_THRESHOLD) * 100,
        100
      );

      const subtotalEl = document.getElementById("subtotal");
      const shippingEl = document.getElementById("shipping");
      const totalEl = document.getElementById("total");
      const shippingBar = document.getElementById("shipping-bar");
      const shippingMessage = document.getElementById("shipping-message");

      if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
      if (shippingEl) {
        shippingEl.textContent = isFreeShipping
          ? "GRATIS"
          : formatPrice(SHIPPING_COST);
        shippingEl.className = isFreeShipping
          ? "text-emerald-400 font-medium"
          : "";
      }
      if (totalEl) totalEl.textContent = formatPrice(total);
      if (shippingBar) shippingBar.style.width = `${progress}%`;
      if (shippingMessage) {
        if (isFreeShipping) {
          shippingMessage.textContent = "üéâ ¬°Tienes env√≠o GRATIS!";
          shippingMessage.className =
            "text-sm text-emerald-400 font-medium mb-2";
        } else {
          const remaining = FREE_SHIPPING_THRESHOLD - subtotal;
          shippingMessage.textContent = `A√±ade ${formatPrice(remaining)} m√°s para env√≠o GRATIS`;
          shippingMessage.className = "text-sm text-muted-foreground mb-2";
        }
      }
    }

    // Initial render
    renderCart();

    // Subscribe to cart changes
    $cart.subscribe(() => renderCart());
  </script>
</PublicLayout>
